---
phase: 01-core-3d-visualization
plan: 05
type: execute
wave: 3
depends_on: [01-02, 01-03, 01-04]
files_modified: [src/store/ui.ts, src/app/page.tsx, src/components/ui/Overlay.tsx, src/components/viz/MainScene.tsx]
autonomous: false
user_setup: []

must_haves:
  truths:
    - "App displays the 3D scene by default"
    - "User can click toggle to switch between Abstract and Map modes"
    - "User can click Reset to return camera to start"
    - "Data points are visible in the scene"
  artifacts:
    - path: "src/store/ui.ts"
      provides: "View state"
      contains: "useUIStore"
    - path: "src/app/page.tsx"
      provides: "Main entry point"
      contains: "MainScene"
    - path: "src/components/ui/Overlay.tsx"
      provides: "User controls"
      contains: "Button"
  key_links:
    - from: "src/components/ui/Overlay.tsx"
      to: "src/store/ui.ts"
      via: "zustand hook"
      pattern: "setMode"
---

<objective>
Integrate all components, implement the view switching logic, and add UI controls.

Purpose: Deliver the functional Phase 1 requirement of a navigable, toggleable 3D visualization.
Output: The complete integrated page with UI overlay.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-core-3d-visualization/01-RESEARCH.md
@.planning/phases/01-core-3d-visualization/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UI Store</name>
  <files>src/store/ui.ts</files>
  <action>
    Create `src/store/ui.ts` using Zustand.
    - State: `mode` ('abstract' | 'map').
    - Actions: `setMode(mode)`, `toggleMode()`.
  </action>
  <verify>Check store implementation.</verify>
  <done>Global UI state is managed.</done>
</task>

<task type="auto">
  <name>Task 2: Assemble Main Scene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Create `src/components/viz/MainScene.tsx`.
    - Fetch mock data using `generateMockData`.
    - Retrieve `mode` from store.
    - Render `Scene` (from 02).
    - Inside Scene, render `Controls` (from 02), `Grid` (from 02, only if mode === 'abstract'), and `DataPoints` (from 03).
    - If mode === 'map', render `MapBase` (from 04) *behind* the Canvas (using z-index or absolute positioning), OR integrate as discussed. 
    - *Simplification:* Keep Canvas on top transparently if map is present? 
    - *Decision:* For Phase 1, toggle entire views.
      - If 'abstract': Render Canvas with black background.
      - If 'map': Render MapBase with Canvas overlay (transparent background).
      - Pass `transparent={mode === 'map'}` to Scene/Canvas.
  </action>
  <verify>Check conditional rendering logic.</verify>
  <done>MainScene orchestrates the visualization.</done>
</task>

<task type="auto">
  <name>Task 3: Create UI Overlay</name>
  <files>src/components/ui/Overlay.tsx</files>
  <action>
    Create `src/components/ui/Overlay.tsx`.
    - Position absolute (top-right or bottom-center).
    - Add "Reset View" button (triggers CameraControls reset via event or store signal).
      - *Hint:* Use a global event bus or pass a ref through store? Simplest: Use Zustand to trigger a `resetTrigger` counter, and have Controls listen to it. Add `resetVersion` to store.
    - Add "Toggle Map/Grid" button (switches store mode).
    - Use Tailwind for styling (neon borders, dark background).
  </action>
  <verify>Check button hooks.</verify>
  <done>UI controls are ready.</done>
</task>

<task type="auto">
  <name>Task 4: Final Integration</name>
  <files>src/app/page.tsx</files>
  <action>
    Update `src/app/page.tsx`.
    - Render `MainScene` and `Overlay`.
    - Ensure full-screen layout (`h-screen w-screen overflow-hidden`).
  </action>
  <verify>Check page composition.</verify>
  <done>Application entry point is complete.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>The complete Core 3D Visualization (Phase 1)</what-built>
  <how-to-verify>
    1. Run `npm run dev`.
    2. Open browser to localhost.
    3. Verify you see a black screen with a 3D grid and colored points.
    4. Drag to rotate (Orbit). Verify it feels 3D.
    5. Click "Toggle Map". Verify background changes to Chicago map (dark mode).
    6. Click "Reset View". Verify camera smooths back to start.
  </how-to-verify>
  <resume-signal>If all interactions work, type "approved".</resume-signal>
</task>

</tasks>

<verification>
Human verification is the main gate.
</verification>

<success_criteria>
- User can successfully navigate both Abstract and Map modes.
- Toggle works instantly.
- Data points are visible in both modes.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-3d-visualization/01-05-SUMMARY.md`
</output>
