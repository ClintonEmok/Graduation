---
phase: 06-data-backend-loading
plan: 04
type: execute
wave: 2
depends_on: [06-03]
files_modified:
  - src/components/viz/DataPoints.tsx
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Visualization renders points from columnar store data"
    - "Rendering uses efficient buffer attributes (no object loops)"
  artifacts:
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Optimized R3F component"
      contains: "bufferGeometry"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/store/useDataStore.ts"
      via: "realData selector"
---

<objective>
Optimize the 3D visualization component to render millions of points using GPU-efficient methods.

Purpose: Close gap regarding visualization performance and binary data usage.
Output: A `DataPoints` component that consumes `Float32Arrays` directly.
</objective>

<context>
@src/components/viz/DataPoints.tsx
@src/store/useDataStore.ts
</context>

<tasks>
  <task type="auto">
    <name>Implement BufferGeometry Visualization</name>
    <files>src/components/viz/DataPoints.tsx</files>
    <action>
      Refactor `DataPoints.tsx` to handle the new `realData` from store:
      1. Connect to `useDataStore` to retrieve `realData` (columnar).
      2. If `realData` is present, render using `THREE.Points` or `InstancedMesh`:
         - Create `BufferGeometry`.
         - Attach `BufferAttribute` for position (using x, y, z arrays).
         - Attach `BufferAttribute` for color/time.
      3. Maintain backward compatibility with `mockData` (object array) if `realData` is null.
      4. Ensure performant updates (avoid re-creating geometry every frame).
    </action>
    <verify>
      `grep "BufferAttribute" src/components/viz/DataPoints.tsx`
    </verify>
    <done>Visualization renders efficiently from binary store data.</done>
  </task>
</tasks>

<verification>
Load real data and observe smooth rendering of points.
</verification>

<success_criteria>
- [ ] DataPoints component uses BufferAttributes for positions
- [ ] Component handles both Mock (object) and Real (columnar) data sources
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-backend-loading/06-04-SUMMARY.md`
</output>
