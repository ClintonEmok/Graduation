---
phase: 28-slice-boundary-adjustment
plan: 03
type: execute
wave: 3
depends_on: [28-02]
files_modified:
  - src/app/timeline-test/components/SliceToolbar.tsx
  - src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts
  - src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx
  - src/app/timeline-test/lib/slice-adjustment.ts
  - src/app/timeline-test/lib/slice-adjustment.test.ts
  - src/app/timeline-test/page.tsx
autonomous: true
must_haves:
  truths:
    - Snap behavior is enabled by default and can switch between adaptive and fixed preset intervals.
    - While dragging, users can temporarily bypass snap with a modifier and continue constrained free movement.
    - Boundary drag gracefully handles locked/hidden/non-range slices and drag cancellation on scale changes.
  artifacts:
    - path: src/app/timeline-test/components/SliceToolbar.tsx
      provides: Snap mode controls (adaptive/fixed presets) and default-on snap affordance.
    - path: src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts
      provides: Modifier-bypass handling, zoom-change cancellation safety, and integration with snap controls.
    - path: src/app/timeline-test/lib/slice-adjustment.test.ts
      provides: Tests for neighbor snap preference, fixed-preset behavior, and bypass path.
  key_links:
    - from: src/app/timeline-test/components/SliceToolbar.tsx
      to: src/store/useSliceAdjustmentStore.ts
      via: Snap mode and preset actions
      pattern: setSnapEnabled|setSnapMode|setSnapPreset
    - from: src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts
      to: src/app/timeline-test/lib/slice-adjustment.ts
      via: Per-move snap candidate + constraint resolution
      pattern: resolveSnap|adjustBoundary
    - from: src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx
      to: src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts
      via: Tooltip snap status and limit cue rendering
      pattern: Snapped|Free|bypass
---

<objective>
Complete snap controls and edge-case hardening so boundary adjustment remains precise under dense, real-world slice scenarios.

Purpose: Close ADJUST-05/ADJUST-06 end-to-end with stable control surfaces and predictable bypass behavior.
Output: Toolbar snap controls, modifier bypass, hardened drag edge-case handling, and updated tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/28-slice-boundary-adjustment/28-CONTEXT.md
@.planning/phases/28-slice-boundary-adjustment/28-RESEARCH.md
@.planning/phases/28-slice-boundary-adjustment/28-02-SUMMARY.md
@src/app/timeline-test/components/SliceToolbar.tsx
@src/app/timeline-test/lib/slice-adjustment.ts
@src/store/useSliceStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snap controls for adaptive and fixed preset intervals</name>
  <files>src/app/timeline-test/components/SliceToolbar.tsx, src/app/timeline-test/page.tsx</files>
  <action>Extend the timeline-test toolbar with boundary-adjustment snap controls wired to `useSliceAdjustmentStore`: snap enabled toggle (default on), mode selector (`adaptive` vs fixed), and compact fixed presets (`1m`, `5m`, `15m`, `1h`, `1d`). Keep control density low-noise and consistent with current toolbar styling; avoid introducing panel-heavy UI.</action>
  <verify>npm run lint -- src/app/timeline-test/components/SliceToolbar.tsx src/app/timeline-test/page.tsx</verify>
  <done>Users can switch between adaptive and fixed snapping without leaving timeline-test, with snap enabled by default.</done>
</task>

<task type="auto">
  <name>Task 2: Implement modifier-based snap bypass and drag hardening</name>
  <files>src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts, src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx</files>
  <action>Implement temporary snap bypass during drag using `Alt/Option` modifier (while preserving constraints), and update tooltip status to communicate `Snapped`, `Free`, or `Snap bypass`. Harden drag flow for edge cases: skip handles for hidden/locked/non-range slices, cancel active drag on timeline scale-domain change to avoid jump artifacts, and ensure pointer handlers block underlying scrub/zoom interactions.</action>
  <verify>npm run lint -- src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx</verify>
  <done>Holding modifier key disables snapping for the current movement step, and drag remains stable across locked/hidden/zoom-change edge cases.</done>
</task>

<task type="auto">
  <name>Task 3: Expand adjustment tests for snap options and edge-case determinism</name>
  <files>src/app/timeline-test/lib/slice-adjustment.ts, src/app/timeline-test/lib/slice-adjustment.test.ts</files>
  <action>Extend math tests to cover fixed-preset selection precedence, neighbor-boundary preference under ties, and bypass/no-snap paths while still enforcing min duration and domain hard stops. Add assertions that candidate resolution remains deterministic with dense overlapping candidates and that outputs stay conversion-stable for normalized ranges.</action>
  <verify>npm run test -- src/app/timeline-test/lib/slice-adjustment.test.ts</verify>
  <done>Snap options and edge-case adjustment outcomes are reproducible and validated by automated tests, closing ADJUST-06 behavior gaps.</done>
</task>

</tasks>

<verification>
Run: `npm run test -- src/app/timeline-test/lib/slice-adjustment.test.ts`
Run: `npm run lint -- src/app/timeline-test/components/SliceToolbar.tsx src/app/timeline-test/hooks/useSliceBoundaryAdjustment.ts src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx src/app/timeline-test/lib/slice-adjustment.ts src/app/timeline-test/lib/slice-adjustment.test.ts src/app/timeline-test/page.tsx`
Manual check in `/timeline-test`: verify adaptive snap, fixed presets, and Alt/Option bypass during start/end drag with visible status feedback.
</verification>

<success_criteria>
Boundary adjustment is precision-first and resilient: snap defaults, snap controls, bypass behavior, and edge-case constraints all work predictably for start/end handle drags.
</success_criteria>

<output>
After completion, create `.planning/phases/28-slice-boundary-adjustment/28-03-SUMMARY.md`
</output>
