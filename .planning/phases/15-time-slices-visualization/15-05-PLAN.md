---
phase: 15-time-slices-visualization
plan: 05
type: execute
wave: 2
depends_on: ["15-04"]
files_modified:
  - src/components/viz/SlicePlane.tsx
  - src/components/viz/DataPoints.tsx
  - src/components/viz/shaders/ghosting.ts
autonomous: true
must_haves:
  truths:
    - "Range slices render as translucent 3D boxes/slabs"
    - "Points within slice ranges are highlighted"
    - "Shader receives slice ranges correctly"
  artifacts:
    - path: "src/components/viz/SlicePlane.tsx"
      provides: "Range visualization"
    - path: "src/components/viz/shaders/ghosting.ts"
      contains: "Range check logic"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/components/viz/shaders/ghosting.ts"
      via: "uniform injection"
---

<objective>
Implement 3D Visualization and Shader logic for Range Slices.
Purpose: Allow users to visualize and filter data using time intervals (slabs).
Output: Updated WebGL rendering to support range slices.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-time-slices-visualization/15-04-SUMMARY.md
@src/components/viz/SlicePlane.tsx
@src/components/viz/DataPoints.tsx
@src/components/viz/shaders/ghosting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Shader Logic</name>
  <files>src/components/viz/shaders/ghosting.ts</files>
  <action>
    Update `applyGhostingShader`:
    - Change `uSlices` (float array) to `uSliceRanges` (vec2 array) or two float arrays (`uSliceStarts`, `uSliceEnds`).
    - Recommendation: Use `uniform vec2 uSliceRanges[20]`.
    - Update logic:
      - Iterate through active slices.
      - Check `vLinearY >= range.x && vLinearY <= range.y`.
      - Remove `uSliceThreshold` dependency for ranges (implicit in start/end).
  </action>
  <verify>
    Check shader syntax logic.
  </verify>
  <done>
    Shader supports range highlighting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DataPoints Uniform Injection</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Update `useFrame` loop in `DataPoints.tsx`:
    - Map `activeSlices` to the new uniform format.
    - If type is 'point': `range = [time - threshold, time + threshold]`.
    - If type is 'range': `range = [range[0], range[1]]`.
    - Inject into `uSliceRanges`.
  </action>
  <verify>
    Verify TypeScripts checks pass.
  </verify>
  <done>
    DataPoints passes correct ranges to shader.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update 3D Slice Visualization</name>
  <files>src/components/viz/SlicePlane.tsx</files>
  <action>
    Update `SlicePlane` component:
    - Check `slice.type`.
    - If 'point': Render existing Plane geometry.
    - If 'range': Render `boxGeometry`.
      - Calculate height: `scale(slice.range[1]) - scale(slice.range[0])`.
      - Calculate center Y: `(scale(slice.range[1]) + scale(slice.range[0])) / 2`.
      - Update drag logic? (Maybe disable dragging for ranges initially, or implement resize handles. For this plan, simplistic rendering is fine, maybe simple center drag).
  </action>
  <verify>
    Verify code compiles.
  </verify>
  <done>
    Range slices appear as 3D boxes.
  </done>
</task>

</tasks>

<verification>
Add a range slice and verify:
1. It appears as a slab in 3D.
2. Points inside it are highlighted.
</verification>

<success_criteria>
1. Range slices function visually (highlighting).
2. Range slices function spatially (slab geometry).
</success_criteria>

<output>
After completion, create `.planning/phases/15-time-slices-visualization/15-05-SUMMARY.md`
</output>
