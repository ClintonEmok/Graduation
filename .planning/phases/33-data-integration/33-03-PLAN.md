---
phase: 33-data-integration
plan: 03
type: execute
wave: 3
depends_on:
  - 33-02
files_modified:
  - src/store/useDataStore.ts
  - src/store/useTimeStore.ts
  - src/store/useFilterStore.ts
autonomous: true

must_haves:
  truths:
    - "Timeline displays 2001-2026 date range (real data)"
    - "Filter presets (0-100 normalized) map to real dates"
    - "Density visualization uses real aggregated counts"
    - "Data store reflects real data metadata"
  artifacts:
    - path: "src/store/useDataStore.ts"
      provides: "Data state with real metadata"
      changes: "Update minTime/maxTime from real API, add isMock flag"
    - path: "src/store/useTimeStore.ts"
      provides: "Time range state"
      changes: "Update default range for 2001-2026"
    - path: "src/store/useFilterStore.ts"
      provides: "Filter presets"
      changes: "Add date range mapping for presets"
  key_links:
    - from: "Timeline components"
      to: "useDataStore"
      via: "Real metadata from /api/crime/meta"
      pattern: "minTime.*maxTime.*count"
---

<objective>
Wire timeline and data stores to use real date ranges from the API.

Purpose: Replace mock time range (2024) with real data range (2001-2026). Update filter preset mapping.
Output: Timeline shows real dates, density uses real aggregated data.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/33-data-integration/33-CONTEXT.md
@src/store/useDataStore.ts
@src/store/useTimeStore.ts
@src/store/useFilterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update data store with real metadata</name>
  <files>src/store/useDataStore.ts</files>
  <action>
Update useDataStore to handle real data:

1. Fetch metadata from /api/crime/meta on app initialization
2. Store minTime, maxTime from API response (real epoch seconds)
3. Store isMock flag from API response
4. Use real count for display (e.g., "8.5M crimes")
5. Handle error case: if fetch fails, use mock metadata

The store should:
- Call /api/crime/meta in useEffect on mount
- Update state with real values
- Set a loading state while fetching
- Preserve fallback to mock if endpoint fails

Example response handling:
```typescript
const response = await fetch('/api/crime/meta');
const data = await response.json();
if (data.isMock) {
  console.warn('Using demo data');
}
setMetadata({
  minTime: data.minTime,
  maxTime: data.maxTime,
  count: data.count,
  isMock: data.isMock
});
```
</action>
  <verify>
Load app and check console for metadata: "minTime: X, maxTime: Y, count: Z"
</verify>
  <done>Data store fetches and stores real metadata from API</done>
</task>

<task type="auto">
<name>Task 2: Update time store for real date range</name>
  <files>src/store/useTimeStore.ts</files>
  <action>
Update useTimeStore to use real date range:

1. Import minTime/maxTime from useDataStore
2. Set default time range to full real range (2001-2026)
3. Update time scale domain to use real epoch seconds
4. Ensure timeline axis renders with real dates (2001, 2005, 2010, 2015, 2020, 2025)

The store should initialize with full range from data store.
If data store hasn't loaded yet, use sensible defaults that won't break rendering.

Note: Timeline axis formatting should show years (2001-2026) not normalized 0-100.
</action>
  <verify>
Timeline axis shows years 2001, 2005, 2010, 2015, 2020, 2025
</verify>
  <done>Time store uses real date range for timeline</done>
</task>

<task type="auto">
<name>Task 3: Update filter preset mapping</name>
<files>src/store/useFilterStore.ts</files>
<action>
Update filter presets to map normalized values to real dates:

1. Get real minTime/maxTime from data store
2. Presets currently use 0-100 normalized range
3. Map normalized filter values to real epoch seconds:
   - normalizedValue / 100 = (realTime - minTime) / (maxTime - minTime)
   - realTime = minTime + (normalizedValue / 100) * (maxTime - minTime)
4. Update any time-based filter logic to use real epoch seconds

This applies to:
- Date range filters
- Any "last N%" of data presets
- Density calculation time windows

Example mapping:
```typescript
const normalizeToReal = (normalized: number): number => {
  const { minTime, maxTime } = useDataStore.getState();
  return minTime + (normalized / 100) * (maxTime - minTime);
};

const realToNormalized = (real: number): number => {
  const { minTime, maxTime } = useDataStore.getState();
  return ((real - minTime) / (maxTime - minTime)) * 100;
};
```
</action>
  <verify>
Filter "last 25%" should show recent years (2020-2026), not 2022-2024
</verify>
  <done>Filter presets correctly map to real date ranges</done>
</task>

</tasks>

<verification>
- [ ] Timeline axis shows years 2001-2026
- [ ] Data count shows ~8.5M crimes
- [ ] Filter presets map to correct date ranges
- [ ] App loads without errors when CSV is present
- [ ] App shows warning banner when using demo data (CSV missing)
</verification>

<success_criteria>
Timeline displays 2001-2026 date range with real crime data. Filter presets correctly map to real dates. Density visualization uses aggregated data from real CSV.
</success_criteria>

<output>
After completion, create `.planning/phases/33-data-integration/33-03-SUMMARY.md`
</output>
