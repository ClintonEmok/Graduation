---
phase: 33-data-integration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/crime/stream/route.ts
autonomous: true
gap_closure: true
---

<objective>
Fix: Stream API times out when loading all 8.3M records. Add LIMIT/sampling for visualization.

Gap from UAT: API times out when trying to load all 8.3M records
Severity: blocker
</objective>

<context>
@.planning/phases/33-data-integration/33-UAT.md
@src/app/api/crime/stream/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LIMIT to stream query</name>
  <files>src/app/api/crime/stream/route.ts</files>
  <action>
    In stream/route.ts, add a LIMIT clause to prevent loading all records at once.
    
    The query at line 71-88 should include a LIMIT:
    - Use LIMIT 50000 (50k records) as a reasonable sample for visualization
    - Add TABLESAMPLE BERNOULLI(1) for random sampling if needed for larger datasets
    
    Example fix:
    ```sql
    FROM read_csv_auto('${dataPath}')
    WHERE "Date" IS NOT NULL 
      AND "Latitude" IS NOT NULL 
      AND "Longitude" IS NOT NULL
      ${dateFilter}
      ${typeFilter}
    LIMIT 50000
    ```
    
    Also add a comment explaining the limit is for visualization performance.
  </action>
  <verify>
    Run curl http://localhost:3005/api/crime/stream - should return within 30 seconds
  </verify>
  <done>
    Stream API returns data within 30 seconds instead of timing out
  </done>
</task>

</tasks>

<verification>
After completing the task, verify the stream API responds within a reasonable time.
</verification>

<success_criteria>
Stream API returns data sample (50k records) instead of timing out.
</success_criteria>

<output>
After completion, create `.planning/phases/33-data-integration/33-05-SUMMARY.md`
</output>
