---
phase: 33-data-integration
plan: 02
type: execute
wave: 2
depends_on:
  - 33-01
files_modified:
  - src/app/api/crime/stream/route.ts
  - src/app/api/crime/meta/route.ts
  - src/app/api/crime/bins/route.ts
autonomous: true

must_haves:
  truths:
    - "API endpoints gracefully handle DuckDB failures"
    - "Failed queries return mock data with warning flag"
    - "Client can distinguish real vs mock data"
    - "Query performance is acceptable (~1-2s)"
  artifacts:
    - path: "src/app/api/crime/stream/route.ts"
      provides: "Crime stream with fallback"
      changes: "Add try/catch with mock data return + warning flag"
    - path: "src/app/api/crime/meta/route.ts"
      provides: "Metadata with fallback"
      changes: "Add try/catch with mock metadata return + warning flag"
    - path: "src/app/api/crime/bins/route.ts"
      provides: "Aggregated bins with fallback"
      changes: "Add query support for full CSV"
  key_links:
    - from: "API routes"
      to: "mock data"
      via: "try/catch fallback"
      pattern: "catch.*mock"
---

<objective>
Add error handling with mock data fallback to all crime API endpoints.

Purpose: If DuckDB fails (file not found, query error), the app should still work with demo data and warn the user.
Output: All crime API routes have graceful degradation.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/33-data-integration/33-CONTEXT.md
@src/app/api/crime/stream/route.ts
@src/app/api/crime/meta/route.ts
@src/app/api/crime/bins/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mock fallback to stream route</name>
  <files>src/app/api/crime/stream/route.ts</files>
  <action>
Add error handling with mock data fallback to /api/crime/stream:

1. Wrap DuckDB query in try/catch
2. On error: Log error to console, return mock data
3. Add warning header: X-Data-Warning: Using demo data
4. Include isMock: true in response body

Mock data format: Return same Arrow IPC format with ~1000 mock crime records covering 2024.
Include same columns: timestamp, type, lat, lon, x, z, iucr, district, year
</action>
  <verify>
Test by temporarily renaming CSV - endpoint should still return mock data with warning
</verify>
  <done>Stream endpoint returns mock data with warning when DuckDB fails</done>
</task>

<task type="auto">
  <name>Task 2: Add mock fallback to meta route</name>
  <files>src/app/api/crime/meta/route.ts</files>
  <action>
Add error handling with mock data fallback to /api/crime/meta:

1. Wrap DuckDB query in try/catch
2. On error: Return mock metadata
3. Mock metadata: minTime: 1704067200 (2024-01-01), maxTime: 1735689600 (2025-01-01), count: 100000
4. Include isMock: true in response
5. Add X-Data-Warning header

Also handle case where CSV exists but query fails (malformed data, etc.)
</action>
  <verify>
Test by temporarily renaming CSV - endpoint should return mock metadata with isMock: true
</verify>
  <done>Meta endpoint returns mock metadata with warning when DuckDB fails</done>
</task>

<task type="auto">
  <name>Task 3: Update bins route for CSV</name>
  <files>src/app/api/crime/bins/route.ts</files>
  <action>
Update /api/crime/bins to query full CSV:

1. Read current bins route implementation
2. Update to use CSV query instead of parquet
3. Add same date parsing and coordinate filtering as stream route
4. Support time range filtering (startDate, endDate query params)
5. Return aggregated counts per spatial bin

Note: Bins route is used for density visualization - this is the key endpoint for timeline density.
Query should aggregate: SELECT bin_x, bin_y, COUNT(*) as count GROUP BY bin_x, bin_y
</action>
  <verify>
Test bins endpoint with time range params: curl "?startDate=1704067200&endDate=1735689600"
</verify>
  <done>Bins endpoint returns aggregated crime counts from full CSV</done>
</task>

</tasks>

<verification>
- [ ] GET /api/crime/stream returns data (real or mock)
- [ ] GET /api/crime/meta returns metadata (real or mock)
- [ ] GET /api/crime/bins returns aggregated counts
- [ ] When CSV missing: isMock: true in response, X-Data-Warning header present
- [ ] Query with date range filters works correctly
</verification>

<success_criteria>
All crime API endpoints work (return real data when CSV available, mock when not). Error handling is graceful with user-visible warning.
</success_criteria>

<output>
After completion, create `.planning/phases/33-data-integration/33-02-SUMMARY.md`
</output>
