---
phase: 26-timeline-density-visualization
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useDebouncedDensity.ts
  - src/components/timeline/TimelinePanel.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Filter changes in the production timeline trigger debounced density recomputation"
    - "Recompute behavior uses a 400ms debounce boundary instead of per-keystroke recomputation"
    - "Production timeline exposes computing state from the same hook path as test harness"
  artifacts:
    - path: "src/hooks/useDebouncedDensity.ts"
      provides: "Single reusable debounced filter-to-computeMaps integration for production and test"
      exports: ["useDebouncedDensity"]
    - path: "src/components/timeline/TimelinePanel.tsx"
      provides: "Production mount point for debounced density recomputation"
      modifies: true
  key_links:
    - from: "src/hooks/useDebouncedDensity.ts"
      to: "useAdaptiveStore.computeMaps"
      via: "debounced trigger"
      pattern: "debounce\\(.*compute"
    - from: "src/components/timeline/TimelinePanel.tsx"
      to: "src/hooks/useDebouncedDensity.ts"
      via: "hook mount in production tree"
      pattern: "useDebouncedDensity"
---

<objective>
Close the production wiring gap for DENS-03 by mounting debounced density recomputation in the real timeline component tree.

Purpose: Verification failed because `useDebouncedDensity` only ran in `/timeline-test`; production interactions did not reliably trigger debounced recomputation.
Output: Timeline production path uses the same 400ms filter-driven recomputation behavior as the test harness.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-timeline-density-visualization/26-VERIFICATION.md
@.planning/phases/26-timeline-density-visualization/26-03-SUMMARY.md
@src/hooks/useDebouncedDensity.ts
@src/components/timeline/TimelinePanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden debounced hook for shared production usage</name>
  <files>src/hooks/useDebouncedDensity.ts</files>
  <action>Keep the debounce contract at 400ms, then tighten hook behavior for always-on production mounting: ensure cleanup cancellation remains explicit, filter signature changes are the trigger source, and the hook can be mounted without requiring test-route-only assumptions. Preserve existing API (`isComputing`, `triggerUpdate`) so downstream consumers do not break.</action>
  <verify>Run `npm run lint -- src/hooks/useDebouncedDensity.ts` and `npm run build`.</verify>
  <done>Hook remains 400ms debounced, compiles in production build, and is safe to mount in the timeline panel lifecycle.</done>
</task>

<task type="auto">
  <name>Task 2: Mount debounced recompute in production timeline tree</name>
  <files>src/components/timeline/TimelinePanel.tsx</files>
  <action>Import and mount `useDebouncedDensity` inside `TimelinePanel` so the production timeline path subscribes to filter changes and drives adaptive recomputation. Keep this mount in the top-level panel component (not nested transient subtrees) so it stays active whenever the timeline is present. Do not duplicate debounce logic locally; use the hook as the single source of truth.</action>
  <verify>Run `npm run lint -- src/components/timeline/TimelinePanel.tsx` and `npm run build`.</verify>
  <done>Production timeline flow mounts `useDebouncedDensity`, and filter changes can trigger debounced `computeMaps` without relying on `/timeline-test`.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with production hook wiring.
- Timeline panel contains an explicit `useDebouncedDensity` mount.
- Hook still debounces recomputation at 400ms and cancels pending calls on cleanup.
</verification>

<success_criteria>
- DENS-03 production-flow gap is closed: filter changes in real timeline trigger debounced recomputation.
- No duplicate debounce implementations are introduced outside `useDebouncedDensity`.
- Existing timeline behavior remains stable under build/lint checks.
</success_criteria>

<output>
After completion, create `.planning/phases/26-timeline-density-visualization/26-04-SUMMARY.md`
</output>
