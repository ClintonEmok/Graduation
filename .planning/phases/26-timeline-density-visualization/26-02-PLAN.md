---
phase: 26-timeline-density-visualization
plan: 02
type: execute
wave: 2
depends_on: ['26-01']
files_modified:
  - src/components/timeline/DensityHeatStrip.tsx
  - src/components/timeline/TimelineContainer.tsx
  - src/components/timeline/DualTimeline.tsx
autonomous: true

must_haves:
  truths:
    - DensityHeatStrip renders compact density visualization
    - Heat strip uses Canvas API with blue→red color scheme
    - Heat strip positioned above timeline as separate track
    - Both overview and detail views show density visualization
    - Heat strip syncs with brush/zoom interactions
    - Height is 12-16px for space efficiency
  artifacts:
    - path: "src/components/timeline/DensityHeatStrip.tsx"
      provides: "Enhanced heat strip component"
      min_lines: 80
      exports: ["DensityHeatStrip"]
    - path: "src/components/timeline/TimelineContainer.tsx"
      provides: "Timeline with density track integration"
      min_lines: 150
      exports: ["TimelineContainer"]
    - path: "src/components/timeline/DualTimeline.tsx"
      provides: "Dual timeline with density strips"
      modifies: true
  key_links:
    - from: "DualTimeline"
      to: "DensityHeatStrip"
      via: "Component composition"
      pattern: "<DensityHeatStrip"
    - from: "DensityHeatStrip"
      to: "useAdaptiveStore"
      via: "Zustand store access"
      pattern: "useAdaptiveStore.*densityMap"
    - from: "DensityHeatStrip"
      to: "Canvas API"
      via: "2D context rendering"
      pattern: "getContext.*2d"
---

<objective>
Build enhanced heat strip component and integrate density visualization with the timeline.

Purpose: Create compact Canvas-based heat strip that shows density with color encoding (blue→red), integrate it above the timeline as a separate track, and ensure synchronization with brush and zoom interactions across both overview and detail views.
Output: Enhanced DensityHeatStrip component integrated into DualTimeline with proper positioning and sync.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/26-timeline-density-visualization/26-CONTEXT.md
@.planning/phases/26-timeline-density-visualization/26-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/phases/26-timeline-density-visualization/26-01-SUMMARY.md
@/Users/clintonemok/.local/share/opencode/worktree/d0fbfb0ff8df08417c3b1ad31fe4adc5da685c10/quiet-tiger/src/components/timeline/DensityTrack.tsx
@/Users/clintonemok/.local/share/opencode/worktree/d0fbfb0ff8df08417c3b1ad31fe4adc5da685c10/quiet-tiger/src/components/timeline/DualTimeline.tsx
@/Users/clintonemok/.local/share/opencode/worktree/d0fbfb0ff8df08417c3b1ad31fe4adc5da685c10/quiet-tiger/src/components/timeline/TimelineContainer.tsx
@/Users/clintonemok/.local/share/opencode/worktree/d0fbfb0ff8df08417c3b1ad31fe4adc5da685c10/quiet-tiger/src/store/useAdaptiveStore.ts
</context>

<tasks>

<task type="auto">
  <name>Create enhanced DensityHeatStrip component</name>
  <files>src/components/timeline/DensityHeatStrip.tsx</files>
  <action>
    Create an enhanced DensityHeatStrip component based on existing DensityTrack.tsx but with improvements from RESEARCH.md.
    
    **Requirements from RESEARCH.md:**
    - Use Canvas API (not SVG) for performance
    - Height: 12-16px (recommend 12px to match existing)
    - Color scheme: Sequential blue→red
      - Low density (compressed): Blue #3b82f6 (59, 130, 246)
      - High density (expanded): Red #ef4444 (239, 68, 68)
    - Handle devicePixelRatio for retina displays
    - Zero/null handling: minimum opacity line
    - Use Float32Array densityMap from useAdaptiveStore
    
    **Interface:**
    ```typescript
    interface DensityHeatStripProps {
      densityMap: Float32Array | null;
      width: number;
      height?: number; // default 12
      colorLow?: [number, number, number];  // RGB, default blue
      colorHigh?: [number, number, number]; // RGB, default red
    }
    ```
    
    **Implementation details:**
    - Use useRef for canvas element
    - Use useEffect for rendering when densityMap/width/height change
    - Handle devicePixelRatio scaling:
      ```
      const dpr = window.devicePixelRatio || 1;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      ctx.scale(dpr, dpr);
      ```
    - Create single-row ImageData, then stretch vertically
    - Interpolate colors based on normalized density values
    - Apply rounded corners via CSS (rounded-sm or rounded)
    - Add opacity-80 or similar for subtle appearance
    
    **Improvements over existing DensityTrack:**
    - Proper TypeScript interfaces
    - Configurable colors via props
    - Better retina display support
    - More robust null/empty state handling
    - Consistent with RESEARCH.md patterns
    
    **Note:** This will eventually replace DensityTrack.tsx, but keep both for now.
  </action>
  <verify>
    Component compiles without TypeScript errors.
    Run: `npx tsc --noEmit src/components/timeline/DensityHeatStrip.tsx 2>&1 | head -20`
    
    Verify interface exports correctly:
    Run: `grep -E "export (interface|function|const)" src/components/timeline/DensityHeatStrip.tsx`
  </verify>
  <done>
    - DensityHeatStrip component exists and exports correctly
    - Uses Canvas API with proper dpr handling
    - Implements blue→red color interpolation
    - Has TypeScript interfaces
    - Default height 12px
  </done>
</task>

<task type="auto">
  <name>Integrate density track into DualTimeline</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>
    Integrate DensityHeatStrip into the DualTimeline component above both overview and detail sections.
    
    **Current structure in DualTimeline.tsx:**
    - Overview section (42px histogram + axis)
    - Detail section (60px points + axis)
    - Gap between them (gap-6 = 24px)
    
    **Integration plan:**
    Add density visualization as a separate track ABOVE the timeline sections:
    
    ```tsx
    <div className="flex flex-col gap-6">
      {/* Density track - full width above both timelines */}
      <div className="w-full">
        <DensityHeatStrip 
          densityMap={densityMap} 
          width={width} 
          height={12}
        />
      </div>
      
      {/* Overview section */}
      <svg ref={overviewSvgRef} ...>
        ...
      </svg>
      
      {/* Detail section */}
      <svg ref={detailSvgRef} ...>
        ...
      </svg>
    </div>
    ```
    
    **Implementation steps:**
    1. Import DensityHeatStrip at top of file
    2. Get densityMap from useAdaptiveStore: `const densityMap = useAdaptiveStore((s) => s.densityMap);`
    3. Add density track container before overview SVG
    4. Ensure width matches timeline width (same bounds from useMeasure)
    
    **Alternative: Separate tracks for overview and detail**
    If research suggests separate density tracks for each view:
    - Add small heat strip (8-10px) above overview
    - Add area chart or larger heat strip above detail
    
    **From RESEARCH.md:** 
    - "Show heat strip always (compact), add area chart on hover/expand"
    - But for now, let's keep it simple: single heat strip above both
    
    **Sync considerations:**
    - Density shows FULL time range always (as per RESEARCH.md)
    - Brush overlay on timeline shows selection sub-range
    - This provides context of where selection sits in overall density
    - No need to filter density data - it always shows the full dataset
    
    **Layout adjustments:**
    - Add margin-bottom to density track for spacing
    - Ensure density track doesn't increase overall height too much
    - Current: 42 + 28 + 60 + 28 = 158px
    - With density: +12px + gap = ~180px total
  </action>
  <verify>
    Component compiles without TypeScript errors.
    Run: `npx tsc --noEmit src/components/timeline/DualTimeline.tsx 2>&1 | head -20`
    
    Verify imports added:
    Run: `grep -E "import.*DensityHeatStrip|import.*useAdaptiveStore" src/components/timeline/DualTimeline.tsx`
  </verify>
  <done>
    - DensityHeatStrip imported in DualTimeline
    - Density track renders above timeline sections
    - Uses densityMap from useAdaptiveStore
    - Width matches timeline container
    - Height is 12px as specified
    - Visual spacing appropriate (gap-6 maintained)
  </done>
</task>

<task type="auto">
  <name>Update test route with integrated timeline</name>
  <files>src/app/timeline-test/page.tsx</files>
  <action>
    Update the test route to demonstrate the integrated density visualization.
    
    **Update page to show:**
    1. **Standalone DensityAreaChart** (from Plan 01)
    2. **Standalone DensityHeatStrip** (from this plan)
    3. **Integrated DualTimeline with density** (combined view)
    
    **Structure:**
    ```tsx
    export default function TimelineTestPage() {
       return (
         <div className="p-8 space-y-8">
           <h1>Timeline Density Visualization Test</h1>
           
           {/* Section 1: Area Chart Component */}
           <section>
             <h2>1. Density Area Chart (Detail View)</h2>
             <DensityAreaChart data={sampleData} width={containerWidth} />
           </section>
           
           {/* Section 2: Heat Strip Component */}
           <section>
             <h2>2. Density Heat Strip (Overview)</h2>
             <DensityHeatStrip 
               densityMap={densityMap || mockDensityMap} 
               width={containerWidth} 
             />
           </section>
           
           {/* Section 3: Integrated Timeline */}
           <section>
             <h2>3. Dual Timeline with Density</h2>
             <DualTimeline />
           </section>
           
           {/* Info / Controls */}
           <section>
             <p>Testing density visualization components...</p>
           </section>
         </div>
       );
    }
    ```
    
    **Add controls for testing:**
    - Simple button to regenerate mock density data
    - Display current densityMap stats (min, max, length)
    - Show isComputing state from useAdaptiveStore
    
    **Import both components:**
    - DensityAreaChart from Plan 01
    - DensityHeatStrip from this plan
    - DualTimeline (integrated version)
  </action>
  <verify>
    Page compiles and renders all three sections.
    Visit: http://localhost:3000/timeline-test
    Verify: All three sections visible - Area Chart, Heat Strip, Integrated Timeline
  </verify>
  <done>
    - Test route shows three sections
    - Area chart renders correctly
    - Heat strip renders correctly
    - Integrated DualTimeline shows density track above timeline
    - No console errors
    - Density visualization visible and distinct from timeline elements
  </done>
</task>

</tasks>

<verification>
[ ] DensityHeatStrip component exists with proper Canvas rendering
[ ] Heat strip shows blue→red color gradient based on density values
[ ] Heat strip height is 12px and positioned correctly
[ ] DualTimeline integrates density track above overview/detail
[ ] Density visualization syncs with brush (shows full range, brush shows selection)
[ ] Test route displays all three visualization modes
[ ] High-density areas are visually distinct (red) from low-density (blue)
[ ] Canvas handles devicePixelRatio for crisp rendering
</verification>

<success_criteria>
1. **DENS-01:** Timeline renders event density as clear visual regions - Heat strip provides compact density visualization
2. **DENS-02:** High-density areas visually distinct from low-density - Blue→red color scheme makes distinction clear
3. **DENS-04 (Partial):** Density scale is consistent - Fixed color mapping across full dataset
4. Density track properly positioned above timeline
5. Both overview and detail views have density context
</success_criteria>

<output>
After completion, create `.planning/phases/26-timeline-density-visualization/26-02-SUMMARY.md`

Include:
- Integration notes for DualTimeline
- Canvas rendering approach details
- Color interpolation formula used
- Positioning strategy (above timeline)
- Any sync issues encountered and resolved
</output>
