---
phase: 26-timeline-density-visualization
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/timeline/DensityHeatStrip.tsx
  - src/components/timeline/DualTimeline.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Both overview and detail panes visibly render density information"
    - "Heat strip displays brush/zoom-linked selection context"
    - "Density colors keep a stable meaning across recomputations"
    - "Density scale contract is visible/readable in the UI"
  artifacts:
    - path: "src/components/timeline/DensityHeatStrip.tsx"
      provides: "Heat strip with explicit scale domain contract"
      modifies: true
    - path: "src/components/timeline/DualTimeline.tsx"
      provides: "Overview/detail density rendering plus brush-linked strip highlight"
      modifies: true
  key_links:
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "src/components/timeline/DensityHeatStrip.tsx"
      via: "shared stable density scale props"
      pattern: "DensityHeatStrip.*(domain|scale|legend)"
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "brush/zoom detail domain"
      via: "selection overlay state"
      pattern: "detailRangeSec"
---

<objective>
Close the remaining density visualization gaps by adding detail-pane density rendering, brush/zoom strip sync indicators, and a stable/readable density scale contract.

Purpose: Verification found missing detail-view density rendering, missing strip interaction sync cues, and drifting color semantics from per-render min/max normalization.
Output: Dual timeline shows synchronized density context in both panes with a stable scale interpretation users can read consistently.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-timeline-density-visualization/26-VERIFICATION.md
@.planning/phases/26-timeline-density-visualization/26-02-SUMMARY.md
@.planning/phases/26-timeline-density-visualization/26-03-SUMMARY.md
@src/components/timeline/DensityHeatStrip.tsx
@src/components/timeline/DualTimeline.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stable density scale contract to heat strip</name>
  <files>src/components/timeline/DensityHeatStrip.tsx</files>
  <action>Replace per-render local min/max normalization with an explicit stable scale contract. Add props for an externally provided density domain (for example `[scaleMin, scaleMax]`), use that domain for color interpolation, and keep fallback behavior deterministic when domain is missing. Expose readable scale semantics (legend labels or equivalent textual contract) from the strip API so parent timeline UI can present what low/high colors mean across updates. Keep canvas rendering and DPR handling intact.</action>
  <verify>Run `npm run lint -- src/components/timeline/DensityHeatStrip.tsx` and `npm run build`.</verify>
  <done>Heat strip no longer derives color range from each map render by default; it supports a stable domain contract that can remain consistent across recomputations.</done>
</task>

<task type="auto">
  <name>Task 2: Render density in detail pane and sync strip with brush/zoom domain</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>Update `DualTimeline` so density is visible in both overview and detail sections. Add a detail-pane density layer (detail strip and/or density area under points) tied to detail domain scaling. Add a brush/zoom-linked selection indicator on the overview strip (window highlight or marker) driven directly by `detailRangeSec` so strip context reflects current zoom window. Wire both overview and detail density renders to the same stable density scale domain from Task 1.</action>
  <verify>Run `npm run lint -- src/components/timeline/DualTimeline.tsx` and `npm run build`.</verify>
  <done>Detail pane has explicit density rendering, and overview strip shows current brush/zoom window synchronization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add readable scale indicator in timeline UI</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>Present a compact scale indicator near density tracks (for example, low/high labels or min/max numeric legend) that references the stable domain contract used for rendering. Keep it lightweight and aligned with existing timeline styling. Avoid ambiguous labels; users must be able to infer consistent meaning of blue vs red after recomputations and zoom changes.</action>
  <verify>Run `npm run lint -- src/components/timeline/DualTimeline.tsx` and confirm `npm run build` still succeeds.</verify>
  <done>Timeline UI displays a persistent readable density scale contract tied to the same values used by strip rendering.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with updated strip and timeline integration.
- Overview and detail both visibly include density information.
- Overview strip shows current selection/zoom window linked to brush domain.
- Density legend/contract remains present and stable across recompute updates.
</verification>

<success_criteria>
- Gap 1 closed: both overview and detail views show density visualization.
- Gap 2 closed: strip has explicit brush/zoom-linked sync indicator.
- Gap 4 closed: scale meaning is stable and readable across updates.
- DENS-01 through DENS-04 are structurally satisfiable in production timeline UI.
</success_criteria>

<output>
After completion, create `.planning/phases/26-timeline-density-visualization/26-05-SUMMARY.md`
</output>
