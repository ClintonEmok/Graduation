---
phase: 07-advanced-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/useFilterStore.ts
  - src/store/useDataStore.ts
  - src/components/filters/FilterPanel.tsx
  - src/components/filters/FacetedFilter.tsx
  - src/components/layout/AppSidebar.tsx
autonomous: true
must_haves:
  truths:
    - "User can see a list of Crime Types with counts"
    - "Counts update when data loads"
    - "Filter panel can be toggled"
  artifacts:
    - path: "src/store/useFilterStore.ts"
      provides: "Filter state and facet logic"
    - path: "src/components/filters/FilterPanel.tsx"
      provides: "UI container for filters"
  key_links:
    - from: "src/store/useDataStore.ts"
      to: "src/store/useFilterStore.ts"
      via: "Subscription/Effect to populate facets"
---

<objective>
Establish the filtering infrastructure and UI shell.
Purpose: Enable state management for multi-faceted filtering and provide the UI container.
Output: Working Filter Panel with Crime Type facets populated from real data.
</objective>

<context>
@.planning/phases/07-advanced-filtering/07-CONTEXT.md
@.planning/phases/07-advanced-filtering/07-RESEARCH.md
@src/store/useDataStore.ts
@src/components/layout/AppSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Update DataStore for Filtering</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    Modify `useDataStore.ts` to:
    1. Extract the `District` column from the Arrow table (assume column name "District" or "Ward").
    2. Add `district: Uint8Array` to the `ColumnarData` interface.
    3. Ensure `District` data is normalized/mapped to IDs if it's string-based (it's usually numeric in Chicago data, but might need checking). If it's a number 1-77, we can use it directly or Uint8.
    
    This ensures we have the raw data needed for spatial filtering later.
  </action>
  <verify>Load the app, check `useDataStore.getState().columns.district` in console.</verify>
  <done>District data is loaded into memory.</done>
</task>

<task type="auto">
  <name>Create Filter Store</name>
  <files>src/store/useFilterStore.ts</files>
  <action>
    Create `useFilterStore` with Zustand:
    1. State:
       - `activeFilters`: Record<string, Set<number>> (e.g., 'type' -> {1, 2}, 'district' -> {10})
       - `facets`: Record<string, Record<number, number>> (category ID -> count)
    2. Actions:
       - `toggleFilter(category, id)`
       - `resetFilters()`
       - `computeFacets(columns)`: Iterates over data to count occurrences.
    3. Effects:
       - Subscribe to `useDataStore` to auto-trigger `computeFacets` when data loads.
  </action>
  <verify>Import store in console, check if facets populate after data load.</verify>
  <done>Store exists and computes facets from DataStore.</done>
</task>

<task type="auto">
  <name>Create Filter UI Components</name>
  <files>src/components/filters/FilterPanel.tsx, src/components/filters/FacetedFilter.tsx, src/components/layout/AppSidebar.tsx</files>
  <action>
    1. Create `FacetedFilter.tsx`:
       - Props: `title`, `options` (id, label, count), `selectedIds`, `onToggle`.
       - Renders a scrollable list of checkboxes with counts.
       - Sort by count (descending).
    2. Create `FilterPanel.tsx`:
       - Connects to `useFilterStore`.
       - Renders `FacetedFilter` for "Crime Type".
    3. Update `AppSidebar.tsx` (or Sidebar component):
       - Add a "Filters" tab/button to toggle the panel or render it.
       - Ensure it doesn't overlap/break existing layout.
  </action>
  <verify>Run app, see Filter Panel, click checkboxes, see store update.</verify>
  <done>UI allows selecting crime types.</done>
</task>

</tasks>

<verification>
- [ ] Facets match loaded data counts.
- [ ] Toggling a filter updates the store.
- [ ] UI is responsive and accessible.
</verification>

<success_criteria>
- User can see a list of crime types with accurate counts.
- User can select multiple types.
</success_criteria>

<output>
After completion, create .planning/phases/07-advanced-filtering/07-01-SUMMARY.md
</output>
