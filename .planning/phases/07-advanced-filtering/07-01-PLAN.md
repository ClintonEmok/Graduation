---
phase: 07-advanced-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/useFilterStore.ts
  - src/store/useDataStore.ts
  - src/lib/category-maps.ts
  - src/types/index.ts
autonomous: true
must_haves:
  truths:
    - "Application loads 'District' data from backend"
    - "FilterStore exists and holds selection state"
    - "DataStore maps string categories (Type, District) to stable Integers"
  artifacts:
    - path: "src/store/useFilterStore.ts"
      provides: "Zustand store for filter selections"
    - path: "src/lib/category-maps.ts"
      provides: "Static or dynamic mapping of strings to IDs"
  key_links:
    - from: "src/store/useDataStore.ts"
      to: "src/lib/category-maps.ts"
      via: "Import map to encode data"
---

<objective>
Establish the data foundation for filtering by adding "District" support to the data pipeline and implementing the state management for filter selections.

Purpose: The GPU requires integer IDs for filtering, and the UI requires a central state for selections.
Output: A `useFilterStore` and an updated `useDataStore` that loads District data and maps categories to integers.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/store/useDataStore.ts
@src/components/viz/DataPoints.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Category Mappings and Types</name>
  <files>src/lib/category-maps.ts, src/types/index.ts</files>
  <action>
    1. Create `src/lib/category-maps.ts`.
    2. Define comprehensive `CRIME_TYPE_MAP` (fetching all ~35 Chicago types or using a dynamic generator).
    3. Define `DISTRICT_MAP` (Chicago has ~25-30 districts).
    4. Export helper functions `getCrimeTypeId(string)` and `getDistrictId(string)`.
    5. Update `src/types/index.ts` to include `district` and `districtId` in `CrimeEvent` and `ColumnarData`.
  </action>
  <verify>
    Create a test script `scripts/test-maps.ts` that imports the maps and verifies known keys (e.g. 'Theft') return expected IDs.
  </verify>
  <done>
    Maps exist and Types are updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Filter Store</name>
  <files>src/store/useFilterStore.ts</files>
  <action>
    Create a Zustand store `useFilterStore` with:
    - `selectedTypes`: number[] (default empty = all, or define policy)
    - `selectedDistricts`: number[]
    - `selectedTimeRange`: [number, number] | null (timestamp range for time filtering - DATA-02 requirement)
    - `actions`: `toggleType`, `toggleDistrict`, `resetFilters`, `setTypes`, `setDistricts`, `setTimeRange`, `clearTimeRange`
    - `computed`: `isTypeSelected(id)`, `isDistrictSelected(id)`, `isTimeFiltered`
    
    Note: Store IDs, not strings, to match the GPU requirement.
    Time range should use Unix timestamps for consistency with backend.
  </action>
  <verify>
    Create a test script that imports the store, dispatches `toggleType(1)`, and asserts `selectedTypes.length === 1`. Also test `setTimeRange([0, 999999999])` and verify the range is stored.
  </verify>
  <done>
    Store is importable and responds to all actions correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Data Loader for District Support</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    Modify `loadRealData` in `useDataStore.ts`:
    1. Update the Arrow reader to extract the 'district' column (ensure backend sends it, or handle missing).
    2. Create a new `Uint8Array` for `districtData`.
    3. Map raw district strings to IDs using `getDistrictId`.
    4. Store in `columns` object.
    
    *Note:* If the API stream doesn't send 'district' yet, this task implies checking the backend query is selecting `*` or includes `District`. (Assuming Phase 6 API serves parquet which has it).
  </action>
  <verify>
    Load the app, check `useDataStore.getState().columns.district` in console. It should be a Uint8Array with non-zero values.
  </verify>
  <done>
    DataStore loads and maps District data.
  </done>
</task>

</tasks>

<verification>
Load the application. Open devtools.
1. `useDataStore.getState().columns` should have `type` and `district` Uint8Arrays.
2. `useFilterStore.getState()` should exist.
</verification>

<success_criteria>
- DataStore loads "District" column.
- Categories are mapped to Integers (1-255).
- FilterStore is ready for UI connection.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-01-SUMMARY.md`
</output>
