---
phase: 07-advanced-filtering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/crime/facets/route.ts
autonomous: true
must_haves:
  truths:
    - "API returns counts for Crime Types"
    - "API returns counts for Districts"
    - "API accepts time range query parameters"
  artifacts:
    - path: "src/app/api/crime/facets/route.ts"
      provides: "JSON endpoint for aggregations"
  key_links:
    - from: "src/app/api/crime/facets/route.ts"
      to: "DuckDB"
      via: "SQL aggregation query"
---

<objective>
Create a backend endpoint to provide facet counts (histograms) for the filter UI.

Purpose: The UI needs to show how many events match each category (e.g., "Theft (15,000)") to guide user filtering.
Output: A Next.js Route Handler `/api/crime/facets`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/app/api/crime/stream/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Facets Endpoint</name>
  <files>src/app/api/crime/facets/route.ts</files>
  <action>
    Create a GET endpoint that:
    1. Connects to the DuckDB instance (reuse logic from `stream/route.ts` or generic db singleton if exists).
    2. Accepts query params: `start` (timestamp), `end` (timestamp).
    3. Executes two SQL aggregations in parallel:
       - `SELECT "Primary Type", COUNT(*) as count FROM data WHERE ... GROUP BY 1 ORDER BY count DESC`
       - `SELECT "District", COUNT(*) as count FROM data WHERE ... GROUP BY 1 ORDER BY count DESC`
    4. Returns JSON: `{ types: { name, count }[], districts: { name, count }[] }`.
    
    Use a 5-second cache header to prevent spamming.
  </action>
  <verify>
    `curl "http://localhost:3000/api/crime/facets?start=0&end=999999999"` returns valid JSON with counts.
  </verify>
  <done>
    Endpoint returns aggregation data.
  </done>
</task>

</tasks>

<verification>
Curl the endpoint and verify JSON structure matches expected format.
</verification>

<success_criteria>
- Endpoint works with DuckDB.
- Returns correct counts for Types and Districts.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-02-SUMMARY.md`
</output>
