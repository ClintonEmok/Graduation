---
phase: 07-advanced-filtering
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/components/viz/DataPoints.tsx
  - src/components/viz/shaders/ghosting.ts
autonomous: true
must_haves:
  truths:
    - "Unselected points appear dimmed (ghosted)"
    - "Selected points remain fully opaque"
    - "Filtering updates instantly (via shader)"
  artifacts:
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Updated mesh with new attributes"
    - path: "src/components/viz/shaders/ghosting.ts"
      provides: "Shader injection logic"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/store/useFilterStore.ts"
      via: "Uniform updates"
---

<objective>
Implement GPU-based "ghosting" filtering using custom shaders.

Purpose: To allow users to filter 8M+ points instantly while maintaining spatial context (dimming instead of hiding).
Output: Updated `DataPoints` component with custom shader logic handling `type` and `district` attributes.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/viz/DataPoints.tsx
@src/store/useFilterStore.ts
@src/lib/category-maps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attach Filter Attributes</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Update `DataPoints` to:
    1. Read `district` data from `useDataStore.columns`.
    2. Attach `type` and `district` as `instancedBufferAttribute`s to the `sphereGeometry`.
       - `attributes-filterType` (Uint8)
       - `attributes-filterDistrict` (Uint8)
    
    Ensure these attributes are passed correctly to the shader logic.
  </action>
  <verify>
    Inspect React Three Fiber components or log the geometry attributes in `useLayoutEffect`.
  </verify>
  <done>
    Attributes are present on the geometry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Shader Logic</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Update `onBeforeCompile` (or extract to `src/components/viz/shaders/ghosting.ts`) to:
    1. Accept new uniforms: `uFilterTypeTexture`, `uFilterDistrictTexture` (or arrays/bitmasks).
    2. Accept new attributes: `filterType`, `filterDistrict`.
    3. In Fragment Shader (or Vertex + Varying):
       - Read filter status from Texture/Uniform based on ID.
       - If status is 0 (unselected): reduce `gl_FragColor.a` (alpha) to 0.05 and desaturate `gl_FragColor.rgb`.
    
    Note: For 35 types, a `uniform int uTypeMask` (bitmask) is risky (32-bit limit). A `uniform int uTypeMask[2]` or Texture is safer.
    Recommendation: Use `uniform float uTypeMap[35]` (array of 0.0/1.0) for simplicity if length is small, or Texture if large. 35 is small enough for a uniform array on modern WebGL.
  </action>
  <verify>
    Visual check later. Code should compile without GLSL errors.
  </verify>
  <done>
    Shader code includes filtering logic.
  </done>
</task>

<task type="auto">
  <name>Task 3: Connect Store to Shader</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    In `DataPoints.tsx`:
    1. Subscribe to `useFilterStore` (selectedTypes, selectedDistricts).
    2. Convert selection arrays to the format expected by shader (e.g., Float32Array of 0s/1s).
    3. Update the material uniforms in a `useEffect` or `useFrame`.
  </action>
  <verify>
    Manually toggle values in `useFilterStore` (via DevTools) and observe visual changes (points dimming).
  </verify>
  <done>
    Changing store state updates uniforms.
  </done>
</task>

</tasks>

<verification>
1. Load app.
2. Open React DevTools, find `DataPoints`.
3. Manually invoke `useFilterStore.getState().toggleType(1)`.
4. Verify points of Type 1 remain bright, others dim.
</verification>

<success_criteria>
- Filter attributes passed to GPU.
- Shader compiles and runs.
- Toggling filters dims excluded points.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-03-SUMMARY.md`
</output>
