---
phase: 07-advanced-filtering
plan: 03
type: execute
wave: 3
depends_on: [07-02]
files_modified:
  - src/components/filters/FilterPanel.tsx
  - src/store/useFilterStore.ts
  - src/components/viz/DataPoints.tsx
autonomous: true
must_haves:
  truths:
    - "User can filter by District"
    - "Filters persist across page reloads"
  artifacts:
    - path: "src/store/useFilterStore.ts"
      provides: "Persistence logic"
  key_links:
    - from: "src/store/useFilterStore.ts"
      to: "localStorage"
      via: "persist middleware"
---

<objective>
Complete the Advanced Filtering features: Spatial Filtering and Persistence.
Purpose: Allow geographic slicing and session continuity.
Output: Full filtering suite with District support and state saving.
</objective>

<context>
@src/store/useFilterStore.ts
@src/components/filters/FilterPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Implement District Filtering</name>
  <files>src/components/filters/FilterPanel.tsx, src/store/useFilterStore.ts, src/components/viz/DataPoints.tsx</files>
  <action>
    1. Update `FilterPanel` to include a `FacetedFilter` for "District" (using the data loaded in Plan 01).
    2. Update `DataPoints.tsx` to handle District filtering in the shader (using the attribute added in Plan 02).
       - Add `uDistrictFilter` uniform (Array or Texture).
       - Combine logic: `isVisible = typeVisible && districtVisible`.
  </action>
  <verify>Filter by Type AND District -> Intersection is shown.</verify>
  <done>Multi-faceted filtering works.</done>
</task>

<task type="auto">
  <name>Add State Persistence</name>
  <files>src/store/useFilterStore.ts</files>
  <action>
    1. Add `persist` middleware to `useFilterStore`.
    2. Configure it to save `activeFilters` to `localStorage`.
    3. Ensure rehydration works correctly with the `computeFacets` logic (might need to re-run facet count after rehydration + data load).
  </action>
  <verify>Reload page -> Filters are still applied.</verify>
  <done>Session state persists.</done>
</task>

<task type="auto">
  <name>Add Reset & Preset Actions</name>
  <files>src/components/filters/FilterPanel.tsx, src/store/useFilterStore.ts</files>
  <action>
    1. Add "Reset All" button to Filter Panel.
    2. (Optional) Add simple "Save Preset" UI that stores current config to a `presets` array in localStorage.
  </action>
  <verify>Click Reset -> All filters cleared, View restored.</verify>
  <done>User control features complete.</done>
</task>

</tasks>

<verification>
- [ ] Spatial filtering works alongside Type filtering.
- [ ] Persistence restores state reliably.
- [ ] UI handles large lists (Districts) gracefully (scrollable).
</verification>

<success_criteria>
- User can filter by District.
- Filters survive refresh.
</success_criteria>

<output>
After completion, create .planning/phases/07-advanced-filtering/07-03-SUMMARY.md
</output>
