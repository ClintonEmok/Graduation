---
phase: 07-advanced-filtering
plan: 07
type: execute
wave: 3
depends_on: ["07-01", "07-06", "07-03"]
files_modified:
  - src/store/useFilterStore.ts
  - src/components/map/MapBase.tsx
  - src/components/map/MapVisualization.tsx
  - src/components/map/MapSelectionOverlay.tsx
  - src/components/viz/DataPoints.tsx
  - src/components/viz/shaders/ghosting.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can define a geographic boundary on the map"
    - "Events outside the boundary are ghosted in the 3D view"
  artifacts:
    - path: "src/store/useFilterStore.ts"
      provides: "Spatial bounds state and actions"
    - path: "src/components/map/MapSelectionOverlay.tsx"
      provides: "Map selection UI and boundary preview"
    - path: "src/components/viz/shaders/ghosting.ts"
      provides: "Spatial bounds ghosting logic"
  key_links:
    - from: "src/components/map/MapVisualization.tsx"
      to: "src/store/useFilterStore.ts"
      via: "setSpatialBounds action"
      pattern: "setSpatialBounds"
    - from: "src/store/useFilterStore.ts"
      to: "src/components/viz/DataPoints.tsx"
      via: "selectedSpatialBounds selector"
      pattern: "selectedSpatialBounds"
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/components/viz/shaders/ghosting.ts"
      via: "uBoundsMin/uBoundsMax uniforms"
      pattern: "uBoundsMin|uBoundsMax"
---

<objective>
Add spatial boundary selection on the map and wire it to shader ghosting so users can filter events by a drawn region.

Purpose: Close VIS-04 by enabling geographic boundary filtering beyond district facets.
Output: Map selection UI, spatial filter state, and shader filtering for X/Z bounds.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-advanced-filtering/07-advanced-filtering-VERIFICATION.md
@src/components/map/MapBase.tsx
@src/components/map/MapVisualization.tsx
@src/lib/projection.ts
@src/store/useFilterStore.ts
@src/components/viz/DataPoints.tsx
@src/components/viz/shaders/ghosting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spatial bounds to filter store</name>
  <files>src/store/useFilterStore.ts</files>
  <action>
    Add spatial boundary state to the filter store (e.g., selectedSpatialBounds with minX/maxX/minZ/maxZ and lat/lon for map display). Add actions setSpatialBounds and clearSpatialBounds, plus a getter like isSpatialFiltered, and include spatial filtering in getActiveFilterCount. Keep the existing “empty means all selected” behavior for types/districts untouched.
  </action>
  <verify>Confirm the store exposes selectedSpatialBounds plus set/clear actions.</verify>
  <done>Filter store can persist an active spatial boundary or clear it.</done>
</task>

<task type="auto">
  <name>Task 2: Implement map boundary selection UI</name>
  <files>src/components/map/MapBase.tsx, src/components/map/MapVisualization.tsx, src/components/map/MapSelectionOverlay.tsx</files>
  <action>
    Update MapBase to accept a forwarded map ref and mouse event handlers so parent components can capture drag events. Build MapSelectionOverlay to render the active boundary on the map (GeoJSON polygon using lat/lon bounds) and a temporary drag rectangle while selecting. In MapVisualization, add a “Select Region” toggle and “Clear” action, capture drag start/end on the map, convert screen coords to lng/lat using MapRef, then convert to scene coordinates using project() from src/lib/projection.ts. Write the computed bounds to the filter store via setSpatialBounds.
  </action>
  <verify>Start selection mode, drag a box, and confirm a boundary preview appears and can be cleared.</verify>
  <done>User can draw a geographic boundary on the map and clear it from the overlay.</done>
</task>

<task type="auto">
  <name>Task 3: Wire spatial bounds into shader ghosting</name>
  <files>src/components/viz/DataPoints.tsx, src/components/viz/shaders/ghosting.ts</files>
  <action>
    Extend the ghosting shader with spatial bounds uniforms (uBoundsMin/uBoundsMax and a uHasBounds flag). Pass vWorldX/vWorldZ (or equivalent pre-transform position) from the vertex shader. In DataPoints, read selectedSpatialBounds from the filter store, set the uniforms when bounds are active, and ensure points outside the bounds are ghosted while preserving existing type/district/time-range ghosting.
  </action>
  <verify>Confirm shader uniforms are present and updated from selectedSpatialBounds in DataPoints.</verify>
  <done>Events outside the selected geographic boundary appear dimmed in the 3D view.</done>
</task>

</tasks>

<verification>
- Run `npm run lint`.
- Open the map view, draw a boundary, and confirm 3D points outside the region are ghosted.
</verification>

<success_criteria>
- A drawn boundary visibly limits (ghosts) events outside the selected region.
- Clearing the boundary restores full visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-07-SUMMARY.md`.
</output>
