---
phase: 07-advanced-filtering
plan: 04
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - src/components/viz/FilterOverlay.tsx
  - src/components/viz/MapVisualization.tsx
  - src/components/viz/Controls.tsx
autonomous: true
must_haves:
  truths:
    - "User can open a filter panel"
    - "User can search/select Crime Types"
    - "User can search/select Districts"
    - "User can set a time range filter"
    - "Filter counts match backend data"
  artifacts:
    - path: "src/components/viz/FilterOverlay.tsx"
      provides: "UI component for filtering"
    - path: "src/components/viz/Controls.tsx"
      provides: "Filter button integration"
  key_links:
    - from: "src/components/viz/FilterOverlay.tsx"
      to: "src/store/useFilterStore.ts"
      via: "Zustand actions"
    - from: "src/components/viz/FilterOverlay.tsx"
      to: "/api/crime/facets"
      via: "Fetch on mount/update"
---

<objective>
Build the user interface for the advanced filtering system.

Purpose: Provide accessible controls for the powerful filtering backend/GPU logic.
Output: A floating overlay component containing faceted lists for Crime Types and Districts.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/viz/MapVisualization.tsx
@src/store/useFilterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Filter Overlay Component</name>
  <files>src/components/viz/FilterOverlay.tsx</files>
  <action>
    Create `FilterOverlay.tsx`:
    - Layout: Floating panel (absolute positioned) or Sidebar integration.
    - Components: Two `Command` (shadcn) lists or `ScrollArea` lists with Checkboxes.
    - Props: `isOpen`, `onClose`.
    
    Implement tabs or sections for "Crime Type", "District", and "Time Range" (DATA-02 time facet).
    
    For Time Range section:
    - Add dual slider or two date input fields
    - Connect to `selectedTimeRange` from FilterStore
    - Display formatted dates (e.g., "Jan 1, 2020 - Dec 31, 2024")
    - Add "Clear" button to remove time filter
  </action>
  <verify>
    Component renders in isolation or storybook (if available).
  </verify>
  <done>
    UI structure exists with time range controls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Data and State</name>
  <files>src/components/viz/FilterOverlay.tsx</files>
  <action>
    1. Connect to `useFilterStore` to read/write selections (types, districts, timeRange).
    2. Fetch data from `/api/crime/facets` (using `swr` or `useEffect`).
    3. Render the lists using the fetched facet data (Name + Count).
    4. Sort lists by count (descending).
    
    Add "Select All" / "Clear" buttons for each section.
    
    For time range:
    - Read `selectedTimeRange` from store
    - Convert timestamps to display dates
    - On change, call `setTimeRange([start, end])`
    - Show "Clear" button that calls `clearTimeRange()`
  </action>
  <verify>
    Check that clicking a checkbox updates the store and the UI reflects the count. Test time range picker by setting a range and verifying store updates.
  </verify>
  <done>
    UI is functional and connected for all three facets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount Overlay in Layout</name>
  <files>src/components/viz/MapVisualization.tsx, src/components/viz/Controls.tsx</files>
  <action>
    Add the `FilterOverlay` to the `MapVisualization` or Main Layout.
    
    Add a "Filters" button to `src/components/viz/Controls.tsx` (the existing control bar) to toggle visibility:
    - Import FilterOverlay and manage `isFilterOpen` state
    - Add button with filter icon next to existing controls (Home, Layers, Settings)
    - Button should toggle overlay visibility
    - Overlay should close when clicking outside or pressing Escape
  </action>
  <verify>
    Click "Filter" button in Controls.tsx -> Panel opens. Verify button is positioned correctly in the control bar.
  </verify>
  <done>
    Overlay is accessible from main UI via Controls.tsx.
  </done>
</task>

</tasks>

<verification>
1. Click "Filters" button in Controls.tsx.
2. See list of crimes with counts.
3. Click "Theft".
4. Verify Store updates (check `useFilterStore.getState().selectedTypes`).
5. Set time range using the time picker.
6. Verify `useFilterStore.getState().selectedTimeRange` updates with timestamps.
7. (If Plan 03 done) Verify points dim based on filters.
</verification>

<success_criteria>
- Filter Panel opens/closes via Controls.tsx.
- Facets are populated from API.
- Selections (types, districts) update the central store.
- Time range picker updates `selectedTimeRange` in store.
- All three facets (type, district, time) are accessible in UI.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-04-SUMMARY.md`
</output>
