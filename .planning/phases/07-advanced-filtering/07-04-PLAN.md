---
phase: 07-advanced-filtering
plan: 04
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - src/components/viz/FilterOverlay.tsx
  - src/components/viz/MapVisualization.tsx
autonomous: true
must_haves:
  truths:
    - "User can open a filter panel"
    - "User can search/select Crime Types"
    - "User can search/select Districts"
    - "Filter counts match backend data"
  artifacts:
    - path: "src/components/viz/FilterOverlay.tsx"
      provides: "UI component for filtering"
  key_links:
    - from: "src/components/viz/FilterOverlay.tsx"
      to: "src/store/useFilterStore.ts"
      via: "Zustand actions"
    - from: "src/components/viz/FilterOverlay.tsx"
      to: "/api/crime/facets"
      via: "Fetch on mount/update"
---

<objective>
Build the user interface for the advanced filtering system.

Purpose: Provide accessible controls for the powerful filtering backend/GPU logic.
Output: A floating overlay component containing faceted lists for Crime Types and Districts.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/viz/MapVisualization.tsx
@src/store/useFilterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Filter Overlay Component</name>
  <files>src/components/viz/FilterOverlay.tsx</files>
  <action>
    Create `FilterOverlay.tsx`:
    - Layout: Floating panel (absolute positioned) or Sidebar integration.
    - Components: Two `Command` (shadcn) lists or `ScrollArea` lists with Checkboxes.
    - Props: `isOpen`, `onClose`.
    
    Implement tabs or sections for "Crime Type" and "District".
  </action>
  <verify>
    Component renders in isolation or storybook (if available).
  </verify>
  <done>
    UI structure exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Data and State</name>
  <files>src/components/viz/FilterOverlay.tsx</files>
  <action>
    1. Connect to `useFilterStore` to read/write selections.
    2. Fetch data from `/api/crime/facets` (using `swr` or `useEffect`).
    3. Render the lists using the fetched facet data (Name + Count).
    4. Sort lists by count (descending).
    
    Add "Select All" / "Clear" buttons for each section.
  </action>
  <verify>
    Check that clicking a checkbox updates the store and the UI reflects the count.
  </verify>
  <done>
    UI is functional and connected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount Overlay in Layout</name>
  <files>src/components/viz/MapVisualization.tsx</files>
  <action>
    Add the `FilterOverlay` to the `MapVisualization` or Main Layout.
    Add a "Filters" button to the existing control bar (Controls.tsx or similar) to toggle visibility.
  </action>
  <verify>
    Click "Filter" button -> Panel opens.
  </verify>
  <done>
    Overlay is accessible from main UI.
  </done>
</task>

</tasks>

<verification>
1. Click "Filters".
2. See list of crimes with counts.
3. Click "Theft".
4. Verify Store updates.
5. (If Plan 03 done) Verify points dim.
</verification>

<success_criteria>
- Filter Panel opens/closes.
- Facets are populated from API.
- Selections update the central store.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-04-SUMMARY.md`
</output>
