---
phase: 07-advanced-filtering
plan: 05
type: execute
wave: 3
depends_on: [07-04]
files_modified:
  - src/store/useFilterStore.ts
  - src/components/viz/FilterOverlay.tsx
  - src/components/viz/PresetManager.tsx
autonomous: true
must_haves:
  truths:
    - "User can save current filter configuration as a named preset"
    - "User can load a previously saved preset"
    - "User can delete individual presets"
    - "Presets persist across page reloads"
    - "User can clear all saved presets"
  artifacts:
    - path: "src/store/useFilterStore.ts"
      provides: "Preset state and persistence logic"
    - path: "src/components/viz/PresetManager.tsx"
      provides: "Preset save/load/delete UI"
    - path: "src/components/viz/FilterOverlay.tsx"
      provides: "Integration of preset controls"
  key_links:
    - from: "src/store/useFilterStore.ts"
      to: "localStorage"
      via: "persist middleware or manual sync"
    - from: "src/components/viz/PresetManager.tsx"
      to: "src/store/useFilterStore.ts"
      via: "Preset actions and state"
---

<objective>
Implement filter preset management system allowing users to save, load, and delete named filter configurations.

Purpose: Users often need to switch between different filter views (e.g., "Weekend Nights", "Violent Crimes Downtown"). Presets eliminate repetitive manual filtering and persist across sessions.
Output: A complete preset management UI integrated into the filter panel with localStorage persistence.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/store/useFilterStore.ts
@src/components/viz/FilterOverlay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FilterStore with Preset State and Persistence</name>
  <files>src/store/useFilterStore.ts</files>
  <action>
    Extend the FilterStore to support filter presets:
    
    1. Define `FilterPreset` interface:
       - `id: string` (unique identifier)
       - `name: string` (user-facing label)
       - `types: number[]` (selected crime type IDs)
       - `districts: number[]` (selected district IDs)
       - `timeRange: [number, number] | null` (timestamp range)
       - `createdAt: number` (timestamp for sorting)
    
    2. Add preset state to store:
       - `presets: FilterPreset[]`
       - `lastLoadedPresetId: string | null` (track which preset is active)
    
    3. Add preset actions:
       - `savePreset(name: string)` - saves current filter state as new preset
       - `loadPreset(id: string)` - restores filter state from preset
       - `deletePreset(id: string)` - removes a preset
       - `clearAllPresets()` - removes all presets
       - `renamePreset(id: string, newName: string)` - updates preset name
    
    4. Implement localStorage persistence:
       - On store initialization: load presets from `localStorage.getItem('crimeviz-presets')`
       - On any preset modification: save to localStorage
       - Handle parse errors gracefully (clear corrupted data)
       - Use JSON serialization for preset storage
    
    5. Add computed helpers:
       - `getPresetById(id)` - retrieve specific preset
       - `hasPresets` - boolean check
  </action>
  <verify>
    Write a test script that:
    1. Imports the store and dispatches `savePreset("Test Preset")`
    2. Verifies `presets.length === 1` and preset contains correct data
    3. Dispatches `loadPreset(presetId)` and verifies current filters match saved state
    4. Reloads page (simulated) and verifies presets persist via localStorage
    5. Dispatches `deletePreset(presetId)` and verifies preset is removed from store AND localStorage
  </verify>
  <done>
    Preset state structure exists, all actions work correctly, and localStorage persistence is verified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PresetManager UI Component</name>
  <files>src/components/viz/PresetManager.tsx</files>
  <action>
    Create a new component `PresetManager.tsx` for managing filter presets:
    
    1. Component layout:
       - Header section with "Presets" title and "Save Current" button
       - List of saved presets (or empty state message)
       - Each preset row: name, created date, load/delete buttons
    
    2. "Save Current" flow:
       - Click opens modal/dialog with input field for preset name
       - Validate name is not empty and unique (or append number)
       - On save: close dialog, show success toast
       - Preset appears in list immediately
    
    3. Preset list item actions:
       - "Load" button: restores filters, closes overlay, shows confirmation toast
       - "Delete" button: shows confirmation dialog, then removes preset
       - Rename: inline editing on double-click or edit button
    
    4. Empty state:
       - Message: "No saved presets"
       - Call-to-action: "Save current filters"
    
    5. Styling:
       - Use shadcn/ui components (Dialog, Input, Button, ScrollArea)
       - Match FilterOverlay styling
       - Compact layout suitable for overlay panel
  </action>
  <verify>
    Render PresetManager in isolation and verify:
    1. "Save Current" button opens input dialog
    2. Typing name and saving adds preset to list
    3. Each preset shows load and delete buttons
    4. Delete shows confirmation before removing
    5. Empty state displays when no presets exist
  </verify>
  <done>
    PresetManager UI is complete with all interactions working.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate PresetManager into Filter Overlay</name>
  <files>src/components/viz/FilterOverlay.tsx</files>
  <action>
    Integrate the PresetManager into the existing FilterOverlay component:
    
    1. Add new tab/section "Presets" alongside existing tabs (Types, Districts, Time Range)
    2. Mount PresetManager component in the Presets section
    3. Ensure PresetManager receives proper props (no props needed if using store directly)
    4. Handle preset load action:
       - When user loads a preset, close the FilterOverlay automatically (improve UX)
       - OR show visual indicator that a preset is active
    5. Add "Clear All" button at bottom of Presets section
    6. Style integration:
       - Presets section should have same padding/scroll behavior as other tabs
       - Ensure tab switching works smoothly
    
    7. Optional enhancement - Quick preset buttons:
       - Add 2-3 small buttons below main "Filters" button for instant access to most-used presets
       - Show preset names as tooltips
  </action>
  <verify>
    1. Open FilterOverlay and verify "Presets" tab exists
    2. Click "Presets" tab - should show PresetManager component
    3. Create a preset, switch to "Types" tab, modify filters
    4. Return to "Presets" tab and load the saved preset
    5. Verify filters are restored correctly
    6. Reload page and verify presets persist
  </verify>
  <done>
    PresetManager is fully integrated into FilterOverlay, all tabs work, and preset functionality is accessible from main UI.
  </done>
</task>

</tasks>

<verification>
1. Open FilterOverlay, click "Presets" tab.
2. Click "Save Current", enter "Downtown Evening", click Save.
3. Verify preset appears in list.
4. Change some filters (select different types/districts).
5. Click "Load" on "Downtown Evening" preset.
6. Verify filters revert to saved state.
7. Close browser tab, reopen app.
8. Open FilterOverlay, verify "Downtown Evening" preset still exists.
9. Click "Delete", confirm, verify preset removed.
10. Verify localStorage entry is updated.
</verification>

<success_criteria>
- Users can save current filter configuration as named presets
- Presets persist across browser sessions via localStorage
- Preset UI is accessible from FilterOverlay's "Presets" tab
- Load/Delete/Clear All actions work correctly
- At least 10 presets can be stored without performance issues
- Preset names support Unicode and reasonable length (3-50 chars)
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-05-SUMMARY.md`
</output>
