---
phase: 07-advanced-filtering
plan: 02
subsystem: api
tags: [nextjs, duckdb, parquet, sql, api]

# Dependency graph
requires:
  - phase: 06-data-backend-loading
    provides: crime.parquet and DuckDB streaming API
provides:
  - /api/crime/facets endpoint with type and district aggregations
affects: [filtering-ui, facets, advanced-filtering]

# Tech tracking
tech-stack:
  added: []
  patterns: [DuckDB facet aggregation with time-range filters]

key-files:
  created: [src/app/api/crime/facets/route.ts]
  modified: []

key-decisions:
  - "Fallback to 'Unknown' district bucket when district column is missing to keep facets usable"

patterns-established:
  - "Facet aggregation resolves column names at runtime and filters by epoch timestamps"

# Metrics
duration: 9 min
completed: 2026-02-02
---

# Phase 7 Plan 2: Facets Endpoint Summary

**DuckDB-backed facets endpoint returning crime type and district counts with time-range filters**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-02T16:21:46Z
- **Completed:** 2026-02-02T16:31:29Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Implemented `/api/crime/facets` with type and district aggregations.
- Added time-range filtering over epoch timestamps with cache headers.
- Added schema-aware column resolution to support real and synthetic data layouts.

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Facets Endpoint** - `4b906dc` (feat)

**Plan metadata:** (generated by this commit)

_Note: TDD tasks may have multiple commits (test → feat → refactor)_

## Files Created/Modified
- `src/app/api/crime/facets/route.ts` - Facets endpoint with DuckDB aggregations and caching.

## Decisions Made
- Fallback to "Unknown" district bucket when the dataset lacks district fields to keep facets available.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added schema detection and district fallback**
- **Found during:** Task 1 (Create Facets Endpoint)
- **Issue:** Local crime.parquet schema uses `type` and lacks `District`/`Primary Type`, causing aggregation queries to fail.
- **Fix:** Resolved column names at runtime and fall back to a single "Unknown" district bucket when missing.
- **Files modified:** src/app/api/crime/facets/route.ts
- **Verification:** `curl "http://localhost:3004/api/crime/facets?start=0&end=999999999"`
- **Committed in:** 4b906dc

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Required for the endpoint to function against the current dataset. No scope creep.

## Issues Encountered
- Port 3000 was already in use and an existing Next.js dev process held the lock; verification ran on port 3004.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Facets endpoint is ready for UI wiring; ensure filter time ranges match epoch seconds for non-empty counts.

---
*Phase: 07-advanced-filtering*
*Completed: 2026-02-02*
