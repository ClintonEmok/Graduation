---
phase: 07-advanced-filtering
plan: 06
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/store/useDataStore.ts
  - src/components/viz/DataPoints.tsx
  - src/components/viz/shaders/ghosting.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can set a time range filter and see events outside the range ghosted"
    - "Time range selection affects the rendered data without a full reload"
  artifacts:
    - path: "src/store/useDataStore.ts"
      provides: "Raw timestamp min/max for normalization"
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Shader uniforms updated from selectedTimeRange"
    - path: "src/components/viz/shaders/ghosting.ts"
      provides: "Time range ghosting logic in fragment shader"
  key_links:
    - from: "src/store/useFilterStore.ts"
      to: "src/components/viz/DataPoints.tsx"
      via: "selectedTimeRange selector"
      pattern: "selectedTimeRange"
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/components/viz/shaders/ghosting.ts"
      via: "uTimeMin/uTimeMax uniforms"
      pattern: "uTimeMin|uTimeMax"
---

<objective>
Make the time range filter ghost events outside the selected window using shader uniforms normalized to the dataset time scale.

Purpose: Close the DATA-02 gap by wiring the time range UI to visual filtering.
Output: Time-range-aware shader uniforms and dataset time normalization metadata.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-advanced-filtering/07-advanced-filtering-VERIFICATION.md
@src/store/useDataStore.ts
@src/components/viz/DataPoints.tsx
@src/components/viz/shaders/ghosting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persist raw time bounds for normalization</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    Add time normalization metadata to the data store so the rendering layer can convert unix seconds to the 0-100 shader space. Capture raw min/max timestamps in loadRealData before normalization, store them in state (e.g., minTimestamp/maxTimestamp), and expose them alongside columns. Keep the existing 0-100 normalization for render positions unchanged.
  </action>
  <verify>Confirm useDataStore state includes raw min/max timestamps and they are set during loadRealData.</verify>
  <done>Data store exposes raw time bounds for converting UI time range into normalized shader space.</done>
</task>

<task type="auto">
  <name>Task 2: Wire selectedTimeRange into shader ghosting</name>
  <files>src/components/viz/DataPoints.tsx, src/components/viz/shaders/ghosting.ts</files>
  <action>
    Extend the ghosting shader to accept uTimeMin/uTimeMax uniforms and a vLinearY varying. Use vLinearY (pre-adaptive Y) to ghost points outside the selected range while preserving existing type/district ghosting and time plane dimming. In DataPoints, read selectedTimeRange and the raw min/max timestamps from the data store, normalize the selected range into the 0-100 scale, and update uTimeMin/uTimeMax on the shader. When no time range is selected, set the uniforms to the full dataset range so no additional ghosting occurs.
  </action>
  <verify>Confirm ghosting.ts defines uTimeMin/uTimeMax and DataPoints updates them from selectedTimeRange.</verify>
  <done>Changing the time range in FilterOverlay visually ghosts events outside the selected window.</done>
</task>

</tasks>

<verification>
- Run `npm run lint`.
- Open the app, set a time range in the filter overlay, and confirm points outside the range are dimmed.
</verification>

<success_criteria>
- Time range selection visibly affects rendered points without reloading data.
- Shader uniforms for time range are updated whenever selectedTimeRange changes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-filtering/07-06-SUMMARY.md`.
</output>
