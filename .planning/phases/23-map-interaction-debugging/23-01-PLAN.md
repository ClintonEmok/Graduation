---
phase: 23-map-interaction-debugging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/components/map/MapVisualization.tsx, src/components/map/MapDebugOverlay.tsx]
autonomous: true
must_haves:
  truths:
    - "Clicking on map selects nearest point"
    - "Debug lines visualize connection between click and point"
  artifacts:
    - path: "src/components/map/MapDebugOverlay.tsx"
      provides: "Visual debug feedback"
  key_links:
    - from: "src/components/map/MapVisualization.tsx"
      to: "src/components/map/MapDebugOverlay.tsx"
      via: "Render"
---

<objective>
Enable robust point selection on the 2D map and add debug visualization to verify alignment.
Purpose: Fix the "clicking on point does nothing" issue and provide visual feedback.
Output: Updated map interaction logic and a new debug overlay.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/map/MapVisualization.tsx
@src/lib/selection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Map Debug Overlay</name>
  <files>src/components/map/MapDebugOverlay.tsx</files>
  <action>
    Create `src/components/map/MapDebugOverlay.tsx`.
    
    Props:
    - `clickPoint`: { lat: number, lon: number } | null
    - `selectedPoint`: { lat: number, lon: number } | null
    
    Logic:
    - Use `react-map-gl/maplibre`'s `Source` and `Layer` (GeoJSON LineString) OR an SVG overlay (CanvasOverlay might be better for dynamic lines, but GeoJSON is easier in MapLibre).
    - Draw a line between `clickPoint` and `selectedPoint`.
    - Draw a small circle at `clickPoint` (red) and `selectedPoint` (green).
    - If only `clickPoint` exists (no match), show it in red.
  </action>
  <verify>
    File created.
  </verify>
  <done>Debug overlay component exists.</done>
</task>

<task type="auto">
  <name>Task 2: Update Map Interaction</name>
  <files>src/components/map/MapVisualization.tsx</files>
  <action>
    Update `src/components/map/MapVisualization.tsx`:
    1. Add `lastClick` state: `{ lat: number, lon: number } | null`.
    2. Replace `onMouseUp` logic with `onClick` for point selection (keep `onMouseUp` for drag end if needed, but `onClick` is better for single taps).
    3. In `onClick`:
       - Store click lat/lon in `lastClick`.
       - Perform `findNearestIndexByScenePosition`.
       - If found, set selected index.
       - If not found, clear selection (but keep `lastClick` visible for debugging).
    4. Render `MapDebugOverlay` passing `lastClick` and the resolved selected point (using `resolvePointByIndex(selectedIndex)`).
  </action>
  <verify>
    Map handles clicks and renders debug overlay.
  </verify>
  <done>Map interaction updated.</done>
</task>

</tasks>

<verification>
- Click map -> `lastClick` updates -> Debug line appears if selection found.
</verification>

<success_criteria>
- [ ] Clicking points selects them
- [ ] Debug lines show the relationship
</success_criteria>

<output>
After completion, create `.planning/phases/23-map-interaction-debugging/23-01-SUMMARY.md`
</output>
