---
phase: 18-trajectories-visualization
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified: [src/components/viz/Trajectory.tsx, src/components/map/MapTrajectoryLayer.tsx, src/components/map/MapVisualization.tsx, src/store/useTrajectoryStore.ts]
autonomous: true

must_haves:
  truths:
    - "Hovering a trajectory highlights it and shows a summary tooltip"
    - "Clicking a trajectory selects all associated points and focuses the camera"
    - "Non-selected trajectories are ghosted/transparent to reduce visual clutter"
    - "A 2D 'footprint' of the selected trajectory appears on the Map view"
  artifacts:
    - path: "src/components/map/MapTrajectoryLayer.tsx"
      provides: "2D map-side trajectory rendering"
  key_links:
    - from: "src/components/viz/Trajectory.tsx"
      to: "useTrajectoryStore"
      via: "hover/click events"
    - from: "src/components/map/MapVisualization.tsx"
      to: "MapTrajectoryLayer"
      via: "component inclusion"
---

<objective>
Enhance trajectory exploration with interaction, occlusion management, and 2D map integration.

Purpose: Allow users to drill down into specific sequences and understand their geographic footprint while maintaining visual clarity.
Output: Interactive 3D trajectories and a synchronized 2D map layer.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-trajectories-visualization/18-02-SUMMARY.md
@src/components/map/MapVisualization.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Interaction Logic</name>
  <files>src/components/viz/Trajectory.tsx</files>
  <action>
    Add `onPointerOver`, `onPointerOut`, and `onClick` handlers to the `Trajectory` component.
    - Update `useTrajectoryStore` with `hoveredBlock` and `selectedBlock`.
    - On click, iterate through the trajectory's points and call `setSelectedIndex` for each or implement a batch selection in `useCoordinationStore` (or simply select the first point to trigger focus).
    - If `selectedBlock` is set, non-selected trajectories should reduce their opacity significantly (ghosting).
  </action>
  <verify>Hovering and clicking trajectories updates the visual state and store.</verify>
  <done>Trajectories are interactive.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Map Footprint Layer</name>
  <files>src/components/map/MapTrajectoryLayer.tsx, src/components/map/MapVisualization.tsx</files>
  <action>
    Create `MapTrajectoryLayer.tsx`:
    - Listen for `selectedBlock` from `useTrajectoryStore`.
    - Render a GeoJSON `LineString` or `Source/Layer` on the map representing the geographic path of the selected trajectory.
    - If no selection, hide the layer or show a faded version of all trajectories.
    
    Integrate into `MapVisualization.tsx`.
  </action>
  <verify>Select a trajectory in 3D and confirm a line appears on the 2D map.</verify>
  <done>Cross-view synchronization for trajectories is complete.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Temporal Decay (Optional/Polish)</name>
  <files>src/components/viz/Trajectory.tsx</files>
  <action>
    Add logic to only render segments of the trajectory that are within a certain temporal window of the `currentTime` from `useTimeStore`.
    - This helps visualize the "active" part of the sequence during playback.
  </action>
  <verify>Scrub the timeline and confirm only relevant parts of the trajectory are visible or highlighted.</verify>
  <done>Trajectory trail effect is implemented.</done>
</task>

<task type="auto">
  <name>Task 4: Camera Focus on Selection</name>
  <files>src/components/viz/TrajectoryLayer.tsx</files>
  <action>
    When a trajectory is selected, calculate its bounding box and use `CameraControls.fitToBox` to frame the sequence in the 3D view.
  </action>
  <verify>Clicking a trajectory triggers a smooth camera transition to frame it.</verify>
  <done>Exploration flow is enhanced with auto-focus.</done>
</task>

</tasks>

<verification>
Test the full interaction cycle: hover, click to select, view on map, camera focus.
Confirm performance remains acceptable with multiple trajectories.
</verification>

<success_criteria>
- Hovering shows clear visual feedback.
- Selection isolates the path and highlights associated points.
- Map view shows geographic trace of selected path.
- Camera focuses on selected trajectory.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-03-SUMMARY.md`
</output>
