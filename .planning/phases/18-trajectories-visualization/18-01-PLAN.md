---
phase: 18-trajectories-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/types/index.ts, scripts/setup-data.js, src/store/useDataStore.ts, src/store/useTrajectoryStore.ts, src/lib/mockData.ts]
autonomous: true

must_haves:
  truths:
    - "Data prep pipeline includes 'block' attribute in Parquet export"
    - "Core types and DataStore support the 'block' field"
    - "Mock data generates grouped sequences for testing trajectories"
  artifacts:
    - path: "scripts/setup-data.js"
      provides: "Updated data pipeline with block data"
    - path: "src/store/useTrajectoryStore.ts"
      provides: "Trajectory state management"
  key_links:
    - from: "src/store/useDataStore.ts"
      to: "apache-arrow"
      via: "table.getChild('block')"
---

<objective>
Establish the data foundation for trajectory visualization by adding the 'block' attribute to the data pipeline, types, and state management.

Purpose: Trajectories rely on grouping events by geographic block. This plan ensures that the 'block' attribute is available in both synthetic and real data exports and correctly loaded into the application state.
Output: Updated types, data prep script, mock generator, and a new trajectory store.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
@scripts/setup-data.js
@src/store/useDataStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Core Types and Data Prep</name>
  <files>src/types/index.ts, scripts/setup-data.js</files>
  <action>
    - In `src/types/index.ts`, add `block?: string` to `CrimeEvent` and `FilteredPoint`. Add `block: string[]` to `ColumnarData`.
    - In `scripts/setup-data.js`, update `generateCSV` to include a `block` column (e.g., "100 N STATE ST").
    - Update the DuckDB query in `scripts/setup-data.js` to include the `block` column in the final Parquet export.
  </action>
  <verify>Run `node scripts/setup-data.js` and verify parquet schema with `parquet-tools inspect` or similar (or just check that it runs without error).</verify>
  <done>Parquet export and types include the 'block' attribute.</done>
</task>

<task type="auto">
  <name>Task 2: Update Data Store & Loading</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    - Update `ColumnarData` and `FilteredPoint` usages in `useDataStore.ts` to include `block`.
    - In `loadRealData`, extract the 'block' column from the Arrow table and add it to the `columns` state.
    - Ensure `selectFilteredData` passes through the `block` attribute.
  </action>
  <verify>Log `columns` in `loadRealData` to confirm 'block' array is present.</verify>
  <done>DataStore correctly loads and exposes block information from real data.</done>
</task>

<task type="auto">
  <name>Task 3: Trajectory Store & Mock Data</name>
  <files>src/store/useTrajectoryStore.ts, src/lib/mockData.ts</files>
  <action>
    - Create `src/store/useTrajectoryStore.ts` to manage:
      - `hoveredBlock: string | null`
      - `selectedBlock: string | null`
      - `isVisible: boolean` (feature flag controlled)
    - Update `src/lib/mockData.ts` to generate sequences of events with the same `block` ID at fixed (x, z) positions but different timestamps.
  </action>
  <verify>Confirm `useTrajectoryStore` exports expected actions and `mockData` produces sequential block events.</verify>
  <done>State and mock data ready for rendering.</done>
</task>

</tasks>

<verification>
Check that the 'block' attribute exists in types, store, and mock data.
Verify `setup-data.js` produces a parquet with the 'block' column.
</verification>

<success_criteria>
- Types include `block`.
- `setup-data.js` exports `block`.
- `useDataStore` loads `block`.
- `mockData` groups events by `block`.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-01-SUMMARY.md`
</output>
