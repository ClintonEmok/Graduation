---
phase: 18-trajectories-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/types/index.ts, src/store/useDataStore.ts, src/lib/mockData.ts, src/store/useTrajectoryStore.ts]
autonomous: true

must_haves:
  truths:
    - "Data structures support the 'block' attribute for trajectory grouping"
    - "Mock data generates sequences of events for the same block at the same location"
    - "Trajectory store manages the visibility and selection state of trajectories"
  artifacts:
    - path: "src/store/useTrajectoryStore.ts"
      provides: "State management for trajectories"
    - path: "src/lib/mockData.ts"
      provides: "Grouped event sequences for testing"
  key_links:
    - from: "src/store/useDataStore.ts"
      to: "apache-arrow"
      via: "table.getChild('block')"
---

<objective>
Establish the data foundation for trajectory visualization by adding the 'block' attribute to event models and creating a dedicated state store for trajectory management.

Purpose: Trajectories depend on grouping events by geographic block. This plan ensures that both mock and real data contain this grouping key.
Output: Updated types, enhanced mock data, and a new trajectory state store.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
@src/store/useDataStore.ts
@src/lib/mockData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Core Types</name>
  <files>src/types/index.ts</files>
  <action>
    Add `block?: string` to the `CrimeEvent` interface.
    Add `block: string[]` to the `ColumnarData` interface to support block attributes in real data.
  </action>
  <verify>Check types compile without errors.</verify>
  <done>Interfaces reflect the new block attribute.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Data Store and Loading</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    Update `ColumnarData` interface in `useDataStore.ts` to match `src/types/index.ts` (add `block: string[]`).
    In `loadRealData`, extract the 'block' column from the Arrow table (if available) and include it in the `columns` state.
    Update `selectFilteredData` to include `block` in the returned `FilteredPoint` objects.
  </action>
  <verify>Verify `loadRealData` logs the availability of the 'block' column.</verify>
  <done>Store successfully manages and exposes block data.</done>
</task>

<task type="auto">
  <name>Task 3: Create Trajectory Store</name>
  <files>src/store/useTrajectoryStore.ts</files>
  <action>
    Create a new Zustand store to manage trajectory-specific state:
    - `hoveredBlock: string | null`
    - `selectedBlock: string | null`
    - `setHoveredBlock: (block: string | null) => void`
    - `setSelectedBlock: (block: string | null) => void`
    - `isVisible: boolean` (controlled by feature flag but can be toggled manually)
  </action>
  <verify>Store exists and exports expected state/actions.</verify>
  <done>Trajectory state is centralized.</done>
</task>

<task type="auto">
  <name>Task 4: Update Mock Data Generator</name>
  <files>src/lib/mockData.ts</files>
  <action>
    Modify `generateMockData` to create sequences of events for specific blocks.
    - Define a few "hot blocks" with fixed (x, z) coordinates.
    - Generate multiple events per hot block with different timestamps (Y positions).
    - Ensure these events have the same `block` string.
  </action>
  <verify>Run a small script or test to confirm generated data contains multiple events for the same block at identical (x, z) positions.</verify>
  <done>Mock data provides suitable sequences for testing vertical "pillars" and connections.</done>
</task>

</tasks>

<verification>
Check that `useDataStore` can handle the new `block` field and `mockData` produces grouped events.
Verify `useTrajectoryStore` is accessible.
</verification>

<success_criteria>
- Event models include `block`.
- `useDataStore` loads `block` from stream.
- `mockData` produces sequential block events.
- `useTrajectoryStore` is ready for UI integration.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-01-SUMMARY.md`
</output>
