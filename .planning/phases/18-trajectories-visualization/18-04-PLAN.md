---
phase: 18-trajectories-visualization
plan: 04
type: execute
wave: 4
depends_on: ["18-03"]
files_modified: [src/components/map/MapTrajectoryLayer.tsx, src/components/map/MapVisualization.tsx, src/components/viz/Trajectory.tsx, src/components/viz/MainScene.tsx]
autonomous: true

must_haves:
  truths:
    - "Selected trajectory shows 2D footprint on the map view"
    - "Temporal decay (trail) effect is visible during playback"
    - "Camera auto-focuses on selected trajectory sequence"
  artifacts:
    - path: "src/components/map/MapTrajectoryLayer.tsx"
      provides: "Map-side footprint rendering"
  key_links:
    - from: "src/components/viz/MainScene.tsx"
      to: "TrajectoryLayer"
      via: "feature-gated inclusion"
---

<objective>
Finalize the trajectory feature with cross-view synchronization, temporal decay effects, and navigation polish.

Purpose: Provide geographic context on the 2D map and focus attention on active temporal windows and selected sequences.
Output: Integrated 2D map layer, temporal decay logic, and camera focus automation.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-trajectories-visualization/18-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map Footprint Integration</name>
  <files>src/components/map/MapTrajectoryLayer.tsx, src/components/map/MapVisualization.tsx</files>
  <action>
    - Create `MapTrajectoryLayer.tsx` to render a 2D line (GeoJSON) for the `selectedBlock`.
    - Fetch points for the selected block and construct a GeoJSON LineString.
    - Integrate into `MapVisualization.tsx` using `Source` and `Layer` from `react-map-gl`.
  </action>
  <verify>Select a trajectory in 3D and confirm a matching line appears on the map.</verify>
  <done>2D map provides geographic footprint for 3D paths.</done>
</task>

<task type="auto">
  <name>Task 2: Temporal Decay & Trail Effect</name>
  <files>src/components/viz/Trajectory.tsx</files>
  <action>
    - Implement Temporal Decay: In the fragment shader or via vertex colors, fade out trajectory segments that are outside a specific time window relative to `currentTime`.
    - This creates a "trail" that follows the current time point during animation.
  </action>
  <verify>Play the temporal animation and observe segments fading in/out around the playhead.</verify>
  <done>Trajectories support temporal focus.</done>
</task>

<task type="auto">
  <name>Task 3: Integration & Auto-Focus</name>
  <files>src/components/viz/TrajectoryLayer.tsx, src/components/viz/MainScene.tsx</files>
  <action>
    - In `TrajectoryLayer.tsx`, add a `useEffect` that listens for `selectedBlock` changes.
    - Calculate the bounding box of the selected trajectory and call `controls.fitToBox` to focus the camera.
    - Ensure `TrajectoryLayer` is included in `MainScene.tsx` and gated by the `trajectories` feature flag.
  </action>
  <verify>Toggle the feature flag; select a trajectory and confirm camera focus.</verify>
  <done>Trajectories are fully integrated with navigation and settings.</done>
</task>

</tasks>

<verification>
Check map footprint visibility.
Verify temporal decay responds to time slider.
Confirm camera auto-focus works on selection.
</verification>

<success_criteria>
- Map shows selected path.
- Trail effect highlights current time window.
- Camera frames selected sequence.
- Feature flag correctly toggles visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-04-SUMMARY.md`
</output>
