---
phase: 18-trajectories-visualization
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified: [src/lib/trajectories.ts, src/components/viz/TrajectoryLayer.tsx, src/components/viz/Trajectory.tsx, src/components/viz/MainScene.tsx]
autonomous: true

must_haves:
  truths:
    - "Events are correctly grouped by block and sorted by time into paths"
    - "Trajectories are rendered as 3D lines connecting points in the cube"
    - "Trajectories show a temporal gradient from early (dim) to late (bright)"
    - "Trajectories adapt their vertical position when Adaptive Time mode is active"
  artifacts:
    - path: "src/lib/trajectories.ts"
      provides: "Trajectory grouping logic"
    - path: "src/components/viz/TrajectoryLayer.tsx"
      provides: "Container for all trajectories"
    - path: "src/components/viz/Trajectory.tsx"
      provides: "Individual path rendering"
  key_links:
    - from: "src/components/viz/Trajectory.tsx"
      to: "@react-three/drei/Line"
      via: "rendering"
    - from: "src/components/viz/MainScene.tsx"
      to: "TrajectoryLayer"
      via: "component inclusion"
---

<objective>
Implement the core trajectory rendering engine and 3D visualization components.

Purpose: Connect grouped events with visual paths in the Space-Time Cube, ensuring they respond to temporal scaling and show directionality.
Output: A functional trajectory layer in the 3D scene.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-trajectories-visualization/18-01-SUMMARY.md
@src/lib/adaptive-scale.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Trajectory Grouping Logic</name>
  <files>src/lib/trajectories.ts</files>
  <action>
    Implement `groupToTrajectories` using `d3-array`'s `group`.
    - Group `FilteredPoint` array by `block`.
    - Sort points within each group by their `y` (linear time) coordinate.
    - Return an array of trajectory objects containing the block ID and sorted points.
  </action>
  <verify>Write a small test or use console logs to confirm points are correctly grouped and chronologically ordered.</verify>
  <done>Data is prepared for line rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Create Trajectory Components</name>
  <files>src/components/viz/Trajectory.tsx, src/components/viz/TrajectoryLayer.tsx</files>
  <action>
    Create `TrajectoryLayer.tsx`:
    - Fetch filtered data and group into trajectories.
    - Map over groups to render `Trajectory` components.
    - Use `useMemo` for performance.
    
    Create `Trajectory.tsx`:
    - Use `@react-three/drei`'s `<Line />` component.
    - Implement temporal gradient using `vertexColors` (dim/transparent start -> bright/opaque end).
    - Implement adaptive Y awareness: In a `useFrame` loop (or via `useMemo` triggered by scale changes), interpolate vertex Y positions between linear and adaptive values to match the `DataPoints` transition.
  </action>
  <verify>Visual confirmation of lines connecting points in the 3D cube.</verify>
  <done>Trajectories are visible in 3D.</done>
</task>

<task type="auto">
  <name>Task 3: Add Directional Arrowheads</name>
  <files>src/components/viz/Trajectory.tsx</files>
  <action>
    Add a `mesh` with `coneGeometry` at the end of each trajectory path (the latest point in time).
    - Orient the cone towards the previous point to indicate direction.
    - Scale arrowheads appropriately for the view.
  </action>
  <verify>Visual confirmation of cones at the "head" of each trajectory.</verify>
  <done>Temporal direction is explicitly indicated.</done>
</task>

<task type="auto">
  <name>Task 4: Integrate with Main Scene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Import and add `TrajectoryLayer` to the `Scene` in `MainScene.tsx`.
    - Gate rendering with the `trajectories` feature flag.
  </action>
  <verify>Toggle the Trajectories flag in the settings panel and confirm the layer appears/disappears.</verify>
  <done>Layer is integrated into the main application.</done>
</task>

</tasks>

<verification>
Confirm trajectories are visible and connected.
Verify they transition correctly when switching to Adaptive Time mode.
Confirm arrowheads are correctly oriented.
</verification>

<success_criteria>
- Lines connect points belonging to the same block.
- Color gradient shows temporal progression.
- Cones indicate path direction.
- Trajectories move with points during scaling transitions.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-02-SUMMARY.md`
</output>
