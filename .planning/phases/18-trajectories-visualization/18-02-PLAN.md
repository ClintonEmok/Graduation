---
phase: 18-trajectories-visualization
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified: [src/lib/trajectories.ts, src/components/viz/TrajectoryLayer.tsx, src/components/viz/Trajectory.tsx]
autonomous: true

must_haves:
  truths:
    - "Trajectories show entire historical path if any member point is filtered in"
    - "Line thickness scales based on temporal gap between events (Dynamic Thickness)"
    - "Trajectories adapt to linear vs adaptive time scaling seamlessly"
  artifacts:
    - path: "src/lib/trajectories.ts"
      provides: "Membership-aware grouping logic"
    - path: "src/components/viz/Trajectory.tsx"
      provides: "Rendering with dynamic thickness and gradients"
  key_links:
    - from: "src/components/viz/Trajectory.tsx"
      to: "@react-three/drei/Line"
      via: "rendering"
---

<objective>
Implement the core trajectory rendering engine with contextual filtering and dynamic visual properties.

Purpose: Connect grouped events with paths that provide full narrative context (historical visibility) and emphasize temporal patterns through dynamic thickness and directionality.
Output: A functional trajectory layer with directionality and adaptive awareness.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-trajectories-visualization/18-01-SUMMARY.md
@src/lib/adaptive-scale.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Contextual Filtering Logic</name>
  <files>src/lib/trajectories.ts</files>
  <action>
    Implement `groupToTrajectories` with membership-aware filtering:
    - Take the *full* dataset and the *filtered* point set as inputs.
    - Group the full dataset by `block`.
    - Filter trajectories: A trajectory (block group) is kept if **any** of its points are present in the *filtered* set.
    - Sort points within each kept trajectory by time (y coordinate).
    - Return an array of trajectory objects.
  </action>
  <verify>Console log the number of trajectories vs filtered points; confirm trajectories contain points outside the current filter if they share a block with a filtered point.</verify>
  <done>Trajectories provide full historical context for filtered events.</done>
</task>

<task type="auto">
  <name>Task 2: Core Rendering & Adaptive Awareness</name>
  <files>src/components/viz/TrajectoryLayer.tsx, src/components/viz/Trajectory.tsx</files>
  <action>
    - Create `TrajectoryLayer.tsx` to manage the collection of trajectories.
    - Create `Trajectory.tsx` using `@react-three/drei`'s `<Line />`.
    - Implement adaptive Y interpolation: Use the same logic as `DataPoints` to transition line vertices between linear and adaptive Y positions based on `adaptiveWeight`.
    - Apply temporal gradient: Dim/transparent at start, bright at end.
  </action>
  <verify>Visual confirmation of lines connecting points and moving correctly during scale transitions.</verify>
  <done>Trajectories are rendered and scale-aware.</done>
</task>

<task type="auto">
  <name>Task 3: Dynamic Thickness & Arrowheads</name>
  <files>src/components/viz/Trajectory.tsx</files>
  <action>
    - Implement Dynamic Thickness: Scale the `lineWidth` prop of each segment based on the temporal gap (Y distance) to the next point (shorter gap = thicker line).
    - Add cone meshes at the end of each trajectory to indicate temporal direction.
  </action>
  <verify>Observe variation in line thickness and presence of directional arrows.</verify>
  <done>Temporal flow and recurrence intensity are visually encoded.</done>
</task>

</tasks>

<verification>
Confirm trajectories show the "entire historical path" for a block.
Verify dynamic thickness varies with temporal proximity.
Check adaptive transitions.
</verification>

<success_criteria>
- Full paths are shown if any point matches filter.
- Line thickness reflects temporal gaps.
- Cones indicate direction.
- Geometry responds to adaptive scaling.
</success_criteria>

<output>
After completion, create `.planning/phases/18-trajectories-visualization/18-02-SUMMARY.md`
</output>
