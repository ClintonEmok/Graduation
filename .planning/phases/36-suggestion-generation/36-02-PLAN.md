---
phase: 36-suggestion-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/warp-generation.ts]
autonomous: true

must_haves:
  truths:
    - "Warp profiles generated from real crime density data"
    - "Multiple alternatives (2-3) with different emphasis"
    - "Confidence scores included"
  artifacts:
    - path: "src/lib/warp-generation.ts"
      provides: "Warp profile generation algorithms"
      exports: ["generateWarpProfiles", "WarpProfile", "DensityAnalysis"]
---

<objective>
Create warp profile generation algorithms that analyze crime density data to generate warp profile suggestions.

Purpose: Core algorithm for generating warp profile alternatives. Uses hybrid approach combining density-weighting with event detection per CONTEXT.md. Generates 2-3 alternatives with different emphasis (aggressive vs conservative).
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/store/useSuggestionStore.ts (for WarpProfileData type)
@src/lib/confidence-scoring.ts (36-01)
@src/types/crime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create warp-generation.ts module</name>
  <files>src/lib/warp-generation.ts</files>
  <action>
    Create src/lib/warp-generation.ts with the following:

    1. Types:
       ```typescript
       export interface DensityBin {
         epochStart: number;
         epochEnd: number;
         count: number;
         density: number; // normalized 0-1
       }
       
       export interface DensityAnalysis {
         bins: DensityBin[];
         timeRange: { start: number; end: number };
         totalCrimes: number;
         peakEpochs: number[]; // epochs with highest density
         lowEpochs: number[];   // epochs with lowest density
       }
       
       export interface WarpProfile {
         name: string;
         intervals: Array<{
           startPercent: number;
           endPercent: number;
           strength: number; // 0.5-2.0 warp factor
         }>;
         confidence: number;
         emphasis: 'aggressive' | 'balanced' | 'conservative';
       }
       ```

    2. Functions:
       - `analyzeDensity(crimes: CrimeRecord[], binCount: number): DensityAnalysis`
         - Bin crimes into time intervals
         - Calculate density (crimes per time unit)
         - Identify peak and low epochs
       
       - `detectEvents(densityBins: DensityBin[]): number[]`
         - Detect significant density changes (events)
         - Use change point detection approach
         - Return epoch boundaries where events occur

        - `generateWarpProfiles(crimes: CrimeRecord[], timeRange: {start: number, end: number}, options?: {binCount?: number, profileCount?: number, intervalCount?: number}): WarpProfile[]`
          - Main export function
          - Analyzes crime density
          - Generates 2-3 profiles with different emphasis:
            - "Aggressive": Larger strength variations, more intervals
            - "Balanced": Moderate variations, standard intervals  
            - "Conservative": Smaller variations, fewer intervals
          - Accepts optional intervalCount (3-12) to control number of intervals per profile
          - Each profile includes confidence score from confidence-scoring module
          - Returns WarpProfile[] matching useSuggestionStore WarpProfileData format

    3. Key algorithm details:
       - Use hybrid: density-weighting + event detection
       - Strength calculation: inverse of density (sparse = high warp, dense = low warp)
       - Event detection: look for significant density transitions (>2 std dev change)
       - Profile count: default 3, configurable via options

    Import confidence-scoring module to calculate per-profile confidence scores.
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Module exports generateWarpProfiles, WarpProfile, DensityAnalysis
  </verify>
  <done>
    - warp-generation.ts exists with analyzeDensity, detectEvents, generateWarpProfiles
    - Generates 2-3 warp profile alternatives
    - Each has confidence score
    - Output matches WarpProfileData format for useSuggestionStore
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Functions handle edge cases: empty crimes array, single crime, uniform distribution
- Profile names are user-friendly (e.g., "High Density Focus", "Uniform Balance")
</verification>

<success_criteria>
Warp profile generation module created with hybrid density+event algorithm, generating 2-3 alternatives with different emphasis, each with confidence scores.
</success_criteria>

<output>
After completion, create `.planning/phases/36-suggestion-generation/36-02-SUMMARY.md`
</output>
