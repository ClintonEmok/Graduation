---
phase: 36-suggestion-generation
plan: 04
type: execute
wave: 2
depends_on: [36-01, 36-02, 36-03]
files_modified: [src/hooks/useSuggestionGenerator.ts]
autonomous: true

must_haves:
  truths:
    - "Real algorithm-generated suggestions appear in UI"
    - "Suggestions respond to active filters"
    - "Multiple alternatives offered"
    - "Empty dataset shows helpful message"
  artifacts:
    - path: "src/hooks/useSuggestionGenerator.ts"
      provides: "Replace mock with real generation"
      replaces: "useSuggestionTrigger.ts mock generation"
---

<objective>
Integrate real generation algorithms with the suggestion system, replacing mock data with actual crime density analysis.

Purpose: Wires up the confidence-scoring, warp-generation, and interval-detection modules to the suggestion store. Makes suggestions context-aware (respond to filters) and handles empty data gracefully.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/hooks/useSuggestionTrigger.ts (existing mock to replace)
@src/store/useSuggestionStore.ts
@src/lib/warp-generation.ts (36-02)
@src/lib/interval-detection.ts (36-03)
@src/lib/confidence-scoring.ts (36-01)
@src/hooks/useCrimeData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSuggestionGenerator hook</name>
  <files>src/hooks/useSuggestionGenerator.ts</files>
  <action>
    Create src/hooks/useSuggestionGenerator.ts to replace the mock generation:

    1. Rename existing useSuggestionTrigger.ts to useSuggestionGenerator.ts OR create new file (new file preferred to maintain history)

    2. Import and wire up real algorithms:
       - Import { generateWarpProfiles } from '@/lib/warp-generation'
       - Import { detectBoundaries, BoundaryMethod } from '@/lib/interval-detection'
       - Import { useCrimeData } from '@/hooks/useCrimeData'
       - Import { useSuggestionStore, type WarpProfileData, type IntervalBoundaryData } from '@/store/useSuggestionStore'
       - Import { useViewportStore, useCrimeFilters } from '@/lib/stores/viewportStore'

    3. Core generate function:
       ```typescript
       const generateSuggestions = useCallback(async () => {
         // Get current viewport and filters
         const { startDate, endDate } = useViewportStore.getState();
         const { crimeTypes } = useViewportStore.getState().filters;
         
         // Fetch crime data for analysis
         const { data: crimes } = useCrimeData({
           startEpoch: startDate,
           endEpoch: endDate,
           crimeTypes: crimeTypes.length > 0 ? crimeTypes : undefined,
           bufferDays: 0,  // Use exact viewport for generation
           limit: 100000,  // Sufficient for density analysis
         });
         
         if (!crimes || crimes.length === 0) {
           // Show empty dataset message - could set a flag in store
           console.log('[useSuggestionGenerator] No crimes in viewport, showing empty message');
           return;
         }
         
         const timeRange = { start: startDate, end: endDate };
         
         // Generate warp profiles (2-3 alternatives)
         const profiles = generateWarpProfiles(crimes, timeRange, { profileCount: 3 });
         profiles.forEach(profile => {
           addSuggestion({
             type: 'warp-profile',
             confidence: profile.confidence,
             data: {
               name: profile.name,
               intervals: profile.intervals,
             } as WarpProfileData,
           });
         });
         
         // Generate interval boundaries (2-3 alternatives with different methods)
         const methods: BoundaryMethod[] = ['peak', 'change-point', 'rule-based'];
         methods.forEach(method => {
           const boundary = detectBoundaries(crimes, timeRange, {
             method,
             sensitivity: 'medium',
             boundaryCount: 5,
           });
           addSuggestion({
             type: 'interval-boundary',
             confidence: boundary.confidence,
             data: {
               boundaries: boundary.boundaries,
             } as IntervalBoundaryData,
           });
         });
       }, [addSuggestion]);
       ```

    4. Keep existing interface:
       - Export same UseSuggestionTriggerReturn type (for backward compatibility)
       - trigger, hasSuggestions, suggestionCount, pendingCount, mode, setMode
       - Can add new fields like lastGenerated, generationParams

    5. Key behaviors:
       - Uses viewport bounds from store for time range
       - Uses crime type filters from store
       - Generates 3 warp profiles + 3 boundary suggestions
       - Empty data: still add suggestions with low confidence OR show message (per CONTEXT.md: "Show helpful message suggesting to expand filters")
       - Re-analyze when filters change (useEffect on filter state)

    6. Optional enhancements:
       - Add generation parameters to trigger (profileCount, boundaryCount, methods)
       - Track last generation params for "modify" functionality
       - Add isGenerating state
  </action>
  <verify>
    - TypeScript compilation succeeds
    - New hook imports and uses all three algorithm modules
    - Interface matches existing useSuggestionTrigger
  </verify>
  <done>
    - useSuggestionGenerator.ts created with real algorithm integration
    - Replaces mock generation with actual crime data analysis
    - Suggestions respond to viewport and filters
  </done>
</task>

<task type="auto">
  <name>Task 2: Update timeslicing page to use new hook</name>
  <files>src/app/timeslicing/page.tsx</files>
  <action>
    Update src/app/timeslicing/page.tsx to use useSuggestionGenerator instead of useSuggestionTrigger:

    1. Change import from:
       `import { useSuggestionTrigger } from '@/hooks/useSuggestionTrigger';`
       To:
       `import { useSuggestionGenerator } from '@/hooks/useSuggestionGenerator';`

    2. Update component usage:
       - Change `const { trigger, ... } = useSuggestionTrigger()` 
       - To `const { trigger, ... } = useSuggestionGenerator()`

    The SuggestionToolbar should already call the trigger function, so this should be a simple swap.
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Page renders without errors
  </verify>
  <done>
    - Timeslicing page uses new generator hook
    - Generate button triggers real algorithm analysis
  </done>
</task>

</tasks>

<verification>
- Generate button produces real suggestions based on crime data
- Suggestions show appropriate confidence scores
- Empty data shows helpful message (in console or via store state)
- Filter changes trigger re-analysis on next generate
</verification>

<success_criteria>
Real algorithm-generated suggestions integrated into the UI. Mock generation replaced with actual crime density analysis. Multiple alternatives offered. Suggestions respond to filters.
</success_criteria>

<output>
After completion, create `.planning/phases/36-suggestion-generation/36-04-SUMMARY.md`
</output>
