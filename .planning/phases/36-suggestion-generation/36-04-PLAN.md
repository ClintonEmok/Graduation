---
phase: 36-suggestion-generation
plan: 04
type: execute
wave: 2
depends_on: [36-01, 36-02, 36-03]
files_modified: [src/hooks/useSuggestionGenerator.ts, src/app/timeslicing/components/SuggestionToolbar.tsx, src/app/timeslicing/components/SuggestionPanel.tsx, src/app/timeslicing/components/ConfidenceBadge.tsx]
autonomous: true

must_haves:
  truths:
    - "Real algorithm-generated suggestions appear in UI"
    - "Suggestions respond to active filters (crime types, time range, geographic)"
    - "Multiple alternatives offered"
    - "Empty dataset shows helpful message in UI"
    - "User can configure interval count (3-12) in UI"
    - "User can toggle snapping (hour/day/exact) in UI"
    - "Context display shows active filters (user toggle)"
    - "Low-confidence suggestions show visual warning"
  artifacts:
    - path: "src/hooks/useSuggestionGenerator.ts"
      provides: "Replace mock with real generation, pass geographic filters"
      replaces: "useSuggestionTrigger.ts mock generation"
    - path: "src/app/timeslicing/components/SuggestionToolbar.tsx"
      provides: "Interval count slider, snapping toggle"
    - path: "src/app/timeslicing/components/SuggestionPanel.tsx"
      provides: "Context display (Based on: filters)"
    - path: "src/app/timeslicing/components/ConfidenceBadge.tsx"
      provides: "Low-confidence visual warning"
---

<objective>
Integrate real generation algorithms with the suggestion system, replacing mock data with actual crime density analysis. Add all user-configurable controls per CONTEXT.md.

Purpose: Wires up the confidence-scoring, warp-generation, and interval-detection modules to the suggestion store. Makes suggestions context-aware (respond to crime types, time range, geographic filters) and handles empty data gracefully. Adds UI controls for interval count, snapping, and context display.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/hooks/useSuggestionTrigger.ts (existing mock to replace)
@src/store/useSuggestionStore.ts
@src/lib/warp-generation.ts (36-02)
@src/lib/interval-detection.ts (36-03)
@src/lib/confidence-scoring.ts (36-01)
@src/hooks/useCrimeData.ts
@src/lib/stores/viewportStore.ts (for districts filter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSuggestionGenerator hook with geographic filter</name>
  <files>src/hooks/useSuggestionGenerator.ts</files>
  <action>
    Create src/hooks/useSuggestionGenerator.ts to replace the mock generation:

    1. Rename existing useSuggestionTrigger.ts to useSuggestionGenerator.ts OR create new file (new file preferred to maintain history)

    2. Import and wire up real algorithms:
       - Import { generateWarpProfiles } from '@/lib/warp-generation'
       - Import { detectBoundaries, BoundaryMethod } from '@/lib/interval-detection'
       - Import { useCrimeData } from '@/hooks/useCrimeData'
       - Import { useSuggestionStore, type WarpProfileData, type IntervalBoundaryData } from '@/store/useSuggestionStore'
       - Import { useViewportStore, useCrimeFilters } from '@/lib/stores/viewportStore'

    3. Core generate function:
       ```typescript
       interface GenerationParams {
         intervalCount: number;  // 3-12 per CONTEXT
         snapToUnit: 'hour' | 'day' | 'none';
         boundaryMethod: BoundaryMethod;
       }

       const generateSuggestions = useCallback(async (params: GenerationParams) => {
         // Get current viewport and filters
         const { startDate, endDate } = useViewportStore.getState();
         const { crimeTypes, districts } = useViewportStore.getState().filters;
         
         // Fetch crime data for analysis - include geographic filter (districts)
         const { data: crimes } = useCrimeData({
           startEpoch: startDate,
           endEpoch: endDate,
           crimeTypes: crimeTypes.length > 0 ? crimeTypes : undefined,
           districts: districts.length > 0 ? districts : undefined,  // FIX: pass geographic filter
           bufferDays: 0,
           limit: 100000,
         });
         
         if (!crimes || crimes.length === 0) {
           // FIX: Set store flag for empty state (not console.log)
           useSuggestionStore.getState().setEmptyState(true);
           return;
         }
         
         // Clear empty state when we have data
         useSuggestionStore.getState().setEmptyState(false);
         
         const timeRange = { start: startDate, end: endDate };
         
         // Generate warp profiles with user-configurable interval count
         const profiles = generateWarpProfiles(crimes, timeRange, { 
           profileCount: 3,
           // Note: interval count can be passed if warp-generation supports it
         });
         profiles.forEach(profile => {
           addSuggestion({
             type: 'warp-profile',
             confidence: profile.confidence,
             data: {
               name: profile.name,
               intervals: profile.intervals,
             } as WarpProfileData,
           });
         });
         
         // Generate interval boundaries with user-configured options
         const boundary = detectBoundaries(crimes, timeRange, {
           method: params.boundaryMethod,
           sensitivity: 'medium',
           snapToUnit: params.snapToUnit,  // FIX: pass snapping option
           boundaryCount: params.intervalCount,  // FIX: pass user-configured count
         });
         addSuggestion({
           type: 'interval-boundary',
           confidence: boundary.confidence,
           data: {
             boundaries: boundary.boundaries,
           } as IntervalBoundaryData,
         });
       }, [addSuggestion]);
       ```

    4. Keep existing interface:
       - Export same UseSuggestionTriggerReturn type (for backward compatibility)
       - trigger, hasSuggestions, suggestionCount, pendingCount, mode, setMode
       - Add params to trigger: GenerationParams

    5. Key behaviors:
       - FIX: Uses viewport bounds from store for time range
       - FIX: Uses crime type AND geographic (districts) filters from store
       - FIX: Re-analysis is MANUAL trigger only - user clicks Generate to get new suggestions with current filters. This avoids continuous re-analysis and gives users control.
       - Empty data: sets store flag for UI to display

    6. Also add to store: setEmptyState, isEmptyState to useSuggestionStore
  </action>
  <verify>
    - TypeScript compilation succeeds
    - New hook imports and uses all three algorithm modules
    - Interface matches existing useSuggestionTrigger
    - Geographic filter (districts) is passed to useCrimeData
  </verify>
  <done>
    - useSuggestionGenerator.ts created with real algorithm integration
    - Replaces mock generation with actual crime data analysis
    - Suggestions respond to viewport, crime types, AND geographic filters
    - Interval count and snapping options are configurable
  </done>
</task>

<task type="auto">
  <name>Task 2: Add UI controls to SuggestionToolbar</name>
  <files>src/app/timeslicing/components/SuggestionToolbar.tsx</files>
  <action>
    Update SuggestionToolbar to add user-configurable controls:

    1. Add state for generation params:
       ```typescript
       const [intervalCount, setIntervalCount] = useState(5);  // default 5, range 3-12
       const [snapToUnit, setSnapToUnit] = useState<'hour' | 'day' | 'none'>('none');
       const [boundaryMethod, setBoundaryMethod] = useState<BoundaryMethod>('peak');
       ```

    2. Add interval count slider:
       - Label: "Intervals"
       - Range: 3-12 (per CONTEXT.md)
       - Shows current value

    3. Add snapping toggle:
       - Options: "Exact" | "Hour" | "Day"
       - Default: "Exact" (snapToUnit: 'none')
       - Per CONTEXT.md: "Snapping: User toggle in UI (snap to hour/day boundaries vs exact)"

    4. Add method selector for interval boundaries:
       - Dropdown or toggle group for: Peak | Change Point | Rule-based

    5. Update generate button to pass params:
       ```typescript
       const handleGenerate = () => {
         trigger({ intervalCount, snapToUnit, boundaryMethod });
       };
       ```

    6. Keep Generate button prominent - these are secondary options
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Toolbar renders with all new controls
    - Controls are styled consistently with existing UI
  </verify>
  <done>
    - SuggestionToolbar has interval count slider (3-12)
    - SuggestionToolbar has snapping toggle (Exact/Hour/Day)
    - SuggestionToolbar has method selector (Peak/Change Point/Rule-based)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add context display to SuggestionPanel</name>
  <files>src/app/timeslicing/components/SuggestionPanel.tsx</files>
  <action>
    Update SuggestionPanel to show "Based on:" context display:

    1. Import useViewportStore selectors:
       ```typescript
       import { useCrimeFilters, useViewportStart, useViewportEnd } from '@/lib/stores/viewportStore';
       ```

    2. Add state for context display toggle:
       ```typescript
       const [showContext, setShowContext] = useState(false);
       ```

    3. Add toggle button in panel header:
       - Icon: Info or Eye
       - Tooltip: "Show what's influencing suggestions"

    4. Add "Based on:" display when toggled:
       ```typescript
       {showContext && (
         <div className="mb-3 p-2 bg-slate-800 rounded text-xs">
           <div className="font-medium text-slate-300 mb-1">Based on:</div>
           <div className="text-slate-400">
             {crimeTypes.length > 0 && <span>Crime types: {crimeTypes.join(', ')}</span>}
             {crimeTypes.length === 0 && <span>All crime types</span>}
             {districts.length > 0 && <span>, Districts: {districts.join(', ')}</span>}
             {districts.length === 0 && <span>, All districts</span>}
           </div>
           <div className="text-slate-500 mt-1">
             {formatDate(startDate)} - {formatDate(endDate)}
           </div>
         </div>
       )}
       ```

    5. Handle empty state - check store for isEmptyState and show message:
       ```typescript
       const isEmpty = useSuggestionStore(state => state.isEmptyState);
       
       {isEmpty && (
         <div className="text-center py-8 text-slate-400">
           <p>No crimes found in current view.</p>
           <p className="text-sm mt-1">Try expanding your filters or time range.</p>
         </div>
       )}
       ```
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Context toggle works and shows filters
    - Empty state message appears in UI (not console)
  </verify>
  <done>
    - SuggestionPanel has context display toggle ("Based on: ...")
    - Shows active filters: crime types, districts, time range
    - Empty dataset shows helpful message in UI
  </done>
</task>

<task type="auto">
  <name>Task 4: Add low-confidence visual warning to ConfidenceBadge</name>
  <files>src/app/timeslicing/components/ConfidenceBadge.tsx</files>
  <action>
    Update ConfidenceBadge to show visual warning for low confidence:

    1. Add visual warning for confidence < 50:
       - Yellow/orange border
       - Warning icon
       - Tooltip explaining low confidence

    ```typescript
    import { AlertTriangle } from 'lucide-react';

    const LOW_CONFIDENCE_THRESHOLD = 50;

    export function ConfidenceBadge({ confidence }: ConfidenceBadgeProps) {
      const clampedConfidence = Math.max(0, Math.min(100, confidence));
      const isLowConfidence = clampedConfidence < LOW_CONFIDENCE_THRESHOLD;
      
      return (
        <span className={`
          text-sm inline-flex items-center gap-1
          ${isLowConfidence ? 'text-amber-400' : 'text-slate-300'}
        `}>
          {isLowConfidence && <AlertTriangle className="size-3" />}
          <span className="font-medium">{clampedConfidence}%</span>
          <span className="text-muted-foreground ml-1">confidence</span>
          {isLowConfidence && (
            <span className="text-amber-500/70 text-xs ml-1">(low)</span>
          )}
        </span>
      );
    }
    ```

    2. Also update SuggestionCard to add warning border:
       - When confidence < 50, add amber border to the card
       - Per CONTEXT.md: "Low-confidence: Show all suggestions with visual warning indicator"
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Badge shows warning icon when confidence < 50
    - SuggestionCard shows amber border for low confidence
  </verify>
  <done>
    - ConfidenceBadge shows warning icon for confidence < 50
    - SuggestionCard has amber border for low confidence suggestions
  </done>
</task>

<task type="auto">
  <name>Task 5: Update timeslicing page to use new hook</name>
  <files>src/app/timeslicing/page.tsx</files>
  <action>
    Update src/app/timeslicing/page.tsx to use useSuggestionGenerator instead of useSuggestionTrigger:

    1. Change import from:
       `import { useSuggestionTrigger } from '@/hooks/useSuggestionTrigger';`
       To:
       `import { useSuggestionGenerator } from '@/hooks/useSuggestionGenerator';`

    2. Update component usage:
       - Change `const { trigger, ... } = useSuggestionTrigger()` 
       - To `const { trigger, ... } = useSuggestionGenerator()`

    The SuggestionToolbar should already call the trigger function, so this should be a simple swap.
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Page renders without errors
  </verify>
  <done>
    - Timeslicing page uses new generator hook
    - Generate button triggers real algorithm analysis
  </done>
</task>

</tasks>

<verification>
- Generate button produces real suggestions based on crime data
- Suggestions show appropriate confidence scores
- Empty data shows helpful message in UI (not console)
- Filter changes reflected in "Based on:" context display
- Low confidence (<50) shows warning icon and amber border
- Interval count slider works (3-12 range)
- Snapping toggle works (Exact/Hour/Day)
- Geographic filter (districts) is passed to algorithms
</verification>

<success_criteria>
Real algorithm-generated suggestions integrated into the UI with all user controls per CONTEXT.md. Mock generation replaced with actual crime density analysis. Multiple alternatives offered. Suggestions respond to all filters (crime types, time range, geographic). All UI controls implemented (interval count, snapping, context display, low-confidence warnings).
</success_criteria>

<output>
After completion, create `.planning/phases/36-suggestion-generation/36-04-SUMMARY.md`
</output>
