---
phase: 36-suggestion-generation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/interval-detection.ts]
autonomous: true

must_haves:
  truths:
    - "Interval boundaries detected from crime density data"
    - "Multiple methods available (peak detection, change point, rule-based)"
    - "User can select method in UI"
  artifacts:
    - path: "src/lib/interval-detection.ts"
      provides: "Interval boundary detection algorithms"
      exports: ["detectBoundaries", "BoundaryMethod", "BoundaryOptions"]
---

<objective>
Create interval boundary detection algorithms that identify natural breakpoints in crime density data.

Purpose: Generate interval boundary suggestions using multiple methods. User can select method in UI per CONTEXT.md. Default sensitivity is medium. Supports snapping to hour/day boundaries.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/store/useSuggestionStore.ts (for IntervalBoundaryData type)
@src/lib/confidence-scoring.ts (36-01)
@src/types/crime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create interval-detection.ts module</name>
  <files>src/lib/interval-detection.ts</files>
  <action>
    Create src/lib/interval-detection.ts with the following:

    1. Types:
       ```typescript
       export type BoundaryMethod = 'peak' | 'change-point' | 'rule-based';
       
       export type Sensitivity = 'low' | 'medium' | 'high';
       
       export interface BoundaryOptions {
         method: BoundaryMethod;
         sensitivity: Sensitivity;  // default: 'medium'
         snapToUnit?: 'hour' | 'day' | 'none';  // default: 'none'
         boundaryCount?: number;  // target number of boundaries, 3-12 per CONTEXT
       }
       
       export interface BoundarySuggestion {
         boundaries: number[];  // epoch seconds
         method: BoundaryMethod;
         confidence: number;
         metadata: {
           peaks?: number[];
           changePoints?: number[];
           ruleBasedBoundaries?: number[];
         }
       }
       ```

    2. Functions:

       - `detectPeaks(densityBins: number[], sensitivity: Sensitivity): number[]`
         - Find peaks in density distribution
         - Sensitivity controls threshold: high = more peaks, low = only major peaks
         - Return array of peak indices

       - `detectChangePoints(densityBins: number[], sensitivity: Sensitivity): number[]`
         - Find significant density transitions
         - Use sliding window comparison
         - Sensitivity controls minimum change threshold
         - Return array of change point indices

       - `applyRuleBased(densityBins: number[], boundaryCount: number): number[]`
         - Rule-based: equal-density intervals or equal-time intervals
         - Divides range into roughly equal chunks
         - Return array of boundary indices

       - `snapToBoundary(epoch: number, unit: 'hour' | 'day'): number`
         - Snap epoch to nearest hour/day boundary
         - Used when snapToUnit option is enabled

       - `detectBoundaries(crimes: CrimeRecord[], timeRange: {start: number, end: number}, options: BoundaryOptions): BoundarySuggestion`
         - Main export function
         - Bins crimes into density histogram first
         - Calls appropriate detection method based on options.method
         - Applies sensitivity and snapping options
         - Returns BoundarySuggestion matching IntervalBoundaryData format

    3. Method details:
       - Peak detection: Find local maxima in density histogram
       - Change point: Find where density significantly shifts
       - Rule-based: Equal division (density-weighted or time-weighted)
       - Default: 5 boundaries (within 3-12 range per CONTEXT.md)

    Import confidence-scoring module for confidence calculation.
  </action>
  <verify>
    - TypeScript compilation succeeds
    - Module exports detectBoundaries, BoundaryMethod, BoundaryOptions
  </verify>
  <done>
    - interval-detection.ts exists with all detection methods
    - Supports peak, change-point, rule-based methods
    - Output matches IntervalBoundaryData format for useSuggestionStore
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- All three methods implemented
- Sensitivity and snapping options work correctly
- Handles edge cases: uniform density, single peak, empty data
</verification>

<success_criteria>
Interval boundary detection module created with peak detection, change point detection, and rule-based methods. Supports sensitivity levels and boundary snapping.
</success_criteria>

<output>
After completion, create `.planning/phases/36-suggestion-generation/36-03-SUMMARY.md`
</output>
