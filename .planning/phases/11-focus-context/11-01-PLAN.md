---
phase: 11-focus-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/viz/shaders/ghosting.ts
  - src/components/viz/DataPoints.tsx
  - src/store/useUIStore.ts
  - src/components/viz/Controls.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Selected points are fully visible and colored"
    - "Unselected context points are visible but de-emphasized (ghosted)"
    - "Context points do not cause sorting artifacts or occlusion issues"
    - "User can toggle context visibility on/off"
  artifacts:
    - path: "src/components/viz/shaders/ghosting.ts"
      provides: "Dithered transparency shader logic"
    - path: "src/store/useUIStore.ts"
      provides: "Context visibility state"
  key_links:
    - from: "src/components/viz/Controls.tsx"
      to: "src/store/useUIStore.ts"
      via: "setContextVisibility"
    - from: "src/store/useUIStore.ts"
      to: "src/components/viz/DataPoints.tsx"
      via: "uniform update"
---

<objective>
Implement advanced Focus+Context visualization using screen-door transparency (dithering) for context points and add UI controls for context visibility.

Purpose: Solve occlusion and depth-sorting issues with 1.2M transparent points while allowing users to control context density.
Output: Enhanced shader logic and UI toggle.
</objective>

<execution_context>
@src/components/viz/shaders/ghosting.ts
@src/components/viz/DataPoints.tsx
@src/store/useUIStore.ts
</execution_context>

<context>
@.planning/phases/11-focus-context/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Context State to UI Store</name>
  <files>src/store/useUIStore.ts</files>
  <action>
    Add `showContext` boolean (default true) and `toggleContext` action to `useUIStore`.
    Add `contextOpacity` number (default 0.1) if needed for fine control later (start with boolean toggle).
  </action>
  <verify>Check state exists in store</verify>
  <done>Store updated with context state</done>
</task>

<task type="auto">
  <name>Task 2: Implement Dithered Transparency in Shader</name>
  <files>src/components/viz/shaders/ghosting.ts</files>
  <action>
    Modify `ghosting.ts` fragment shader logic:
    1. Replace simple alpha blending (`gl_FragColor.a *= 0.05`) with screen-door transparency.
    2. Use `gl_FragCoord.xy` modulo pattern to discard pixels for context points.
    3. If `uShowContext` is false, discard context points entirely.
    4. Ensure focus points (selected) bypass this logic and render fully opaque.
    
    Pattern suggestion: `if (mod(gl_FragCoord.x + gl_FragCoord.y, 2.0) > 0.5) discard;` for 50% density, or sparser pattern for "faint" look.
  </action>
  <verify>Visual check of shader code</verify>
  <done>Shader logic updated for dithering</done>
</task>

<task type="auto">
  <name>Task 3: Connect DataPoints to Store</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    1. Subscribe to `showContext` from `useUIStore`.
    2. Pass `uShowContext` uniform to shader.
    3. Ensure `uHasSelection` and filtering logic correctly identifies "Focus" vs "Context" points to apply the shader rules.
  </action>
  <verify>Component passes uniforms</verify>
  <done>DataPoints connected to new state</done>
</task>

<task type="auto">
  <name>Task 4: Add Context Toggle to Controls</name>
  <files>src/components/viz/Controls.tsx</files>
  <action>
    Add a "Show Context" toggle switch or eye icon button to the Controls bar (near filters or layers).
  </action>
  <verify>UI element exists</verify>
  <done>User can toggle context</done>
</task>

</tasks>

<verification>
Manual verification required:
1. Load 1.2M dataset.
2. Select a filter (e.g., "Theft").
3. Observe that "Theft" points are solid.
4. Observe that other points are "ghosted" (dithered) and don't create a solid wall of opacity.
5. Toggle "Show Context" off -> context points disappear.
</verification>

<success_criteria>
- [ ] Context points use dithering instead of alpha blending
- [ ] Occlusion issues resolved (focus points clearly visible)
- [ ] UI toggle hides/shows context points instantly
</success_criteria>

<output>
After completion, create `.planning/phases/11-focus-context/11-01-SUMMARY.md`
</output>
