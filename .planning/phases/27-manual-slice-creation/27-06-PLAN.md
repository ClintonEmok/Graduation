---
phase: 27-manual-slice-creation
plan: 06
type: execute
wave: 5
depends_on: ["27-05"]
files_modified:
  - src/app/timeline-test/components/CommittedSliceLayer.tsx
  - src/app/timeline-test/page.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Click-created slices remain visible on the timeline after creation."
    - "Drag-created slices remain visible on the timeline after pointer release."
    - "Selecting a slice from the list highlights the same slice on the timeline."
  artifacts:
    - path: "src/app/timeline-test/components/CommittedSliceLayer.tsx"
      provides: "Persistent timeline renderer for committed slices from useSliceStore"
    - path: "src/app/timeline-test/page.tsx"
      provides: "Mounted committed slice layer with correct stack order alongside creation layer"
  key_links:
    - from: "CommittedSliceLayer"
      to: "useSliceStore.slices"
      via: "Zustand selector subscription"
      pattern: 'useSliceStore\(\(state\) => state\.slices\)'
    - from: "CommittedSliceLayer"
      to: "useSliceStore.activeSliceId"
      via: "active-slice conditional styling"
      pattern: 'activeSliceId === slice\.id'
    - from: "timeline-test/page.tsx"
      to: "CommittedSliceLayer"
      via: "absolute detail overlay mount"
      pattern: "<CommittedSliceLayer"
---

<objective>
Close the diagnosed UAT rendering gaps by adding a persistent committed-slice timeline layer that stays visible after creation and visually highlights the active slice selected from the list.

Purpose: Current creation UX only renders transient ghost previews. Once creation commits, there is no timeline consumer for persisted `useSliceStore` data, so users cannot see created slices or active selection on the timeline.

Output: A committed-slice overlay component wired into `/timeline-test` detail timeline, with active-slice highlight synced to `useSliceStore.activeSliceId`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-manual-slice-creation/27-manual-slice-creation-UAT.md
@.planning/phases/27-manual-slice-creation/27-03-SUMMARY.md
@.planning/phases/27-manual-slice-creation/27-05-SUMMARY.md
@src/app/timeline-test/page.tsx
@src/app/timeline-test/components/SliceCreationLayer.tsx
@src/store/useSliceStore.ts

Diagnosed gaps to close:
- Created slices are committed to `useSliceStore` but never rendered as persistent timeline overlays.
- Drag ghost is preview-only and disappears after commit with no committed renderer.
- List selection updates `activeSliceId`, but no timeline layer subscribes and highlights active slice.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement committed slice overlay renderer</name>
  <files>src/app/timeline-test/components/CommittedSliceLayer.tsx</files>
  <action>
    Create a dedicated committed-slice renderer for timeline detail coordinates.

    Implementation requirements:
    - Accept `scale` and `height` props (same scale contract used by `SliceCreationLayer`).
    - Subscribe to `useSliceStore((state) => state.slices)` and `useSliceStore((state) => state.activeSliceId)`.
    - Render only slices with `isVisible === true`.
    - Render range slices from `slice.range` as persistent blocks using normalized (0-100) values converted through the provided time scale domain.
    - Render point slices as a thin visible marker (minimum 2px width) so all persisted slice types remain visible.
    - Apply distinct active styling when `slice.id === activeSliceId` (stronger border/fill) and non-active styling otherwise.
    - Keep this layer display-only (`pointer-events-none`), so existing zoom/brush and creation interactions are not blocked.

    Avoid duplicating creation ghost logic from `SliceCreationLayer`; this component must render only committed store state.
  </action>
  <verify>
    `npm run lint -- src/app/timeline-test/components/CommittedSliceLayer.tsx`
  </verify>
  <done>
    - New component exists and compiles.
    - Persisted slices are mapped to visible timeline geometry from store state.
    - Active slice receives distinct highlight treatment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount committed overlay in timeline-test with correct z-order</name>
  <files>src/app/timeline-test/page.tsx</files>
  <action>
    Integrate `CommittedSliceLayer` into the existing absolute overlay stack in `/timeline-test` detail timeline container.

    Integration requirements:
    - Mount `CommittedSliceLayer` in the same detail overlay region as `SliceCreationLayer` (matching left/right/bottom/height geometry).
    - Ensure committed slices remain visible when `isCreating` is false.
    - Keep create-mode ghost preview rendered above committed slices while dragging.
    - Preserve existing pointer behavior by keeping committed overlay non-interactive and `SliceCreationLayer` interaction path intact.
    - Do not modify `useSliceCreationStore.commitCreation`; persistence path already works and should remain unchanged.
  </action>
  <verify>
    `npm run lint -- src/app/timeline-test/page.tsx src/app/timeline-test/components/CommittedSliceLayer.tsx`
  </verify>
  <done>
    - `/timeline-test` mounts a persistent committed-slice layer.
    - Newly created slices remain visible after pointer release/click commit.
    - Active slice highlight is visible on timeline when selection changes in `SliceList`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify UAT gap closure on timeline</name>
  <what-built>Persistent committed slice rendering and active-slice timeline highlighting in `/timeline-test`</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open `/timeline-test`.
    2. In create mode, click timeline once: confirm a default-duration slice remains visible after commit and appears in slice list.
    3. In create mode, drag across timeline: confirm ghost appears while dragging and committed slice remains visible after release.
    4. Click different slice names in the list: confirm timeline highlight switches to the selected slice each time.
    5. Delete a slice from the list: confirm corresponding timeline slice disappears.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or provide failing step numbers and observed behavior.</resume-signal>
</task>

</tasks>

<verification>
- Lint passes for modified files.
- Manual browser verification confirms the three diagnosed UAT truths now pass.
- No regression to create-mode ghost preview behavior.
</verification>

<success_criteria>
- Click-created slices persist visually on timeline after commit.
- Drag-created slices persist visually on timeline after release.
- List selection drives clear active highlight on timeline for the same slice id.
- Deleting slices removes both list item and timeline overlay for that slice.
</success_criteria>

<output>
After completion, create `.planning/phases/27-manual-slice-creation/27-06-SUMMARY.md`
</output>
