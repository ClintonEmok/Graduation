---
phase: 27-manual-slice-creation
plan: 03
type: execute
wave: 3
depends_on: [27-02]
files_modified:
  - src/app/timeline-test/lib/slice-utils.ts
  - src/app/timeline-test/components/SliceCreationLayer.tsx
  - src/app/timeline-test/hooks/useSliceCreation.ts
  - src/app/timeline-test/components/SliceToolbar.tsx
  - src/store/useSliceCreationStore.ts
autonomous: true
must_haves:
  truths:
    - Snap behavior can be enabled/disabled by user
    - Snap granularity adapts to zoom level (minutes/hours/days)
    - Minimum slice duration enforced (1 minute floor)
    - Maximum slice duration enforced (80% of visible range)
    - Invalid slices show red ghost with warning tooltip
    - Escape key cancels creation mid-drag
  artifacts:
    - path: src/app/timeline-test/lib/slice-utils.ts
      provides: Snap logic, duration constraints, time formatting
      exports: [snapToInterval, formatDuration, constrainDuration, SNAP_INTERVALS]
    - path: src/app/timeline-test/hooks/useSliceCreation.ts
      modified: true
      adds: [snapEnabled, snapInterval, duration constraints, keyboard handling]
  key_links:
    - from: useSliceCreation
      to: slice-utils
      via: snapToInterval and constrainDuration functions
      pattern: import.*from.*slice-utils
    - from: SliceToolbar
      to: useSliceCreationStore
      via: snap toggle state (add to store)
      pattern: snapEnabled state in store
---

<objective>
Add polish features to slice creation: optional snap-to-time behavior with zoom-adaptive granularity, minimum/maximum duration constraints with visual feedback, and keyboard escape handling. These refinements make the interaction feel professional and prevent user errors.

Purpose: Provide precise control options (snap), prevent invalid slice creation (constraints), and improve accessibility (keyboard cancel).
Output: Snap toggle, duration constraints with visual feedback, escape key support, all working in test environment
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/27-manual-slice-creation/27-RESEARCH.md
@.planning/phases/27-manual-slice-creation/27-CONTEXT.md
@.planning/phases/27-manual-slice-creation/27-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create slice utilities (snap, constraints, formatting)</name>
  <files>src/app/timeline-test/lib/slice-utils.ts</files>
  <action>
Create utility functions for snap behavior, duration constraints, and time formatting following RESEARCH.md Pattern 7.

Constants:
```typescript
export const SNAP_INTERVALS = {
  seconds: 1,
  minutes: 60,
  hours: 3600,
  days: 86400,
} as const;

export const MIN_SLICE_DURATION = 60; // 1 minute in seconds
export const MAX_SLICE_RATIO = 0.8; // 80% of visible range
```

Functions to implement:

1. snapToInterval(timestamp: number, interval: number, domainStart: number): number
   - Calculate offset from domain start
   - Round to nearest interval multiple
   - Return snapped timestamp

2. getSnapInterval(domainStart: number, domainEnd: number): number
   - Calculate visible range span
   - Return appropriate interval based on zoom level:
     - span < 1 hour (3600s): return 60 (snap to minutes)
     - span < 1 day (86400s): return 3600 (snap to hours)
     - span >= 1 day: return 86400 (snap to days)

3. constrainDuration(
     startTime: number, 
     endTime: number, 
     domainStart: number, 
     domainEnd: number
   ): { start: number; end: number; isValid: boolean; reason?: string }
   - Calculate duration in seconds
   - Check minimum: if duration < MIN_SLICE_DURATION, extend end to meet minimum
   - Check maximum: if duration > (domainEnd - domainStart) * MAX_SLICE_RATIO:
     - Clamp end time to max allowed
     - Set isValid = false with reason "Maximum duration reached"
   - Return constrained values and validity

4. formatDuration(seconds: number): string
   - Format for tooltip display
   - "2h 30m" for multi-hour durations
   - "45m" for sub-hour
   - "30s" for sub-minute (edge case)

5. formatTimeRange(start: number, end: number, minTs: number, maxTs: number): string
   - Convert normalized times to actual dates using minTs/maxTs
   - Format as "2:30 PM - 3:45 PM" or "Jan 15 2:30 PM - Jan 15 3:45 PM" if spanning days
   - Use toLocaleTimeString/toLocaleDateString for localization

All functions should be pure (no side effects) and fully typed.
  </action>
  <verify>All utility functions pass basic unit tests (manual verification in console)</verify>
  <done>Slice utilities created with snap, constraints, and formatting functions</done>
</task>

<task type="auto">
  <name>Task 2: Add snap toggle and enhance creation logic</name>
  <files>src/store/useSliceCreationStore.ts, src/app/timeline-test/hooks/useSliceCreation.ts, src/app/timeline-test/components/SliceToolbar.tsx</files>
  <action>
Add snap behavior toggle and integrate constraints into the creation flow.

Update useSliceCreationStore:
- Add snapEnabled: boolean (default true per CONTEXT.md)
- Add setSnapEnabled(enabled: boolean) action
- This state should also be transient (not persisted)

Update SliceToolbar:
- Add snap toggle button/checkbox next to mode toggle
- Label: "Snap to time" with Magnet icon (lucide-react)
- Show toggle state: amber when enabled, slate when disabled
- Only show snap toggle when in create mode
- Call setSnapEnabled on toggle

Update useSliceCreation hook:
- Import snapToInterval, getSnapInterval, constrainDuration, formatDuration, formatTimeRange
- Apply snap in onPointerMove when snapEnabled is true:
  - Get current snap interval based on visible domain
  - Snap both start and end times to interval
- Apply constraints in onPointerMove:
  - Call constrainDuration() with current preview times
  - Update ghostPosition based on constrained values
  - Pass isValid and reason through to component
- Enhance onPointerUp:
  - If !isValid, don't create slice (just cancel)
  - Or alternatively, clamp to valid range and create
  - Per CONTEXT.md: "Claude's discretion" - recommend clamping with visual feedback

Add keyboard handling:
- In useSliceCreation, add useEffect for keydown
- Listen for Escape key
- If pressed during creation, call cancelCreation()
- Clean up event listener on unmount

Update ghost rendering:
- Pass isValid and constraint reason to SliceCreationLayer
- Show red styling when invalid: bg-red-500/10, border-red-500/40
- Show warning in tooltip: "Minimum duration: 1 minute" or "Maximum duration reached"
  </action>
  <verify>Snap toggle works, constraints enforced, escape key cancels, invalid states show red</verify>
  <done>Snap behavior, constraints, and keyboard handling integrated into creation flow</done>
</task>

<task type="auto">
  <name>Task 3: Polish visual feedback and edge case handling</name>
  <files>src/app/timeline-test/components/SliceCreationLayer.tsx, src/app/timeline-test/page.tsx</files>
  <action>
Polish the creation layer with improved visual feedback and handle edge cases.

Visual improvements:
- Add cursor styling:
  - cursor-crosshair when in create mode
  - cursor-not-allowed when hovering over invalid areas
- Smooth ghost transitions:
  - Add transition-all duration-100 to ghost div
  - Reduces jitter during fast mouse movements
- Tooltip enhancements:
  - Add small arrow pointing down to ghost
  - Better positioning to avoid going off-screen
  - Show duration in addition to time range (e.g., "2:30 PM - 3:45 PM (1h 15m)")

Edge cases to handle:
1. Out-of-bounds release:
   - If user drags outside timeline and releases
   - Clamp to timeline bounds or cancel (recommend: clamp to bounds)
   - Visual indicator when near edge

2. Very short drags (< 10px but > 0):
   - These are treated as clicks (existing behavior)
   - Ensure default duration is applied correctly

3. Very long drags (> 80% of range):
   - Constrain to maximum
   - Show "Maximum duration reached" in tooltip
   - Ghost turns red

4. Rapid mode switching:
   - If user toggles mode while dragging
   - Cancel creation and reset state cleanly
   - Ensure no lingering ghost or preview

5. Window resize during creation:
   - Scales may change
   - Recalculate ghost position on resize
   - Or cancel creation (simpler)

Test page enhancements:
- Add debug info panel showing:
  - Current snap interval (e.g., "Snap: 1 hour")
  - Constraint status (valid/invalid with reason)
  - Current mode and drag state
- This helps verify the logic is working correctly

Accessibility polish:
- Add aria-label to creation overlay: "Create time slice by clicking or dragging"
- Add aria-live region for slice creation announcements
- Ensure mode toggle has proper aria-pressed state

Integration test:
- Test all combinations: click vs drag, snap on/off, valid/invalid durations
- Verify no memory leaks (event listeners cleaned up)
- Verify no console warnings
  </action>
  <verify>All edge cases handled, visual polish applied, no console errors</verify>
  <done>Creation layer polished with constraints, snap, keyboard support, and edge case handling</done>
</task>

</tasks>

<verification>
- [ ] Snap toggle visible in toolbar when in create mode
- [ ] Snap granularity adapts: minutes for zoomed-in, hours for medium, days for zoomed-out
- [ ] Minimum duration enforced (1 minute) - ghost extends or shows warning
- [ ] Maximum duration enforced (80% of range) - ghost clamps or shows warning
- [ ] Invalid duration shows red ghost with warning tooltip
- [ ] Escape key cancels creation mid-drag
- [ ] Mode switch during creation cleanly cancels
- [ ] Out-of-bounds drag clamps to timeline bounds
- [ ] Duration shown in tooltip alongside time range
- [ ] Debug panel shows snap interval and constraint status
- [ ] No console errors or warnings
</verification>

<success_criteria>
Polish complete when:
1. User can enable/disable snap behavior
2. Snap granularity automatically adapts to zoom level
3. Duration constraints prevent invalid slices with clear visual feedback
4. Escape key provides keyboard alternative to cancel
5. Edge cases (out-of-bounds, mode switch, resize) handled gracefully
6. Visual feedback is smooth and professional
7. All interactions work reliably in test environment
</success_criteria>

<output>
After completion, create `.planning/phases/27-manual-slice-creation/27-03-SUMMARY.md`
</output>
