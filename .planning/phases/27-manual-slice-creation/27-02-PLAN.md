---
phase: 27-manual-slice-creation
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - src/app/timeline-test/lib/dom-vector.ts
  - src/app/timeline-test/components/SliceCreationLayer.tsx
  - src/app/timeline-test/hooks/useSliceCreation.ts
  - src/app/timeline-test/page.tsx
autonomous: true
must_haves:
  truths:
    - User can click on timeline to create slice with default duration
    - User can drag on timeline to create slice with custom duration
    - Ghost preview shows during drag with time range tooltip
    - 10px drag threshold prevents accidental drag triggers
    - setPointerCapture prevents zoom/brush conflicts during creation
    - Slice appears immediately on pointer up
  artifacts:
    - path: src/app/timeline-test/hooks/useSliceCreation.ts
      provides: Creation interaction logic with drag handling
      exports: [useSliceCreation, DRAG_THRESHOLD]
    - path: src/app/timeline-test/components/SliceCreationLayer.tsx
      provides: Ghost preview rendering and event handling
      min_lines: 80
  key_links:
    - from: useSliceCreation hook
      to: useSliceCreationStore
      via: startCreation, updatePreview, commitCreation actions
      pattern: useSliceCreationStore\(state\)
    - from: SliceCreationLayer
      to: useSliceCreation
      via: handlers (onPointerDown, onPointerMove, onPointerUp)
      pattern: const { handlers } = useSliceCreation\(scale, containerRef\)
    - from: SliceCreationLayer
      to: DualTimeline scales
      via: scale prop (D3 scaleTime)
      pattern: scale={detailXScale}
---

<objective>
Implement the core slice creation interaction: click-to-create with default duration, drag-to-create with custom range, ghost preview with tooltip, and proper conflict resolution with existing zoom/brush. This is the heart of the manual slice creation feature.

Purpose: Enable users to actually create time slices through direct manipulation of the timeline, with clear visual feedback and no interaction conflicts.
Output: Working slice creation in test environment, ghost preview, proper event handling
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/27-manual-slice-creation/27-RESEARCH.md
@.planning/phases/27-manual-slice-creation/27-CONTEXT.md
@src/app/timeline-test/page.tsx
@src/components/timeline/DualTimeline.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DOMVector utility and useSliceCreation hook</name>
  <files>src/app/timeline-test/lib/dom-vector.ts, src/app/timeline-test/hooks/useSliceCreation.ts</files>
  <action>
Create the DOMVector utility class and the useSliceCreation hook following RESEARCH.md Patterns 2, 3, and 6.

DOMVector class (src/app/timeline-test/lib/dom-vector.ts):
```typescript
export class DOMVector {
  constructor(
    readonly x: number,
    readonly y: number,
    readonly magnitudeX: number,
    readonly magnitudeY: number
  ) {}

  toDOMRect(): DOMRect {
    return new DOMRect(
      Math.min(this.x, this.x + this.magnitudeX),
      Math.min(this.y, this.y + this.magnitudeY),
      Math.abs(this.magnitudeX),
      Math.abs(this.magnitudeY)
    );
  }

  getDiagonalLength(): number {
    return Math.sqrt(
      Math.pow(this.magnitudeX, 2) + Math.pow(this.magnitudeY, 2)
    );
  }
}
```

useSliceCreation hook (src/app/timeline-test/hooks/useSliceCreation.ts):
- Signature: useSliceCreation(scale: ScaleTime<number, number>, containerRef: RefObject<HTMLElement>)
- Returns: { isCreating, isDragging, ghostPosition, currentRange, handlers: { onPointerDown, onPointerMove, onPointerUp } }
- DRAG_THRESHOLD = 10 (pixels)

Hook logic:
1. onPointerDown:
   - Only active when useSliceCreationStore.isCreating is true
   - Call e.currentTarget.setPointerCapture(e.pointerId) to prevent zoom/brush conflicts
   - Store drag start position and time (normalized 0-100)
   - Initialize isDraggingRef to false

2. onPointerMove:
   - Calculate drag vector from start to current position
   - If !isDragging and vector.getDiagonalLength() >= DRAG_THRESHOLD, set isDragging = true
   - If isDragging, update preview in store with start/end times
   - Calculate ghostPosition (x, width in pixels) for visual feedback

3. onPointerUp:
   - If !isDragging (was a click):
     - Calculate default duration: 10% of visible time range
     - Create slice centered on click point
   - If isDragging (was a drag):
     - Use drag start/end as slice boundaries
   - Call commitCreation() to finalize
   - Release pointer capture
   - Reset drag state

Time calculations:
- Use scale.invert(pixelX) to get Date, convert to normalized time 0-100
- Default duration: (domainEnd - domainStart) * 0.1 (10% of visible range)
- Store times in normalized format (consistent with useSliceStore)
  </action>
  <verify>Hook compiles, DOMVector works correctly, time calculations match expected behavior</verify>
  <done>DOMVector utility and useSliceCreation hook exist with full drag handling logic</done>
</task>

<task type="auto">
  <name>Task 2: Create ghost preview component</name>
  <files>src/app/timeline-test/components/SliceCreationLayer.tsx</files>
  <action>
Create the SliceCreationLayer component that renders the ghost preview and handles pointer events. Follow RESEARCH.md Pattern 5 for ghost visualization.

Component requirements:
- Props:
  - scale: ScaleTime<number, number> - D3 time scale for coordinate conversion
  - height: number - height of the timeline area
  - containerRef: RefObject<HTMLElement> - reference to parent for measurements

- Render layers:
  1. Transparent overlay rect covering timeline area (captures pointer events)
  2. Ghost preview div (only when dragging or in preview state):
     - Positioned absolutely based on ghostPosition from useSliceCreation
     - Amber styling: bg-amber-500/20, border-2 border-amber-500/60
     - Rounded corners: rounded-sm
     - Minimum width: 2px (visible even for short durations)
  3. Duration tooltip above ghost:
     - Shows formatted time range (e.g., "2:30 PM - 3:45 PM")
     - Amber background when valid: bg-amber-500 text-white
     - Centered above ghost with -top-8 and -translate-x-1/2
     - Only visible when isDragging is true

- Event handling:
  - Attach onPointerDown, onPointerMove, onPointerUp from useSliceCreation hook
  - Use the transparent overlay rect as event target
  - The rect should have cursor styling: cursor-crosshair when in create mode

- Conditional rendering:
  - Only render when useSliceCreationStore.isCreating is true
  - When not in create mode, return null (no overhead)

Visual polish:
- Smooth transitions on ghost position changes: transition-all duration-75
- Z-index should be above timeline content but below tooltips (z-10)
- Pointer events on ghost should be none (pointer-events-none)
  </action>
  <verify>Component renders, ghost appears during drag, tooltip shows time range</verify>
  <done>Creation layer component with ghost preview, tooltip, and event handling</done>
</task>

<task type="auto">
  <name>Task 3: Integrate creation layer into test page</name>
  <files>src/app/timeline-test/page.tsx</files>
  <action>
Integrate the SliceCreationLayer into the test page, positioning it over the DualTimeline component.

Integration steps:
1. Import SliceCreationLayer component
2. Add a container ref for the timeline section (useRef<HTMLDivElement>)
3. Get the detail X scale from DualTimeline (needs to be exposed or accessed)
4. Render SliceCreationLayer inside a positioned container:
   ```tsx
   <div className="relative rounded-md border border-slate-700/70 bg-slate-950/60 p-3">
     <DualTimeline />
     <SliceCreationLayer 
       scale={detailScale}
       height={DETAIL_HEIGHT}
       containerRef={timelineContainerRef}
     />
   </div>
   ```

Scale access challenge:
- DualTimeline manages its own scales internally
- Options:
  a) Expose scale via ref from DualTimeline
  b) Duplicate scale calculation in test page (simpler for testing)
  c) Create a shared scale hook
- For test environment, duplicate the scale calculation using the same domain/range as DualTimeline's detail view

Default duration calculation:
- Calculate from filter store's selectedTimeRange or data store's min/max
- Use same formula as in useSliceCreation: 10% of visible range

Testing checklist:
- [ ] Click "Create Slice" to enter creation mode
- [ ] Click on timeline creates slice with default duration (10% of visible range)
- [ ] Drag on timeline creates slice with custom duration matching drag extent
- [ ] Ghost preview appears during drag
- [ ] Tooltip shows formatted time range
- [ ] Slice appears in list immediately on pointer up
- [ ] New slice is automatically selected (highlighted in list)
- [ ] Zoom/brush don't interfere when in create mode (pointer capture working)
- [ ] Exit create mode via "Cancel" button
  </action>
  <verify>All interaction tests pass, slices create correctly via click and drag</verify>
  <done>Creation layer integrated, click and drag both create slices, ghost preview works</done>
</task>

</tasks>

<verification>
- [ ] Click on timeline creates slice with ~10% of visible range duration
- [ ] Drag on timeline creates slice matching drag extent
- [ ] Ghost preview shows amber region during drag
- [ ] Tooltip displays formatted start/end times above ghost
- [ ] 10px drag threshold prevents accidental triggers (small movements = click)
- [ ] setPointerCapture prevents zoom/brush from activating during creation
- [ ] Slice appears in list immediately on pointer up
- [ ] New slice is automatically selected
- [ ] Cancel button exits create mode cleanly
- [ ] No console errors during interactions
</verification>

<success_criteria>
Interaction complete when:
1. User can create slices by clicking (default duration) or dragging (custom range)
2. Ghost preview provides clear visual feedback during drag
3. Tooltip shows time range in human-readable format
4. 10px threshold correctly distinguishes clicks from drags
5. Pointer capture prevents conflicts with zoom/brush
6. Slices appear immediately and are auto-selected
7. All SLICE-01 through SLICE-05 requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/27-manual-slice-creation/27-02-SUMMARY.md`
</output>
