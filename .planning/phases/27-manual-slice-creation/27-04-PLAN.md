---
phase: 27-manual-slice-creation
plan: 04
type: execute
wave: 1
depends_on: ["27-03"]
files_modified:
  - src/store/useSliceCreationStore.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can click on timeline to create a slice with default duration"
    - "Click-created slices persist as range slices (type: 'range') with valid start/end"
    - "Slice displays in slice list with correct time range labels"
  artifacts:
    - path: "src/store/useSliceCreationStore.ts"
      provides: "commitCreation function creates range slices for both click and drag modes"
      exports: ["useSliceCreationStore"]
  key_links:
    - from: "useSliceCreationStore.commitCreation"
      to: "useSliceStore.addSlice"
      via: "createdSlice with type: 'range' and range property"
      pattern: "type: 'range'.*range: \[previewStart, previewEnd\]"
---

<objective>
Fix click-to-create slice persistence so that clicking on the timeline creates a proper range slice with default duration, instead of incorrectly persisting as a point slice.

Purpose: The current implementation computes a valid duration range in `onPointerUp` for click mode, but `commitCreation` in the store always creates a point slice when `creationMode === 'click'`, discarding the computed end boundary. This gap breaks the core requirement of creating time slices via click.

Output: Updated `useSliceCreationStore` where `commitCreation` correctly persists range slices for both click and drag modes when `previewEnd !== null`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-manual-slice-creation/27-03-SUMMARY.md

**Gap Context from VERIFICATION.md:**
- Truth: "User can click on timeline to create a slice with default duration"
- Status: Failed - Click path computes duration but stores as point slice
- Root cause: `commitCreation()` only creates range slices when `creationMode === 'drag'`
- Location: src/store/useSliceCreationStore.ts, lines 105-138

**Current commitCreation Logic (buggy):**
```typescript
const hasRange = creationMode === 'drag' && previewEnd !== null && previewEnd !== previewStart;
const createdSlice: TimeSlice = hasRange
  ? { type: 'range', range: [previewStart, previewEnd], ... }
  : { type: 'point', time: previewStart, ... };
```

**Current click-mode onPointerUp behavior (correctly computes range):**
The click path in useSliceCreation.ts computes a constrained duration:
```typescript
const defaultDurationSec = Math.max(MIN_SLICE_DURATION, (domainEndSec - domainStartSec) * 0.1);
const halfDuration = defaultDurationSec / 2;
const constrained = constrainDuration(clickSec - halfDuration, clickSec + halfDuration, ...);
updatePreviewFromSeconds(constrained.start, constrained.end, ...);
```
This correctly updates preview with start/end, but commit ignores previewEnd for click mode.

**Fix Strategy:**
Change `hasRange` logic to check if `previewEnd !== null && previewEnd !== previewStart` regardless of creation mode. Both click and drag should create range slices when there's a valid range in the preview.

**Type Reference:**
```typescript
interface TimeSlice {
  id: string;
  name: string;
  type: 'point' | 'range';
  time: number;  // normalized 0-100
  range?: [number, number];  // for type: 'range'
  isLocked: boolean;
  isVisible: boolean;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix commitCreation to persist range slices for click mode</name>
  <files>src/store/useSliceCreationStore.ts</files>
  <action>
    Modify the `commitCreation` function in `useSliceCreationStore.ts` to correctly persist range slices for both click and drag modes.

    Current buggy logic (lines 115-133):
    ```typescript
    const hasRange = creationMode === 'drag' && previewEnd !== null && previewEnd !== previewStart;
    const createdSlice: TimeSlice = hasRange
      ? {
          id,
          name: sliceName,
          type: 'range',
          time: previewStart,
          range: [previewStart, previewEnd],
          isLocked: false,
          isVisible: true,
        }
      : {
          id,
          name: sliceName,
          type: 'point',
          time: previewStart,
          isLocked: false,
          isVisible: true,
        };
    ```

    Fix by removing the `creationMode === 'drag'` check:
    ```typescript
    const hasRange = previewEnd !== null && previewEnd !== previewStart;
    ```

    This ensures that whenever the preview has a valid range (which happens for both click and drag modes), a range slice is created. Click mode correctly sets previewEnd via `updatePreviewFromSeconds` in `onPointerUp`, so the range data is available - it was just being ignored by the creationMode check.

    Keep all other logic unchanged (ID generation, naming, reset state, etc.).
  </action>
  <verify>
    1. Review the modified code in src/store/useSliceCreationStore.ts
    2. Confirm `hasRange` logic is: `previewEnd !== null && previewEnd !== previewStart`
    3. Verify both click and drag paths now create range slices when previewEnd exists
  </verify>
  <done>
    - commitCreation creates range slices for both click and drag modes
    - Point slice creation only happens when previewEnd is null or equals previewStart
    - All existing tests (if any) still pass
  </done>
</task>

</tasks>

<verification>
**Manual verification in browser:**
1. Open the timeline-test page
2. Enter "Create" mode by clicking the Create button in the toolbar
3. Click on the timeline (do NOT drag)
4. Verify a slice appears in the slice list
5. Verify the slice shows a time range label (e.g., "Jan 15 - Jan 20") not just a single time point
6. Verify in browser console that the created slice has `type: 'range'` and a valid `range` array

**Code verification:**
```typescript
// Expected slice structure after click:
{
  id: "...",
  name: "Slice N",
  type: "range",           // NOT "point"
  time: 45.2,              // start normalized position
  range: [45.2, 55.2],     // [start, end] with default duration
  isLocked: false,
  isVisible: true
}
```
</verification>

<success_criteria>
- [ ] Clicking on timeline creates a range slice with valid start/end boundaries
- [ ] Slice displays correct time range in slice list (not just single time point)
- [ ] Slice type is 'range' (can verify in component state or console)
- [ ] Drag-to-create continues to work correctly (regression test)
</success_criteria>

<output>
After completion, create `.planning/phases/27-manual-slice-creation/27-04-SUMMARY.md`
</output>
