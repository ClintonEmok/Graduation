---
phase: 17-cluster-highlighting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/store/useClusterStore.ts, src/components/viz/ClusterManager.tsx]
autonomous: true

must_haves:
  truths:
    - "System identifies dense clusters using spatial-temporal proximity"
    - "Clustering state is globally accessible via useClusterStore"
  artifacts:
    - path: "src/store/useClusterStore.ts"
      provides: "Cluster state and actions"
    - path: "src/components/viz/ClusterManager.tsx"
      provides: "DBSCAN logic and data processing"
  key_links:
    - from: "src/components/viz/ClusterManager.tsx"
      to: "src/store/useDataStore.ts"
      via: "filteredData subscription"
---

<objective>
Implement the core clustering engine using DBSCAN to identify high-density regions in the Space-Time Cube.

Purpose: To provide the analytical foundation for cluster highlighting.
Output: A new store for cluster data and a manager component that performs the calculations.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cluster-highlighting/17-RESEARCH.md
@src/store/useDataStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup & Store</name>
  <files>package.json, src/store/useClusterStore.ts</files>
  <action>
    1. Install `ml-dbscan` using `pnpm install ml-dbscan --legacy-peer-deps`.
    2. Create `src/store/useClusterStore.ts`.
    3. Define `Cluster` type: { id, center: [x,y,z], size: [w,h,d], count, dominantType, color }.
    4. Implement store with `clusters: Cluster[]`, `enabled: boolean`, `sensitivity: number (0-1)`, and `selectedClusterId: string | null`.
  </action>
  <verify>Check package.json for ml-dbscan and verify useClusterStore exports the defined types and store.</verify>
  <done>Store is functional and package is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Clustering Engine</name>
  <files>src/components/viz/ClusterManager.tsx</files>
  <action>
    1. Create `ClusterManager` component that subscribes to `useDataStore` (filteredData) and `useClusterStore` (sensitivity, enabled).
    2. Implement debounced clustering logic (300-500ms) using `ml-dbscan`.
    3. Weighted distance: Scale spatial X/Z by 1.0 and temporal Y by 0.5 (or vice-versa per Research) to emphasize spatial co-location.
    4. Calculate Cluster metadata: Bounding box (min/max for all 3 axes), point count, and dominant crime type (most frequent `typeId`).
    5. Update `useClusterStore` with the detected clusters.
  </action>
  <verify>Log the number of detected clusters to console and verify they change when filters or sensitivity change.</verify>
  <done>Clusters are calculated and stored based on visible data points.</done>
</task>

</tasks>

<verification>
Verify that clusters are being calculated by checking console logs or using React DevTools to inspect useClusterStore.
</verification>

<success_criteria>
- ml-dbscan is installed.
- useClusterStore manages cluster state.
- ClusterManager calculates clusters from filteredData and updates the store.
</success_criteria>

<output>
After completion, create `.planning/phases/17-cluster-highlighting/17-01-SUMMARY.md`
</output>
