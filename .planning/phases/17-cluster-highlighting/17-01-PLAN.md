---
phase: 17-cluster-highlighting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/store/useClusterStore.ts, src/store/useDataStore.ts, src/components/viz/ClusterManager.tsx]
autonomous: true

must_haves:
  truths:
    - "System identifies dense clusters using spatial-temporal proximity"
    - "Clustering state is globally accessible via useClusterStore"
    - "Clusters include geographic bounds for cross-view synchronization"
  artifacts:
    - path: "src/store/useClusterStore.ts"
      provides: "Cluster state and actions"
    - path: "src/components/viz/ClusterManager.tsx"
      provides: "DBSCAN logic and data processing"
  key_links:
    - from: "src/components/viz/ClusterManager.tsx"
      to: "src/store/useDataStore.ts"
      via: "getFilteredData selector"
---

<objective>
Implement the core clustering engine using DBSCAN to identify high-density regions in the Space-Time Cube.

Purpose: To provide the analytical foundation for cluster highlighting.
Output: A new store for cluster data, a manager component for calculations, and a filtered data selector.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cluster-highlighting/17-RESEARCH.md
@src/store/useDataStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup, Store & Data Selector</name>
  <files>package.json, src/store/useClusterStore.ts, src/store/useDataStore.ts</files>
  <action>
    1. Install `ml-dbscan` using `pnpm install ml-dbscan --legacy-peer-deps`.
    2. Create `src/store/useClusterStore.ts`. Define `Cluster` type: { id, center: [x,y,z], size: [w,h,d], count, dominantType, color, minLat, maxLat, minLon, maxLon }.
    3. Implement store with `clusters: Cluster[]`, `enabled: boolean`, `sensitivity: number (0-1)`, and `selectedClusterId: string | null`.
    4. In `src/store/useDataStore.ts`, implement a `getFilteredData` selector that returns an array of points filtered by current `useFilterStore` state (Type, District, Time Range) for CPU-side clustering.
  </action>
  <verify>Check package.json for ml-dbscan. Verify useClusterStore exports and useDataStore has the filtered data logic.</verify>
  <done>Store is functional and CPU-side filtered data is available.</done>
</task>

<task type="auto">
  <name>Task 2: Clustering Engine</name>
  <files>src/components/viz/ClusterManager.tsx</files>
  <action>
    1. Create `ClusterManager` component that subscribes to `useDataStore` (filtered data), `useClusterStore` (sensitivity, enabled), and `useUIStore` (adaptive mode).
    2. Implement debounced clustering logic (300-500ms) using `ml-dbscan`.
    3. **Adaptive Awareness:** When Adaptive Mode is enabled, use `adaptiveYValues` for the Y coordinate of points to ensure clustering reflects the visual representation.
    4. Weighted distance: Scale spatial X/Z by 1.0 and temporal Y by 0.5 to emphasize spatial co-location.
    5. Calculate Cluster metadata: 3D Bounding box, point count, dominant crime type, and geographic bounds (minLat/maxLat/minLon/maxLon) by mapping points back to their raw coordinates using `lat/lon` from `useDataStore`.
    6. Update `useClusterStore` with the detected clusters.
  </action>
  <verify>Log the number of detected clusters to console. Verify they include geographic bounds and update when mode/filters change.</verify>
  <done>Clusters are calculated and stored based on visible data points with adaptive-time awareness.</done>
</task>

</tasks>

<verification>
Verify that clusters are being calculated by checking console logs or using React DevTools to inspect useClusterStore. Ensure geo-bounds are present in cluster objects.
</verification>

<success_criteria>
- ml-dbscan is installed.
- useClusterStore manages cluster state with geo-bounds.
- getFilteredData is correctly implemented for CPU usage.
- ClusterManager calculates clusters using adaptive Y positions when mode is enabled.
</success_criteria>

<output>
After completion, create `.planning/phases/17-cluster-highlighting/17-01-SUMMARY.md`
</output>
