---
phase: 17-cluster-highlighting
plan: 03
type: execute
wave: 3
depends_on: [17-02]
files_modified: [src/components/viz/SliceManagerUI.tsx, src/components/viz/MainScene.tsx, src/components/map/MapVisualization.tsx, src/components/viz/ClusterLabels.tsx]
autonomous: true

must_haves:
  truths:
    - "User can toggle cluster highlighting and adjust sensitivity"
    - "Clicking a cluster label zooms the camera to focus on it"
    - "Selected cluster is highlighted on the 2D map"
  artifacts:
    - path: "src/components/viz/SliceManagerUI.tsx"
      provides: "Cluster sensitivity and toggle controls"
  key_links:
    - from: "src/components/viz/ClusterLabels.tsx"
      to: "camera-controls"
      via: "fitToBox animation"
---

<objective>
Integrate cluster controls into the UI and implement interactive navigation and cross-view synchronization.

Purpose: To allow users to control and explore clusters.
Output: UI updates and interaction logic for focus and map sync.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-cluster-highlighting/17-02-SUMMARY.md
@src/components/viz/SliceManagerUI.tsx
@src/components/viz/MainScene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: UI Controls & Integration</name>
  <files>src/components/viz/SliceManagerUI.tsx, src/components/viz/MainScene.tsx</files>
  <action>
    1. In `SliceManagerUI.tsx`, add a "Clusters" section (using a new "Target" or "Zap" icon from lucide-react).
    2. Add a Toggle for "Enable Clustering".
    3. Add a Slider for "Cluster Sensitivity" (linked to `sensitivity` in `useClusterStore`).
    4. In `MainScene.tsx`, add `<ClusterManager />`, `<ClusterHighlights />`, and `<ClusterLabels />`.
    5. **Feature Flag Gate:** Ensure clustering components in `MainScene.tsx` are gated by a check for `isEnabled('clustering')` (Requirement CLUSTER-04).
  </action>
  <verify>Check that the UI controls appear and toggling clustering shows/hides the 3D highlights. Verify the feature flag gating works by toggling 'clustering' in Settings.</verify>
  <done>User can control clustering parameters from the UI and feature is gated by flags.</done>
</task>

<task type="auto">
  <name>Task 2: Click to Focus & Map Sync</name>
  <files>src/components/viz/ClusterLabels.tsx, src/components/map/MapVisualization.tsx</files>
  <action>
    1. In `ClusterLabels.tsx`, add an `onClick` handler to the HTML badges.
    2. When clicked, set `selectedClusterId` in the store and use `camera-controls` `fitToBox` to zoom into the cluster's AABB.
    3. In `src/components/map/MapVisualization.tsx`, subscribe to `useClusterStore`.
    4. If a cluster is selected (or for all clusters if enabled), render a 2D bounding rectangle on the map representing the cluster's geographic bounds (`minLat/maxLat/minLon/maxLon`).
  </action>
  <verify>Clicking a label zooms the camera smoothly. A rectangle appears on the map corresponding to the cluster's geographic location.</verify>
  <done>Interactive navigation and cross-view synchronization are functional.</done>
</task>

</tasks>

<verification>
Test the full flow: Enable clustering, adjust sensitivity, click a cluster label to focus, and verify the map shows the cluster boundary.
</verification>

<success_criteria>
- Clusters can be toggled and tuned from the UI.
- Clicking a cluster zooms the 3D camera to it.
- The map view shows corresponding boundaries for clusters.
- All clustering visuals are gated by the 'clustering' feature flag.
</success_criteria>

<output>
After completion, create `.planning/phases/17-cluster-highlighting/17-03-SUMMARY.md`
</output>
