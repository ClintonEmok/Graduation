---
phase: 29-remake-burstlist-as-first-class-slices
plan: 03
type: execute
wave: 2
depends_on: [29-01]
files_modified:
  - src/components/viz/BurstList.tsx
  - src/components/timeline/DualTimeline.tsx
autonomous: true

must_haves:
  truths:
    - Clicking burst list item creates or selects corresponding slice
    - Clicking burst overlay on timeline creates or selects slice
    - Burst click focuses timeline to slice range
    - Burst-slice mapping is bidirectional
  artifacts:
    - path: src/components/viz/BurstList.tsx
      provides: Burst list with slice creation/selection
      contains: addBurstSlice|setActiveSlice
    - path: src/components/timeline/DualTimeline.tsx
      provides: Timeline burst overlay with slice integration
      contains: handleBurstClick.*slice|addBurstSlice
  key_links:
    - from: BurstList.handleSelectWindow
      to: useSliceStore.addBurstSlice
      via: burst window -> slice conversion
      pattern: addBurstSlice.*window
    - from: DualTimeline.handleBurstClick
      to: useSliceStore
      via: burst rect index -> slice lookup
---

<objective>
Wire up burst interactions to create or select slices, unifying burst and slice selection models.

Purpose: Make burst interactions feel like slice operations - clicking a burst should work exactly like clicking a slice.
Output: Updated BurstList and DualTimeline components with integrated slice management.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/29-remake-burstlist-as-first-class-slices/29-CONTEXT.md

@src/components/viz/BurstList.tsx
@src/components/timeline/DualTimeline.tsx
@src/store/useSliceStore.ts

## Context from 29-CONTEXT.md

### Selection and focus behavior
- Clicking a burst that already has a mapped slice selects that slice and focuses timeline to its range
- Clicking a burst with no mapped slice creates it and sets it active immediately
- Keep a single active-slice model shared across manual and burst-derived slices
- Keep burst overlay highlight synchronized with the active matching slice range

## Current BurstList Behavior

Currently:
1. Click toggles burst window in `selectedBurstWindows` (coordination store)
2. Sets time range and brush to burst window
3. Opens details panel

Needs to change to:
1. Create or find matching slice via `addBurstSlice`
2. Set that slice as active
3. Focus timeline to slice range
4. (Optional) Still open details panel

## Current DualTimeline Behavior

Currently has burst overlay rendering:
- Shows burst rectangles on timeline
- Clicking toggles burst selection via `toggleBurstWindow`
- Needs to create/select slice instead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BurstList to create/select slices</name>
  <files>src/components/viz/BurstList.tsx</files>
  <action>
Rewrite BurstList click handler to use slice store instead of coordination store:

1. Import from slice store:
   ```typescript
   import { useSliceStore } from '@/store/useSliceStore';
   ```

2. Replace coordination store usage:
   - Remove: `toggleBurstWindow`, `selectedBurstWindows`
   - Add: `addBurstSlice`, `setActiveSlice`, `activeSliceId`

3. Rewrite handleSelectWindow:
   ```typescript
   const handleSelectWindow = (window: BurstWindow) => {
     // Create or get existing slice for this burst
     const slice = addBurstSlice({ start: window.start, end: window.end });
     
     if (slice) {
       // Set as active (select it)
       setActiveSlice(slice.id);
       
       // Focus timeline to slice range
       if (minTimestampSec !== null && maxTimestampSec !== null) {
         const startEpoch = normalizedToEpochSeconds(window.start, minTimestampSec, maxTimestampSec);
         const endEpoch = normalizedToEpochSeconds(window.end, minTimestampSec, maxTimestampSec);
         setTimeRange([startEpoch, endEpoch]);
         const startNorm = epochSecondsToNormalized(startEpoch, minTimestampSec, maxTimestampSec);
         const endNorm = epochSecondsToNormalized(endEpoch, minTimestampSec, maxTimestampSec);
         const range: [number, number] = [startNorm, endNorm];
         setRange(range);
         setBrushRange(range);
         setTime((range[0] + range[1]) / 2);
       } else {
         const range: [number, number] = [window.start, window.end];
         setTimeRange(range);
         setRange(range);
         setBrushRange(range);
         setTime((range[0] + range[1]) / 2);
       }
       
       // Open details panel
       setDetailsOpen(true);
     }
   };
   ```

4. Update selection indicator:
   - Current: checks `selectedBurstWindows`
   - New: check if there's a slice matching this burst window AND it's active
   - Use `findMatchingSlice` to check for existing slice
   - Show selected if `slice && slice.id === activeSliceId`

5. Keep burst list rendering the same (shows top 10 bursts)

6. Clean up unused imports after changes

Edge case: What if addBurstSlice returns null?
- Shouldn't happen with current implementation
- Add defensive check just in case
  </action>
  <verify>Click burst list item -> creates slice, selects it, focuses timeline</verify>
  <done>BurstList creates/selects slices on click, removes coordination store dependency for burst selection</done>
</task>

<task type="auto">
  <name>Task 2: Update DualTimeline burst overlay</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>
Update DualTimeline burst click handler to work with slices:

1. Import from slice store:
   ```typescript
   import { useSliceStore } from '@/store/useSliceStore';
   ```

2. Add slice store selectors:
   ```typescript
   const addBurstSlice = useSliceStore((state) => state.addBurstSlice);
   const setActiveSlice = useSliceStore((state) => state.setActiveSlice);
   const activeSliceId = useSliceStore((state) => state.activeSliceId);
   const findMatchingSlice = useSliceStore((state) => state.findMatchingSlice);
   ```

3. Rewrite handleBurstClick:
   ```typescript
   const handleBurstClick = useCallback(
     (event: React.MouseEvent, index: number) => {
       event.stopPropagation();
       const window = burstWindows[index];
       if (!window) return;
       
       // Create or get existing slice
       const slice = addBurstSlice({ start: window.start, end: window.end });
       
       if (slice) {
         setActiveSlice(slice.id);
         
         // Focus to burst range (same logic as BurstList)
         applyRangeToStores(window.start, window.end);
         setTime((window.start + window.end) / 2);
       }
     },
     [addBurstSlice, setActiveSlice, burstWindows, applyRangeToStores, setTime]
   );
   ```

4. Update burst overlay selection styling:
   - Current: checks `selectedBurstWindows`
   - New: check if matching slice exists and is active
   ```typescript
   const isSelected = (() => {
     const slice = findMatchingSlice(window.start, window.end);
     return slice && slice.id === activeSliceId;
   })();
   ```

5. Keep burst overlay rendering (rectangles) the same

6. Clean up coordination store imports if no longer needed for bursts
   - Keep if used for other purposes

Note: DualTimeline may still use coordination store for other features (brush, etc.), only remove burst-specific usage.
  </action>
  <verify>Click timeline burst overlay -> creates/selects slice, highlights correctly</verify>
  <done>DualTimeline burst overlay creates/selects slices, selection syncs with slice store</done>
</task>

<task type="auto">
  <name>Task 3: Add timeline focus utility</name>
  <files>src/lib/slice-utils.ts, src/components/viz/BurstList.tsx, src/components/timeline/DualTimeline.tsx</files>
  <action>
Extract common timeline focus logic into a reusable utility:

1. Create focus utility in slice-utils.ts:
   ```typescript
   import { useTimeStore } from '@/store/useTimeStore';
   import { useFilterStore } from '@/store/useFilterStore';
   import { useCoordinationStore } from '@/store/useCoordinationStore';
   import { normalizedToEpochSeconds, epochSecondsToNormalized } from './time-domain';
   import { useDataStore } from '@/store/useDataStore';

   interface FocusRangeOptions {
     start: number; // normalized
     end: number;   // normalized
     minTimestampSec: number | null;
     maxTimestampSec: number | null;
   }

   /**
    * Focus timeline to a specific normalized range
    * Updates time stores, filter range, brush, and centers time
    */
   export function focusTimelineRange(options: FocusRangeOptions): void {
     const { start, end, minTimestampSec, maxTimestampSec } = options;
     
     // Get store setters
     const { setTimeRange } = useFilterStore.getState();
     const { setRange, setTime } = useTimeStore.getState();
     const { setBrushRange } = useCoordinationStore.getState();
     
     if (minTimestampSec !== null && maxTimestampSec !== null) {
       // Convert to epoch, set filter range, convert back
       const startEpoch = normalizedToEpochSeconds(start, minTimestampSec, maxTimestampSec);
       const endEpoch = normalizedToEpochSeconds(end, minTimestampSec, maxTimestampSec);
       setTimeRange([startEpoch, endEpoch]);
       
       const startNorm = epochSecondsToNormalized(startEpoch, minTimestampSec, maxTimestampSec);
       const endNorm = epochSecondsToNormalized(endEpoch, minTimestampSec, maxTimestampSec);
       const range: [number, number] = [startNorm, endNorm];
       setRange(range);
       setBrushRange(range);
       setTime((range[0] + range[1]) / 2);
     } else {
       // No data domain, use normalized directly
       const range: [number, number] = [start, end];
       setTimeRange(range);
       setRange(range);
       setBrushRange(range);
       setTime((range[0] + range[1]) / 2);
     }
   }
   ```

2. Update BurstList to use utility:
   ```typescript
   import { focusTimelineRange } from '@/lib/slice-utils';
   
   // In handleSelectWindow:
   focusTimelineRange({
     start: window.start,
     end: window.end,
     minTimestampSec,
     maxTimestampSec
   });
   ```

3. Update DualTimeline to use utility (if similar logic exists)

This reduces code duplication and ensures consistent focus behavior.
  </action>
  <verify>BurstList and DualTimeline both use focusTimelineRange utility</verify>
  <done>Timeline focus logic consolidated in utility, both components use it</done>
</task>

</tasks>

<verification>
After all tasks:
- [ ] Clicking burst list item creates/selects slice
- [ ] Clicking timeline burst overlay creates/selects slice
- [ ] Timeline focuses to burst/slice range
- [ ] Selection state syncs between burst visual and slice
- [ ] No longer using selectedBurstWindows from coordination store
</verification>

<success_criteria>
- Burst interactions create first-class slices
- Selection model unified (single active slice)
- Timeline focus works from both entry points
- Code deduplicated with utility function
</success_criteria>

<output>
After completion, create `.planning/phases/29-remake-burstlist-as-first-class-slices/29-03-SUMMARY.md`
</output>
