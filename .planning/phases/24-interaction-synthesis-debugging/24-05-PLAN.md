---
phase: 24-interaction-synthesis-debugging
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/viz/RaycastLine.tsx
  - src/components/viz/DataPoints.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Visual raycast line appears on click in 3D view"
    - "Raycast line renders from camera position to click point"
    - "Raycast line fades out after short delay (~500ms)"
    - "Line appears only on actual point clicks (not drags or misses)"
  artifacts:
    - path: "src/components/viz/RaycastLine.tsx"
      provides: "Visual raycast line component"
      exports: ["RaycastLine"]
      features:
        - "Line from camera to target point"
        - "Fade-out animation"
        - "Temporary display (auto-remove)"
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Integrates RaycastLine on click"
      changes: "Conditionally renders RaycastLine with camera and click point data"
  key_links:
    - from: "DataPoints.tsx"
      to: "RaycastLine"
      via: "onPointerUp event handler"
      pattern: "{clickValid && <RaycastLine ... />}"
    - from: "RaycastLine"
      to: "Three.js scene"
      via: "useThree hook for camera position"
      pattern: "useThree\(\).camera"
---

<objective>
Create a visual raycast line that appears when clicking in the 3D view, providing visual feedback showing the ray from camera to click point.

Purpose: Close the gap where raycasting logic exists but no visual feedback is shown when clicking in the 3D Space-Time Cube.
Output: RaycastLine component that renders a temporary line from camera to click point, integrated into DataPoints click handling.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/24-interaction-synthesis-debugging/24-03-SUMMARY.md
@.planning/phases/24-interaction-synthesis-debugging/24-VERIFICATION.md

@src/components/viz/DataPoints.tsx

## Gap Context (from VERIFICATION.md)

**Truth:** "Visual raycast line appears on click"
**Status:** failed
**Reason:** No raycast line visualization component exists. DataPoints has robust click handling with raycasting, but no visual feedback (line) is rendered when clicking.

**Missing:**
- RaycastLine component or similar visual indicator
- Line rendering from camera to click point in 3D scene
- Temporary visual feedback on click (fade out animation)

**Gap File Locations:**
- DataPoints.tsx lines 356-358, 394: has raycasting logic but no visual line rendering
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RaycastLine component</name>
  <files>src/components/viz/RaycastLine.tsx</files>
  <action>
    Create a new RaycastLine component that renders a temporary line from camera to click point.
    
    1. Create file at src/components/viz/RaycastLine.tsx
    
    2. Component interface:
       ```typescript
       interface RaycastLineProps {
         start: THREE.Vector3;  // Camera position
         end: THREE.Vector3;    // Click point in 3D space
         onComplete?: () => void;  // Callback when animation completes
       }
       ```
    
    3. Implementation requirements:
       - Use @react-three/fiber's useThree hook to get camera if needed
       - Use Line component from @react-three/drei OR create a custom line using THREE.Line
       - Animate opacity from 1.0 to 0.0 over ~500ms using useFrame
       - Call onComplete when animation finishes to allow parent to remove the component
       - Line color: use a bright color like cyan (#00ffff) or yellow (#ffff00) for visibility
       - Line width: 2-3 pixels
    
    4. Example structure:
       ```typescript
       export const RaycastLine: React.FC<RaycastLineProps> = ({ start, end, onComplete }) => {
         const [opacity, setOpacity] = useState(1.0);
         const lineRef = useRef<THREE.Line>(null);
         
         useFrame((_, delta) => {
           setOpacity(prev => {
             const next = prev - delta * 2; // Fade out over ~500ms
             if (next <= 0) {
               onComplete?.();
               return 0;
             }
             return next;
           });
         });
         
         return (
           <line ref={lineRef}>
             <bufferGeometry>
               <bufferAttribute
                 attach="attributes-position"
                 args={[new Float32Array([start.x, start.y, start.z, end.x, end.y, end.z]), 3]}
               />
             </bufferGeometry>
             <lineBasicMaterial color="#00ffff" transparent opacity={opacity} />
           </line>
         );
       };
       ```
    
    5. Alternative using @react-three/drei (if available):
       ```typescript
       import { Line } from '@react-three/drei';
       
       export const RaycastLine: React.FC<RaycastLineProps> = ({ start, end, onComplete }) => {
         const [opacity, setOpacity] = useState(1.0);
         
         useFrame((_, delta) => {
           setOpacity(prev => {
             const next = prev - delta * 2;
             if (next <= 0) {
               onComplete?.();
               return 0;
             }
             return next;
           });
         });
         
         return (
           <Line
             points={[start, end]}
             color="#00ffff"
             lineWidth={2}
             transparent
             opacity={opacity}
           />
         );
       };
       ```
    
    IMPORTANT: Check if @react-three/drei is available in the project. If not, use the custom line approach.
  </action>
  <verify>
    - File src/components/viz/RaycastLine.tsx exists
    - Component exports RaycastLine
    - Component accepts start, end, and optional onComplete props
    - Uses useFrame for fade-out animation
    - Line fades from opacity 1.0 to 0.0 over ~500ms
    - Calls onComplete callback when fade completes
  </verify>
  <done>
    RaycastLine component created that renders a line from start to end point, fades out over 500ms, and notifies parent when animation completes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate RaycastLine into DataPoints click handling</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Modify DataPoints.tsx to show RaycastLine when clicking on a point.
    
    1. Add state to track raycast line:
       ```typescript
       const [raycastLine, setRaycastLine] = useState<{
         start: THREE.Vector3;
         end: THREE.Vector3;
         key: number; // Force re-render on new clicks
       } | null>(null);
       ```
    
    2. Import RaycastLine component at top of file:
       ```typescript
       import { RaycastLine } from './RaycastLine';
       ```
    
    3. Import useThree hook from @react-three/fiber to get camera:
       ```typescript
       import { useFrame, RootState, useThree } from '@react-three/fiber';
       ```
    
    4. Get camera in component:
       ```typescript
       const { camera } = useThree();
       ```
    
    5. Modify handlePointerUp callback (around line 372-426) to show raycast line on successful click:
       ```typescript
       const handlePointerUp = useCallback(
         (event: { stopPropagation: () => void; clientX?: number; clientY?: number; instanceId?: number; point?: THREE.Vector3 }) => {
           event.stopPropagation();
           
           // ... existing drag detection logic ...
           
           if (typeof event.instanceId !== 'number') {
             console.log('[Raycast] No instanceId on click event');
             return;
           }
           
           // Show raycast line if we have a click point
           if (event.point && camera) {
             setRaycastLine({
               start: camera.position.clone(),
               end: event.point.clone(),
               key: Date.now() // Force new component instance on each click
             });
           }
           
           // ... rest of existing click handling ...
         },
         [setSelectedIndex, colLinearY, data, slices, setActiveSlice, camera]
       );
       ```
       
       IMPORTANT: Add camera to the dependency array.
    
    6. Add RaycastLine rendering in the JSX return (before or after instancedMesh):
       ```typescript
       return (
         <>
           {raycastLine && (
             <RaycastLine
               key={raycastLine.key}
               start={raycastLine.start}
               end={raycastLine.end}
               onComplete={() => setRaycastLine(null)}
             />
           )}
           <instancedMesh
             ref={meshRef}
             // ... existing props ...
           >
             // ... existing geometry and material ...
           </instancedMesh>
         </>
       );
       ```
    
    7. Wrap the return in a React Fragment (<>...</>) since we're adding a sibling element.
    
    IMPORTANT: Make sure to:
    - Only show raycast line when event.point exists (actual hit)
    - Use camera.position as start point
    - Clone vectors to avoid reference issues
    - Use key prop to force new RaycastLine instance on each click
    - Clear raycastLine state in onComplete callback
  </action>
  <verify>
    - DataPoints.tsx imports RaycastLine component
    - DataPoints.tsx has raycastLine state with proper typing
    - handlePointerUp sets raycastLine state when clicking on a point
    - JSX renders RaycastLine conditionally when raycastLine state exists
    - RaycastLine receives camera.position as start and event.point as end
    - onComplete callback clears raycastLine state
  </verify>
  <done>
    DataPoints.tsx shows a visual raycast line from camera to click point whenever a point is clicked in the 3D view. The line fades out automatically and is removed after animation completes.
  </done>
</task>

</tasks>

<verification>
## Verification Steps

1. **Code Review:**
   - RaycastLine.tsx exists and exports RaycastLine component
   - RaycastLine uses useFrame for fade-out animation
   - DataPoints.tsx imports and uses RaycastLine
   - handlePointerUp sets raycastLine state on click
   - JSX conditionally renders RaycastLine

2. **Runtime Test:**
   - Load the application with data
   - Open browser and 3D view
   - Click on a point in the 3D Space-Time Cube
   - Verify a colored line appears from camera direction to the clicked point
   - Verify the line fades out over ~500ms
   - Click multiple points rapidly - each should show its own line

3. **Edge Cases:**
   - Click and drag (should NOT show line - drag detection prevents this)
   - Click on empty space (should NOT show line - only shows on point hits)
   - Rapid clicking (each click should show a new line)
</verification>

<success_criteria>
- RaycastLine component exists and renders a line between two 3D points
- RaycastLine fades opacity from 1.0 to 0.0 over ~500ms
- RaycastLine calls onComplete callback when fade animation finishes
- DataPoints.tsx shows RaycastLine on every successful point click
- Line appears from camera position to the clicked point in 3D space
- Line automatically disappears after fade-out animation
- Click-and-drag gestures do NOT show the raycast line (drag detection works)
</success_criteria>

<output>
After completion, create `.planning/phases/24-interaction-synthesis-debugging/24-05-SUMMARY.md` with:
- Summary of RaycastLine component implementation
- Integration details in DataPoints.tsx
- Confirmation that visual raycast feedback now works
- Any issues encountered or notes for future reference
</output>
