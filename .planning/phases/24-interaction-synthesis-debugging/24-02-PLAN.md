---
phase: 24-interaction-synthesis-debugging
plan: 02
type: execute
wave: 2
depends_on: [24-01]
files_modified: [src/components/viz/DataPoints.tsx, src/components/viz/shaders/ghosting.ts]
autonomous: true
must_haves:
  truths:
    - "3D clicks are robust and reliable"
    - "Visual raycast line appears on click"
  artifacts:
    - path: "src/components/viz/shaders/ghosting.ts"
      provides: "Updated shader logic"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/components/viz/shaders/ghosting.ts"
      via: "onBeforeCompile"
---

<objective>
Fix 3D click targeting and implement visual debugging.
Purpose: Address the "clicks are failing" issue with a multi-pronged approach (visuals + tolerance).
Output: Reliable 3D selection.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/viz/DataPoints.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug Raycasting</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Enhance `DataPoints.tsx` interaction:
    1. Add `Raycaster` visualization (optional helper or just logging).
    2. Check `onPointerDown` vs `onClick`. `onClick` is often better for selection, `onPointerDown` for drag start. Switch to `onClick` if not dragging.
    3. Ensure `frustumCulled={false}` is set (already is).
    4. Check if `sphereGeometry` radius matches visual size.
    
    Fix Strategy:
    - Add a specialized `RaycastDebug` component (if needed) or just log hit distance.
    - Increase `threshold` if using `Points` (but we use `InstancedMesh` with spheres, so geometry raycasting applies).
    - Ensure `pointerEvents` are not blocked by overlay divs (CSS check).
  </action>
  <verify>
    Clicking logs hit.
  </verify>
  <done>Clicks register reliably.</done>
</task>

<task type="auto">
  <name>Task 2: Update Shader for Ghosting</name>
  <files>src/components/viz/shaders/ghosting.ts</files>
  <action>
    Update `ghosting.ts` (or `DataPoints` onBeforeCompile):
    - Add `uBrushStart` and `uBrushEnd`.
    - Logic: `if (vLinearY < uBrushStart || vLinearY > uBrushEnd) opacity *= 0.1;`
    - This implements the "Dim others" decision.
  </action>
  <verify>
    Shader compiles.
  </verify>
  <done>Context dimming works.</done>
</task>

</tasks>

<verification>
- Clicks work.
- Dimming works.
</verification>

<success_criteria>
- 3D interaction is fixed.
</success_criteria>

<output>
After completion, create `.planning/phases/24-interaction-synthesis-debugging/24-02-SUMMARY.md`
</output>
