---
phase: 24-interaction-synthesis-debugging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/components/viz/DataPoints.tsx, src/components/timeline/TimelineBrush.tsx, src/store/useCoordinationStore.ts]
autonomous: true
must_haves:
  truths:
    - "Clicking a point in 3D scrolls timeline to that point"
    - "Selecting a range in timeline dims unselected points"
    - "Clicking in map selects point in 3D and timeline"
  artifacts:
    - path: "src/store/useCoordinationStore.ts"
      provides: "Central selection state"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/store/useCoordinationStore.ts"
      via: "setSelectedIndex"
---

<objective>
Synchronize interactions between Map, Timeline, and 3D Cube.
Purpose: Ensure selection state propagates correctly and visual feedback is consistent (Focus + Context).
Output: Unified selection logic and visual updates.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/24-interaction-synthesis-debugging/24-CONTEXT.md
@src/store/useCoordinationStore.ts
@src/components/viz/DataPoints.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Coordination Store</name>
  <files>src/store/useCoordinationStore.ts</files>
  <action>
    Update `useCoordinationStore` to broadcast changes more effectively if needed, or simply ensure it's the single source of truth.
    
    Add an effect hook or mechanism (maybe in `Controls` or `MainScene` later) to sync:
    - When `selectedIndex` changes -> Update `useTimeStore` to center the timeline on that point's time.
    - This logic might belong in a new `InteractionController` component or hook, but `useCoordinationStore` is the state holder.
    
    Let's keep the store simple and add a hook `useSelectionSync` in Plan 03.
    For now, ensure the store exports what we need. It looks good.
  </action>
  <verify>
    Store structure verified.
  </verify>
  <done>Store is ready.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Focus+Context in 3D</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    Update `DataPoints.tsx` shader logic for "Focus + Context".
    
    Current state: Filters (removes) points based on time range.
    New state:
    - Pass `uTimeRange` as uniform.
    - In shader: If point is OUTSIDE time range, render it with `uContextOpacity` (ghosted) instead of discarding.
    - If point is INSIDE, render normally.
    - Use `useTimeStore` to get the brush range.
    
    Steps:
    1. Pass `uBrushStart` and `uBrushEnd` uniforms (normalized time).
    2. Modify fragment shader (via `onBeforeCompile`) to apply ghosting alpha if outside range.
  </action>
  <verify>
    Check shader injection logic.
  </verify>
  <done>3D view dims instead of hides.</done>
</task>

</tasks>

<verification>
- Store exists.
- DataPoints accepts time range uniforms.
</verification>

<success_criteria>
- Selection state is centralized.
- 3D view supports ghosting context.
</success_criteria>

<output>
After completion, create `.planning/phases/24-interaction-synthesis-debugging/24-01-SUMMARY.md`
</output>
