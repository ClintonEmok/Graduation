---
phase: 16-heatmap-layer
plan: 03
type: execute
wave: 3
depends_on: [02]
files_modified: [src/components/viz/MainScene.tsx, src/components/map/MapVisualization.tsx]
autonomous: true

must_haves:
  truths:
    - "Heatmap is visible in the 3D Cube view when enabled"
    - "Heatmap is visible in the Map View panel"
    - "Heatmap transparency (60%) allows map details to remain visible"
  artifacts:
    - path: "src/components/viz/MainScene.tsx"
      provides: "Heatmap integration into main 3D scene"
    - path: "src/components/map/MapVisualization.tsx"
      provides: "Heatmap overlay on the map panel"
---

<objective>
Integrate the HeatmapOverlay into the application's view panels, ensuring visibility on both the Map and Cube views as required.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/viz/MainScene.tsx
@src/components/map/MapVisualization.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate into 3D Cube Scene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Add the `HeatmapOverlay` component to the Three.js `Scene` in `MainScene.tsx`. 
    - Ensure it is positioned correctly relative to the points and ground.
    - Gate rendering with both the `heatmap` feature flag and the store's `isEnabled` toggle.
  </action>
  <verify>Heatmap is visible at the base of the 3D Cube view.</verify>
  <done>Heatmap provides spatial context in the 3D view.</done>
</task>

<task type="auto">
  <name>Task 2: Add Three.js Overlay to Map Panel</name>
  <files>src/components/map/MapVisualization.tsx</files>
  <action>
    Add a Three.js `Canvas` overlay to `MapVisualization.tsx` to host the heatmap:
    - Overlay the canvas over `MapBase`.
    - Synchronize the Three.js camera with the `maplibre-gl` view state (zoom, center).
    - Render `HeatmapOverlay` within this canvas.
    - Set opacity to 60% and use additive blending to ensure map labels/features remain visible underneath.
  </action>
  <verify>Heatmap aligns perfectly with map features and updates as the map is panned/zoomed.</verify>
  <done>Heatmap provides a spatial "footprint" directly on the map panel.</done>
</task>

</tasks>

<verification>
1. Open the Layers menu and enable Heatmap.
2. Confirm the heatmap appears in the 3D Cube view.
3. Confirm the heatmap appears on the Map view and aligns with the data points.
4. Verify that panning the map also pans the heatmap overlay.
</verification>

<success_criteria>
1. Heatmap overlay is functional in both Map and Cube views.
2. Heatmap correctly reflects the 2D spatial distribution of filtered points.
3. Performance remains stable with the heatmap enabled (>30fps).
</success_criteria>

<output>
After completion, create `.planning/phases/16-heatmap-layer/16-03-SUMMARY.md`
</output>
