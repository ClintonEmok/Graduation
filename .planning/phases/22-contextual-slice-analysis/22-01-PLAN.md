---
phase: 22-contextual-slice-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/store/useSliceStore.ts, src/hooks/useSliceStats.ts]
autonomous: true
must_haves:
  truths:
    - "Store tracks active inspected slice"
    - "Hook calculates stats for a given slice"
    - "Stats include type and district counts"
  artifacts:
    - path: "src/store/useSliceStore.ts"
      provides: "Inspect state"
    - path: "src/hooks/useSliceStats.ts"
      provides: "Calculation logic"
  key_links:
    - from: "src/hooks/useSliceStats.ts"
      to: "src/store/useDataStore.ts"
      via: "columns access"
---

<objective>
Establish the data foundation for contextual slice analysis.
Purpose: Create the state management for "inspection" and the calculation logic for aggregating slice statistics.
Output: Updated store and new hook for stats.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/22-contextual-slice-analysis/22-RESEARCH.md
@src/store/useSliceStore.ts
@src/store/useDataStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Slice Store</name>
  <files>src/store/useSliceStore.ts</files>
  <action>
    Update `useSliceStore` to include inspection state.
    
    Add fields:
    - `activeSliceId: string | null` (The currently open/focused slice)
    - `setActiveSlice: (id: string | null) => void`
    
    Add persistence logic if needed, or keep it ephemeral.
    Ensure `addSlice` automatically sets the new slice as active (as per Context decision: "Auto-opens on creation").
  </action>
  <verify>
    Check types and exports.
  </verify>
  <done>Store updated with active state.</done>
</task>

<task type="auto">
  <name>Task 2: Create Slice Stats Hook</name>
  <files>src/hooks/useSliceStats.ts</files>
  <action>
    Create `src/hooks/useSliceStats.ts`.
    
    Logic:
    - Accept `sliceId` as argument.
    - Retrieve `slice` from `useSliceStore`.
    - Retrieve `columns` from `useDataStore`.
    - Use `useMemo` to iterate over `columns` (if both exist).
    - Filter points within slice bounds (time point +/- small epsilon, or time range).
    - Aggregate counts by `type` (using `getCrimeType(id)`) and `district` (using `getDistrict(id)`).
    - Return `{ typeCounts, districtCounts, totalCount, isLoading }`.
    
    Optimization:
    - Ensure it doesn't block main thread for too long (limit iteration or use `requestIdleCallback` pattern if really needed, but standard loop is usually fine for <1M).
  </action>
  <verify>
    File created.
  </verify>
  <done>Hook exists and logic implemented.</done>
</task>

</tasks>

<verification>
Check that the hook imports correctly and types align with `useDataStore`.
</verification>

<success_criteria>
- State exists to track "which slice is open".
- Logic exists to count "what is in the slice".
</success_criteria>

<output>
After completion, create `.planning/phases/22-contextual-slice-analysis/22-01-SUMMARY.md`
</output>
