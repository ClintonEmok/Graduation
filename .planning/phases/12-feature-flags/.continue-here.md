---
phase: 12-feature-flags
plan: 02
task: 1
total_tasks: 2
status: in_progress
last_updated: 2026-02-04T21:23:24Z
preferred_model: google/gemini-3-pro-high
---

<current_state>
Phase 12 Plan 02 (Settings Panel UI) is in progress. Task 1 is partially complete - the `useDraggable` hook has been created, but `FloatingToolbar.tsx` has not yet been created, and `Controls.tsx` has not been modified to re-export it.

Two files are staged (untracked) but not yet committed:
- `src/hooks/useDraggable.ts` - Complete, matches the plan exactly
- `src/components/ui/label.tsx` - Created as a dependency for Task 2
</current_state>

<completed_work>

- Plan 01: Feature Flags Store Infrastructure - Done (committed as d001570, 696f25e)
  - Installed shadcn UI components (Sheet, Tabs, Switch, Badge, AlertDialog)
  - Created `useFeatureFlagsStore` with Zustand persist middleware
  - Defined 6 feature flags covering Phases 14-19
  - Implemented batch edit support (pendingFlags pattern)

- Plan 02 Task 1: useDraggable Hook - Partially done
  - Created `src/hooks/useDraggable.ts` (complete, untracked)
  - Created `src/components/ui/label.tsx` (dependency for Task 2, untracked)
  - NOT created: `src/components/viz/FloatingToolbar.tsx`
  - NOT modified: `src/components/viz/Controls.tsx` (re-export)
</completed_work>

<remaining_work>

- Plan 02 Task 1 (Current): Create FloatingToolbar and update Controls.tsx
  - Create `src/components/viz/FloatingToolbar.tsx` per plan spec
  - Update `src/components/viz/Controls.tsx` to re-export FloatingToolbar
  - Run `pnpm tsc --noEmit` to verify

- Plan 02 Task 2: Create SettingsPanel with Batch Edit
  - Create `src/components/settings/FeatureFlagItem.tsx`
  - Create `src/components/settings/SettingsPanel.tsx`
  - Verify tabs, switches, badges, batch save workflow

- Plan 03: URL Sharing (3 tasks)
  - Create `useURLFeatureFlags` hook
  - Create `URLConflictDialog` component
  - Wire up Share button and conflict dialog
  - Human verification checkpoint
</remaining_work>

<decisions_made>

- Batch edit pattern: `pendingFlags` enables staging changes until Save button clicked
- `isEnabled()` returns pending value during editing for live preview
- Manual shadcn component creation required due to pnpm/React 19 compatibility issues
- `partialize` excludes `pendingFlags` from localStorage persistence
</decisions_made>

<blockers>
None - all blocking issues from Plan 01 were resolved.
</blockers>

<context>
The Feature Flags system is designed to control visibility of experimental visualization modes in Phases 14-19 (Color Schemes, Time Slices, Heatmap, Cluster Highlighting, Trajectories, Aggregated Bins).

Plan 01 established the store infrastructure with Zustand + localStorage persistence. The key innovation is the batch edit pattern - users make changes in the Settings panel, see them previewed via `isEnabled()`, then either Save (apply to store) or Cancel (discard pending).

Plan 02 is building the UI: a draggable floating toolbar with a gear icon that opens the Settings sheet. The `useDraggable` hook (already created) handles drag-and-drop with position persistence.

Plan 03 will add URL sharing so researchers can share specific configurations via encoded URL parameters.
</context>

<next_action>
Start with: Create `src/components/viz/FloatingToolbar.tsx` following the exact code in 12-02-PLAN.md Task 1 (lines 197-288). It imports `useDraggable`, `SettingsPanel`, and existing components (`FilterOverlay`, `useUIStore`).

After creating FloatingToolbar, update `Controls.tsx` to be a simple re-export:
```typescript
'use client';
export { FloatingToolbar as Controls } from './FloatingToolbar';
```

Then run `pnpm tsc --noEmit` to verify (note: it will fail until SettingsPanel exists in Task 2, so you may need to create a stub or proceed to Task 2 immediately).
</next_action>
