---
phase: 12-feature-flags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/useFeatureFlagsStore.ts
  - src/lib/feature-flags.ts
  - src/components/ui/sheet.tsx
  - src/components/ui/tabs.tsx
  - src/components/ui/switch.tsx
  - src/components/ui/badge.tsx
  - src/components/ui/alert-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Feature flags store exists with localStorage persistence"
    - "Flag definitions are typed and centralized"
    - "shadcn UI components are installed and available"
  artifacts:
    - path: "src/store/useFeatureFlagsStore.ts"
      provides: "Feature flags state with Zustand persist"
      exports: ["useFeatureFlagsStore"]
      contains: "persist"
    - path: "src/lib/feature-flags.ts"
      provides: "Centralized flag definitions with categories and defaults"
      exports: ["FLAG_DEFINITIONS", "getDefaultFlags", "FeatureFlag"]
    - path: "src/components/ui/sheet.tsx"
      provides: "Sheet component for settings panel"
    - path: "src/components/ui/switch.tsx"
      provides: "Switch component for toggles"
  key_links:
    - from: "src/store/useFeatureFlagsStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist.*name.*feature-flags"
    - from: "src/lib/feature-flags.ts"
      to: "src/store/useFeatureFlagsStore.ts"
      via: "getDefaultFlags used for reset"
      pattern: "getDefaultFlags"
---

<objective>
Create the core feature flags infrastructure: Zustand store with localStorage persistence, centralized flag definitions, and install required shadcn UI components.

Purpose: Establishes the foundation that the Settings panel (Plan 02) and URL sharing (Plan 03) will build upon. This is the data layer for feature flag management.

Output:
- useFeatureFlagsStore.ts with batch edit support
- feature-flags.ts with typed flag definitions
- shadcn components installed (sheet, tabs, switch, badge, alert-dialog)
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-feature-flags/12-RESEARCH.md

# Existing pattern to follow
@src/store/useLayoutStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn UI Components</name>
  <files>
    src/components/ui/sheet.tsx
    src/components/ui/tabs.tsx
    src/components/ui/switch.tsx
    src/components/ui/badge.tsx
    src/components/ui/alert-dialog.tsx
  </files>
  <action>
Run the shadcn CLI to install required components:

```bash
pnpm dlx shadcn@latest add sheet tabs switch badge alert-dialog
```

These components provide:
- **Sheet:** Side panel for settings (slides from right)
- **Tabs:** Organize flags by category
- **Switch:** Toggle switches for flags
- **Badge:** Status indicators (experimental/beta/stable)
- **AlertDialog:** Confirmation for destructive flag disables
  </action>
  <verify>
All component files exist in `src/components/ui/`:
- `ls src/components/ui/sheet.tsx`
- `ls src/components/ui/tabs.tsx`
- `ls src/components/ui/switch.tsx`
- `ls src/components/ui/badge.tsx`
- `ls src/components/ui/alert-dialog.tsx`
  </verify>
  <done>
All 5 shadcn components installed and importable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Feature Flags Store and Definitions</name>
  <files>
    src/store/useFeatureFlagsStore.ts
    src/lib/feature-flags.ts
  </files>
  <action>
**Create `src/lib/feature-flags.ts`** with typed flag definitions:

```typescript
export type FeatureCategory = 'visualization' | 'experimental' | 'accessibility';
export type FeatureStatus = 'stable' | 'beta' | 'experimental';

export interface FeatureFlag {
  id: string;
  name: string;
  description: string;
  category: FeatureCategory;
  status: FeatureStatus;
  default: boolean;
  destructive?: boolean; // If true, show confirmation on disable
}

// Define all feature flags for Phases 12-19
export const FLAG_DEFINITIONS: FeatureFlag[] = [
  // Phase 14: Color Schemes
  {
    id: 'colorSchemes',
    name: 'Color Schemes',
    description: 'Enable palette switching (default, colorblind-safe, dark)',
    category: 'accessibility',
    status: 'stable',
    default: false,
  },
  // Phase 15: Time Slices
  {
    id: 'timeSlices',
    name: 'Time Slices',
    description: 'Show horizontal planes at specific time values',
    category: 'visualization',
    status: 'experimental',
    default: false,
    destructive: true, // User may have positioned slices
  },
  // Phase 16: Heatmap Layer
  {
    id: 'heatmap',
    name: 'Heatmap Layer',
    description: '2D density overlay on map panel',
    category: 'visualization',
    status: 'experimental',
    default: false,
  },
  // Phase 17: Cluster Highlighting
  {
    id: 'clusterHighlight',
    name: 'Cluster Highlighting',
    description: 'Auto-detect and label dense regions',
    category: 'visualization',
    status: 'experimental',
    default: false,
  },
  // Phase 18: Trajectories
  {
    id: 'trajectories',
    name: 'Trajectories',
    description: 'Connected paths showing event sequences',
    category: 'visualization',
    status: 'experimental',
    default: false,
  },
  // Phase 19: Aggregated Bins (LOD)
  {
    id: 'aggregatedBins',
    name: 'Aggregated Bins (LOD)',
    description: '3D bars instead of points at far zoom',
    category: 'experimental',
    status: 'experimental',
    default: false,
  },
];

export function getDefaultFlags(): Record<string, boolean> {
  return FLAG_DEFINITIONS.reduce((acc, flag) => {
    acc[flag.id] = flag.default;
    return acc;
  }, {} as Record<string, boolean>);
}

export function getFlagsByCategory(category: FeatureCategory): FeatureFlag[] {
  return FLAG_DEFINITIONS.filter((f) => f.category === category);
}
```

**Create `src/store/useFeatureFlagsStore.ts`** following the useLayoutStore.ts pattern:

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { getDefaultFlags } from '@/lib/feature-flags';

interface FeatureFlagsState {
  flags: Record<string, boolean>;
  pendingFlags: Record<string, boolean> | null;
  
  // Direct flag access
  isEnabled: (flagId: string) => boolean;
  
  // Batch edit operations (for Settings panel)
  startEditing: () => void;
  setPendingFlag: (id: string, enabled: boolean) => void;
  applyPendingFlags: () => void;
  discardPendingFlags: () => void;
  
  // Utilities
  resetToDefaults: () => void;
  applyURLFlags: (urlFlags: Record<string, boolean>) => void;
  hasPendingChanges: () => boolean;
}

export const useFeatureFlagsStore = create<FeatureFlagsState>()(
  persist(
    (set, get) => ({
      flags: getDefaultFlags(),
      pendingFlags: null,
      
      isEnabled: (flagId) => {
        const { flags, pendingFlags } = get();
        // During editing, show pending value if exists
        if (pendingFlags !== null && flagId in pendingFlags) {
          return pendingFlags[flagId];
        }
        return flags[flagId] ?? false;
      },
      
      startEditing: () => {
        set({ pendingFlags: { ...get().flags } });
      },
      
      setPendingFlag: (id, enabled) => {
        const { pendingFlags } = get();
        if (pendingFlags === null) return;
        set({ pendingFlags: { ...pendingFlags, [id]: enabled } });
      },
      
      applyPendingFlags: () => {
        const { pendingFlags } = get();
        if (pendingFlags === null) return;
        set({ flags: pendingFlags, pendingFlags: null });
      },
      
      discardPendingFlags: () => {
        set({ pendingFlags: null });
      },
      
      resetToDefaults: () => {
        set({ flags: getDefaultFlags(), pendingFlags: null });
      },
      
      applyURLFlags: (urlFlags) => {
        set((state) => ({
          flags: { ...state.flags, ...urlFlags },
        }));
      },
      
      hasPendingChanges: () => {
        const { flags, pendingFlags } = get();
        if (pendingFlags === null) return false;
        return Object.keys(pendingFlags).some(
          (key) => pendingFlags[key] !== flags[key]
        );
      },
    }),
    {
      name: 'feature-flags-v1',
      partialize: (state) => ({ flags: state.flags }), // Only persist flags, not pending
    }
  )
);
```

Key design decisions:
- `pendingFlags` enables batch editing (changes staged until Save)
- `isEnabled()` returns pending value during editing for live preview
- `partialize` excludes `pendingFlags` from persistence
- `applyURLFlags` separate method for URL override flow
  </action>
  <verify>
```bash
# Check files exist and have expected exports
grep -l "useFeatureFlagsStore" src/store/useFeatureFlagsStore.ts
grep -l "FLAG_DEFINITIONS" src/lib/feature-flags.ts
grep -l "persist" src/store/useFeatureFlagsStore.ts

# TypeScript compiles
pnpm tsc --noEmit
```
  </verify>
  <done>
- useFeatureFlagsStore exports store with batch edit support
- feature-flags.ts exports FLAG_DEFINITIONS, getDefaultFlags, types
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. All 5 shadcn components exist in `src/components/ui/`
2. `useFeatureFlagsStore` exists with `persist` middleware
3. `FLAG_DEFINITIONS` array has 6 feature flags defined
4. `pnpm tsc --noEmit` passes
5. Store can be imported: `import { useFeatureFlagsStore } from '@/store/useFeatureFlagsStore'`
</verification>

<success_criteria>
- shadcn components installed and TypeScript recognizes them
- Feature flags store persists to localStorage under key `feature-flags-v1`
- Flag definitions cover all Phases 14-19 experimental features
- Store supports batch editing (startEditing, setPendingFlag, applyPendingFlags, discardPendingFlags)
</success_criteria>

<output>
After completion, create `.planning/phases/12-feature-flags/12-01-SUMMARY.md`
</output>
