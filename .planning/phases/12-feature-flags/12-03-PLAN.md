---
phase: 12-feature-flags
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/hooks/useURLFeatureFlags.ts
  - src/components/settings/URLConflictDialog.tsx
  - src/components/settings/SettingsPanel.tsx
  - src/components/viz/FloatingToolbar.tsx
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can share current configuration via URL"
    - "User is prompted before URL params override their settings"
    - "URL flags apply after user confirms in conflict dialog"
    - "Share URL button copies shareable link to clipboard"
  artifacts:
    - path: "src/hooks/useURLFeatureFlags.ts"
      provides: "URL parameter sync logic"
      exports: ["useURLFeatureFlags"]
    - path: "src/components/settings/URLConflictDialog.tsx"
      provides: "Confirmation dialog for URL override"
      exports: ["URLConflictDialog"]
  key_links:
    - from: "src/hooks/useURLFeatureFlags.ts"
      to: "src/store/useFeatureFlagsStore.ts"
      via: "applyURLFlags method"
      pattern: "applyURLFlags"
    - from: "src/components/settings/URLConflictDialog.tsx"
      to: "src/hooks/useURLFeatureFlags.ts"
      via: "confirm action triggers apply"
      pattern: "onConfirm"
    - from: "src/app/page.tsx"
      to: "src/hooks/useURLFeatureFlags.ts"
      via: "hook mounted at app level"
      pattern: "useURLFeatureFlags"
---

<objective>
Implement URL parameter sharing for feature flags with conflict resolution: users can generate shareable URLs, and clicking a shared link prompts before overriding local settings.

Purpose: URL sharing enables research collaboration by allowing users to share specific visualization configurations. The conflict dialog prevents accidental overwriting of carefully configured settings.

Output:
- useURLFeatureFlags hook for parsing/generating URL params
- URLConflictDialog for "Apply these settings?" prompt
- Share URL button in SettingsPanel
- Integration at app level for initial URL detection
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-feature-flags/12-RESEARCH.md
@.planning/phases/12-feature-flags/12-02-SUMMARY.md

# Store with applyURLFlags
@src/store/useFeatureFlagsStore.ts

# Components to integrate with
@src/components/settings/SettingsPanel.tsx
@src/components/viz/FloatingToolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL Sync Hook and Conflict Dialog</name>
  <files>
    src/hooks/useURLFeatureFlags.ts
    src/components/settings/URLConflictDialog.tsx
  </files>
  <action>
**Create `src/hooks/useURLFeatureFlags.ts`:**

```typescript
'use client';

import { useSearchParams, useRouter, usePathname } from 'next/navigation';
import { useCallback, useEffect, useState } from 'react';
import { useFeatureFlagsStore } from '@/store/useFeatureFlagsStore';
import { FLAG_DEFINITIONS } from '@/lib/feature-flags';

export function useURLFeatureFlags() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();
  
  const [showConflictDialog, setShowConflictDialog] = useState(false);
  const [urlFlags, setUrlFlags] = useState<Record<string, boolean> | null>(null);
  
  const applyURLFlags = useFeatureFlagsStore((state) => state.applyURLFlags);
  const flags = useFeatureFlagsStore((state) => state.flags);

  // Parse flags from URL on mount
  useEffect(() => {
    const flagsParam = searchParams.get('flags');
    if (!flagsParam) return;
    
    try {
      const parsed = JSON.parse(atob(flagsParam));
      
      // Validate: only include known flag IDs
      const validFlagIds = new Set(FLAG_DEFINITIONS.map((f) => f.id));
      const validFlags: Record<string, boolean> = {};
      let hasValidFlags = false;
      
      for (const [key, value] of Object.entries(parsed)) {
        if (validFlagIds.has(key) && typeof value === 'boolean') {
          validFlags[key] = value;
          hasValidFlags = true;
        }
      }
      
      if (hasValidFlags) {
        // Check if URL flags differ from current
        const hasDifferences = Object.entries(validFlags).some(
          ([key, value]) => flags[key] !== value
        );
        
        if (hasDifferences) {
          setUrlFlags(validFlags);
          setShowConflictDialog(true);
        }
      }
    } catch {
      // Invalid base64 or JSON, silently ignore
      console.warn('Invalid flags parameter in URL');
    }
  }, [searchParams, flags]);

  // Apply URL flags (called when user confirms)
  const confirmURLFlags = useCallback(() => {
    if (urlFlags) {
      applyURLFlags(urlFlags);
    }
    setShowConflictDialog(false);
    setUrlFlags(null);
    
    // Clear flags param from URL after applying
    const params = new URLSearchParams(searchParams.toString());
    params.delete('flags');
    const newUrl = params.toString() ? `${pathname}?${params.toString()}` : pathname;
    router.replace(newUrl);
  }, [urlFlags, applyURLFlags, searchParams, pathname, router]);

  // Reject URL flags (user cancels)
  const rejectURLFlags = useCallback(() => {
    setShowConflictDialog(false);
    setUrlFlags(null);
    
    // Clear flags param from URL
    const params = new URLSearchParams(searchParams.toString());
    params.delete('flags');
    const newUrl = params.toString() ? `${pathname}?${params.toString()}` : pathname;
    router.replace(newUrl);
  }, [searchParams, pathname, router]);

  // Generate shareable URL with current flags
  const generateShareURL = useCallback(() => {
    const currentFlags = useFeatureFlagsStore.getState().flags;
    const encoded = btoa(JSON.stringify(currentFlags));
    
    const params = new URLSearchParams(searchParams.toString());
    params.set('flags', encoded);
    
    return `${window.location.origin}${pathname}?${params.toString()}`;
  }, [pathname, searchParams]);

  // Copy share URL to clipboard
  const copyShareURL = useCallback(async () => {
    const url = generateShareURL();
    try {
      await navigator.clipboard.writeText(url);
      return true;
    } catch {
      console.error('Failed to copy URL to clipboard');
      return false;
    }
  }, [generateShareURL]);

  return {
    showConflictDialog,
    urlFlags,
    confirmURLFlags,
    rejectURLFlags,
    generateShareURL,
    copyShareURL,
  };
}
```

**Create `src/components/settings/URLConflictDialog.tsx`:**

```typescript
'use client';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Badge } from '@/components/ui/badge';
import { FLAG_DEFINITIONS } from '@/lib/feature-flags';

interface URLConflictDialogProps {
  isOpen: boolean;
  urlFlags: Record<string, boolean> | null;
  onConfirm: () => void;
  onCancel: () => void;
}

export function URLConflictDialog({
  isOpen,
  urlFlags,
  onConfirm,
  onCancel,
}: URLConflictDialogProps) {
  if (!urlFlags) return null;

  // Find flags that will be enabled
  const enabledFlags = Object.entries(urlFlags)
    .filter(([, enabled]) => enabled)
    .map(([id]) => FLAG_DEFINITIONS.find((f) => f.id === id))
    .filter(Boolean);

  return (
    <AlertDialog open={isOpen} onOpenChange={(open) => !open && onCancel()}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Apply Shared Settings?</AlertDialogTitle>
          <AlertDialogDescription>
            This link contains a feature configuration. Applying these settings will override your current preferences.
          </AlertDialogDescription>
        </AlertDialogHeader>

        {enabledFlags.length > 0 && (
          <div className="py-4">
            <p className="text-sm font-medium mb-2">Features to enable:</p>
            <div className="flex flex-wrap gap-2">
              {enabledFlags.map((flag) => (
                <Badge key={flag!.id} variant="secondary">
                  {flag!.name}
                </Badge>
              ))}
            </div>
          </div>
        )}

        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>
            Keep My Settings
          </AlertDialogCancel>
          <AlertDialogAction onClick={onConfirm}>
            Apply Shared Settings
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Key design decisions:
- Base64 encode flags JSON for URL-safe representation
- Validate flag IDs against known FLAG_DEFINITIONS (ignore unknown)
- Show dialog only if URL flags differ from current
- Clear `flags` param from URL after confirming or rejecting
- Copy to clipboard for easy sharing
  </action>
  <verify>
```bash
# Check files exist
ls src/hooks/useURLFeatureFlags.ts
ls src/components/settings/URLConflictDialog.tsx

# Check exports
grep -l "useURLFeatureFlags" src/hooks/useURLFeatureFlags.ts
grep -l "URLConflictDialog" src/components/settings/URLConflictDialog.tsx

# TypeScript compiles
pnpm tsc --noEmit
```
  </verify>
  <done>
- useURLFeatureFlags hook handles URL parsing and generation
- URLConflictDialog shows which features will be enabled
- Confirm applies flags, Cancel keeps current settings
- URL param cleared after handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Up URL Hook and Add Share Button</name>
  <files>
    src/components/settings/SettingsPanel.tsx
    src/components/viz/FloatingToolbar.tsx
    src/app/page.tsx
  </files>
  <action>
**Update `src/components/settings/SettingsPanel.tsx`** to add Share URL button:

Add import and hook usage:
```typescript
import { Share2, Check } from 'lucide-react';
import { useState } from 'react';
import { useURLFeatureFlags } from '@/hooks/useURLFeatureFlags';
```

Add state for copy feedback:
```typescript
const { copyShareURL } = useURLFeatureFlags();
const [copied, setCopied] = useState(false);

const handleCopyShare = async () => {
  const success = await copyShareURL();
  if (success) {
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  }
};
```

Add Share button in footer (before Reset):
```typescript
<Button 
  variant="outline" 
  onClick={handleCopyShare}
  className="flex-1"
>
  {copied ? (
    <>
      <Check className="h-4 w-4 mr-1" />
      Copied!
    </>
  ) : (
    <>
      <Share2 className="h-4 w-4 mr-1" />
      Share URL
    </>
  )}
</Button>
```

**Update `src/components/viz/FloatingToolbar.tsx`** to mount URL hook and dialog:

Add imports:
```typescript
import { useURLFeatureFlags } from '@/hooks/useURLFeatureFlags';
import { URLConflictDialog } from '@/components/settings/URLConflictDialog';
```

Add hook and dialog to component:
```typescript
const {
  showConflictDialog,
  urlFlags,
  confirmURLFlags,
  rejectURLFlags,
} = useURLFeatureFlags();

// In return, add dialog after existing components:
<URLConflictDialog
  isOpen={showConflictDialog}
  urlFlags={urlFlags}
  onConfirm={confirmURLFlags}
  onCancel={rejectURLFlags}
/>
```

**Wrap `FloatingToolbar` in Suspense** because `useSearchParams` requires it.

In parent component or layout where FloatingToolbar is used, ensure it's wrapped:
```typescript
import { Suspense } from 'react';

<Suspense fallback={null}>
  <FloatingToolbar />
</Suspense>
```

If FloatingToolbar is used directly in page.tsx, add Suspense there. Check existing usage and wrap appropriately.
  </action>
  <verify>
```bash
# Check Share button added
grep -l "Share URL" src/components/settings/SettingsPanel.tsx
grep -l "copyShareURL" src/components/settings/SettingsPanel.tsx

# Check dialog integration
grep -l "URLConflictDialog" src/components/viz/FloatingToolbar.tsx
grep -l "useURLFeatureFlags" src/components/viz/FloatingToolbar.tsx

# TypeScript compiles
pnpm tsc --noEmit

# Dev server runs
pnpm dev &
sleep 5
curl -s http://localhost:3000 | head -5
```
  </verify>
  <done>
- Share URL button in Settings panel copies link to clipboard
- Copy feedback shows "Copied!" for 2 seconds
- URL conflict dialog appears when opening shared link
- Confirm applies shared settings, Cancel keeps local settings
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Complete Feature Flags System</name>
  <what-built>
Complete feature flags infrastructure:
1. Feature flags store with localStorage persistence
2. Draggable floating toolbar with gear icon
3. Settings panel with tabbed categories and batch save
4. URL sharing with conflict resolution
  </what-built>
  <how-to-verify>
1. **Draggable Toolbar:**
   - Open the app at http://localhost:3000
   - Drag the floating toolbar to a new position
   - Refresh the page - toolbar should restore to saved position

2. **Settings Panel:**
   - Click the gear icon to open Settings
   - Toggle a few feature flags on
   - Verify "Unsaved changes" appears
   - Click Cancel - changes should be discarded
   - Open Settings again, toggle flags, click Save
   - Refresh page - flags should persist

3. **URL Sharing:**
   - Open Settings, enable some features, Save
   - Click "Share URL" button - should show "Copied!"
   - Open a new incognito/private window
   - Paste the URL - conflict dialog should appear
   - Click "Apply Shared Settings" - features should be enabled
   - Open Settings to verify flags are enabled

4. **Reset to Defaults:**
   - With some flags enabled, open Settings
   - Click "Reset to Defaults"
   - All flags should return to their default (off) state
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Feature flags persist in localStorage under `feature-flags-v1`
2. Toolbar position persists under `toolbar-position-v1`
3. Settings panel opens from gear icon with 3 category tabs
4. Batch edit works: Save applies, Cancel discards
5. Share URL generates base64-encoded flags param
6. Conflict dialog appears when URL has flags that differ from current
7. Confirm applies URL flags, Cancel keeps current
8. `pnpm tsc --noEmit` passes
9. App loads without hydration errors
</verification>

<success_criteria>
- FLAG-01: System stores feature flags in localStorage ✓
- FLAG-02: User can access Settings panel to toggle features ✓
- FLAG-03: Feature flags control visibility of experimental viz modes ✓ (infrastructure ready)
- Settings panel accessible via gear icon ✓
- Toggle switches persist across browser sessions ✓
- URL sharing works with conflict resolution ✓
</success_criteria>

<output>
After completion, create `.planning/phases/12-feature-flags/12-03-SUMMARY.md`
</output>
