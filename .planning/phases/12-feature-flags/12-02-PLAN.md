---
phase: 12-feature-flags
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/hooks/useDraggable.ts
  - src/components/viz/FloatingToolbar.tsx
  - src/components/viz/Controls.tsx
  - src/components/settings/SettingsPanel.tsx
  - src/components/settings/FeatureFlagItem.tsx
autonomous: true

must_haves:
  truths:
    - "User can access Settings via gear icon in toolbar"
    - "User can toggle feature flags on/off in Settings panel"
    - "Toolbar is draggable and position persists"
    - "Unsaved changes are visually indicated"
    - "Save button applies changes, closing without save discards"
  artifacts:
    - path: "src/hooks/useDraggable.ts"
      provides: "Draggable positioning hook with localStorage persistence"
      exports: ["useDraggable"]
    - path: "src/components/viz/FloatingToolbar.tsx"
      provides: "Draggable toolbar with gear icon for settings"
      exports: ["FloatingToolbar"]
    - path: "src/components/settings/SettingsPanel.tsx"
      provides: "Settings sheet with tabs and flag toggles"
      exports: ["SettingsPanel"]
    - path: "src/components/settings/FeatureFlagItem.tsx"
      provides: "Single flag toggle with label and badge"
      exports: ["FeatureFlagItem"]
  key_links:
    - from: "src/components/viz/FloatingToolbar.tsx"
      to: "src/components/settings/SettingsPanel.tsx"
      via: "gear icon onClick opens panel"
      pattern: "setIsSettingsOpen.*true"
    - from: "src/components/settings/SettingsPanel.tsx"
      to: "src/store/useFeatureFlagsStore.ts"
      via: "reads flags, calls batch edit methods"
      pattern: "useFeatureFlagsStore"
    - from: "src/components/settings/FeatureFlagItem.tsx"
      to: "src/components/ui/switch.tsx"
      via: "uses Switch component for toggle"
      pattern: "Switch"
---

<objective>
Build the Settings UI: draggable floating toolbar with gear icon, and the Settings panel with tabbed flag organization and batch-save behavior.

Purpose: This is the primary user interface for managing feature flags. The draggable toolbar provides unobtrusive access, and the Sheet panel organizes features by category with clear status indicators.

Output:
- useDraggable hook with position persistence
- FloatingToolbar (replaces Controls.tsx) with drag support and settings access
- SettingsPanel with tabs, switches, badges, and batch save
- FeatureFlagItem component for individual flags
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-feature-flags/12-RESEARCH.md
@.planning/phases/12-feature-flags/12-01-SUMMARY.md

# Current toolbar to replace
@src/components/viz/Controls.tsx

# Store and definitions from Plan 01
@src/store/useFeatureFlagsStore.ts
@src/lib/feature-flags.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDraggable Hook and FloatingToolbar</name>
  <files>
    src/hooks/useDraggable.ts
    src/components/viz/FloatingToolbar.tsx
    src/components/viz/Controls.tsx
  </files>
  <action>
**Create `src/hooks/useDraggable.ts`:**

```typescript
'use client';

import { useState, useCallback, useRef, useEffect } from 'react';

interface Position {
  x: number;
  y: number;
}

interface UseDraggableOptions {
  storageKey?: string;
  initialPosition?: Position;
}

export function useDraggable(options: UseDraggableOptions = {}) {
  const { storageKey, initialPosition = { x: 16, y: 16 } } = options;
  
  const [position, setPosition] = useState<Position>(() => {
    if (typeof window === 'undefined') return initialPosition;
    if (storageKey) {
      const saved = localStorage.getItem(storageKey);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch {
          // Invalid JSON, use default
        }
      }
    }
    return initialPosition;
  });
  
  const [isDragging, setIsDragging] = useState(false);
  const dragRef = useRef<HTMLDivElement>(null);
  const offsetRef = useRef({ x: 0, y: 0 });

  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    if (!dragRef.current) return;
    // Only start drag if clicking the drag handle (not buttons)
    if ((e.target as HTMLElement).closest('button')) return;
    
    e.preventDefault();
    const rect = dragRef.current.getBoundingClientRect();
    offsetRef.current = {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top,
    };
    setIsDragging(true);
  }, []);

  useEffect(() => {
    if (!isDragging) return;

    const handleMouseMove = (e: MouseEvent) => {
      const newX = e.clientX - offsetRef.current.x;
      const newY = e.clientY - offsetRef.current.y;
      
      // Clamp to viewport bounds
      const maxX = window.innerWidth - (dragRef.current?.offsetWidth ?? 100);
      const maxY = window.innerHeight - (dragRef.current?.offsetHeight ?? 50);
      
      setPosition({
        x: Math.max(0, Math.min(newX, maxX)),
        y: Math.max(0, Math.min(newY, maxY)),
      });
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging]);

  // Persist position on change (debounced via effect cleanup)
  useEffect(() => {
    if (!storageKey || isDragging) return;
    localStorage.setItem(storageKey, JSON.stringify(position));
  }, [position, storageKey, isDragging]);

  return {
    position,
    isDragging,
    dragRef,
    handleMouseDown,
  };
}
```

**Create `src/components/viz/FloatingToolbar.tsx`:**

Build on top of the existing Controls.tsx functionality but add:
- Draggable positioning via useDraggable hook
- Gear icon opens SettingsPanel
- Visual cursor feedback during drag

```typescript
'use client';

import { useState } from 'react';
import { Filter, Home, Layers, Settings, Eye, EyeOff, GripVertical } from 'lucide-react';
import { FilterOverlay } from './FilterOverlay';
import { SettingsPanel } from '@/components/settings/SettingsPanel';
import { useUIStore } from '@/store/ui';
import { useDraggable } from '@/hooks/useDraggable';
import { cn } from '@/lib/utils';

export function FloatingToolbar() {
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  
  const showContext = useUIStore((state) => state.showContext);
  const toggleContext = useUIStore((state) => state.toggleContext);
  
  const { position, isDragging, dragRef, handleMouseDown } = useDraggable({
    storageKey: 'toolbar-position-v1',
    initialPosition: { x: window?.innerWidth ? window.innerWidth - 250 : 16, y: 16 },
  });

  return (
    <>
      <div
        ref={dragRef}
        onMouseDown={handleMouseDown}
        className={cn(
          'fixed z-20 flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-2 shadow-sm backdrop-blur',
          isDragging ? 'cursor-grabbing' : 'cursor-grab'
        )}
        style={{
          left: position.x,
          top: position.y,
        }}
      >
        {/* Drag handle indicator */}
        <GripVertical className="h-4 w-4 text-muted-foreground/50" />
        
        <button
          type="button"
          className="rounded-full p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Home"
        >
          <Home className="h-4 w-4" />
        </button>
        
        <button
          type="button"
          className="rounded-full p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Context Visibility"
          onClick={toggleContext}
          title={showContext ? 'Hide Context' : 'Show Context'}
        >
          {showContext ? <Eye className="h-4 w-4" /> : <EyeOff className="h-4 w-4" />}
        </button>
        
        <button
          type="button"
          className="rounded-full p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Layers"
        >
          <Layers className="h-4 w-4" />
        </button>
        
        <button
          type="button"
          className="rounded-full p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Settings"
          onClick={() => setIsSettingsOpen(true)}
        >
          <Settings className="h-4 w-4" />
        </button>
        
        <div className="h-5 w-px bg-border" />
        
        <button
          type="button"
          className="rounded-full p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Filters"
          onClick={() => setIsFilterOpen((open) => !open)}
        >
          <Filter className="h-4 w-4" />
        </button>
      </div>

      <FilterOverlay isOpen={isFilterOpen} onClose={() => setIsFilterOpen(false)} />
      <SettingsPanel isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />
    </>
  );
}
```

**Update `src/components/viz/Controls.tsx`** to re-export FloatingToolbar for backwards compatibility:

```typescript
'use client';

// Re-export FloatingToolbar as Controls for backwards compatibility
export { FloatingToolbar as Controls } from './FloatingToolbar';
```

This ensures existing imports of Controls continue to work during transition.
  </action>
  <verify>
```bash
# Check files exist
ls src/hooks/useDraggable.ts
ls src/components/viz/FloatingToolbar.tsx

# Check imports work
grep -l "useDraggable" src/components/viz/FloatingToolbar.tsx
grep -l "SettingsPanel" src/components/viz/FloatingToolbar.tsx

# TypeScript compiles
pnpm tsc --noEmit
```
  </verify>
  <done>
- useDraggable hook exists with position persistence
- FloatingToolbar renders with drag handle and gear icon
- Controls.tsx re-exports FloatingToolbar for compatibility
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsPanel with Batch Edit</name>
  <files>
    src/components/settings/SettingsPanel.tsx
    src/components/settings/FeatureFlagItem.tsx
  </files>
  <action>
**Create directory and files:**

```bash
mkdir -p src/components/settings
```

**Create `src/components/settings/FeatureFlagItem.tsx`:**

```typescript
'use client';

import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Label } from '@/components/ui/label';
import type { FeatureFlag, FeatureStatus } from '@/lib/feature-flags';

interface FeatureFlagItemProps {
  flag: FeatureFlag;
  isEnabled: boolean;
  onToggle: (enabled: boolean) => void;
}

const statusVariants: Record<FeatureStatus, 'default' | 'secondary' | 'destructive'> = {
  stable: 'default',
  beta: 'secondary',
  experimental: 'destructive',
};

export function FeatureFlagItem({ flag, isEnabled, onToggle }: FeatureFlagItemProps) {
  return (
    <div className="flex items-center justify-between py-3 border-b border-border last:border-0">
      <div className="flex-1 space-y-1">
        <div className="flex items-center gap-2">
          <Label htmlFor={flag.id} className="text-sm font-medium">
            {flag.name}
          </Label>
          <Badge variant={statusVariants[flag.status]} className="text-xs">
            {flag.status}
          </Badge>
        </div>
        <p className="text-xs text-muted-foreground">{flag.description}</p>
      </div>
      <Switch
        id={flag.id}
        checked={isEnabled}
        onCheckedChange={onToggle}
        className="ml-4"
      />
    </div>
  );
}
```

**Create `src/components/settings/SettingsPanel.tsx`:**

```typescript
'use client';

import { useEffect } from 'react';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
  SheetFooter,
} from '@/components/ui/sheet';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { useFeatureFlagsStore } from '@/store/useFeatureFlagsStore';
import {
  FLAG_DEFINITIONS,
  getFlagsByCategory,
  type FeatureCategory,
} from '@/lib/feature-flags';
import { FeatureFlagItem } from './FeatureFlagItem';

interface SettingsPanelProps {
  isOpen: boolean;
  onClose: () => void;
}

const CATEGORIES: { value: FeatureCategory; label: string }[] = [
  { value: 'visualization', label: 'Visualization' },
  { value: 'experimental', label: 'Experimental' },
  { value: 'accessibility', label: 'Accessibility' },
];

export function SettingsPanel({ isOpen, onClose }: SettingsPanelProps) {
  const pendingFlags = useFeatureFlagsStore((state) => state.pendingFlags);
  const startEditing = useFeatureFlagsStore((state) => state.startEditing);
  const setPendingFlag = useFeatureFlagsStore((state) => state.setPendingFlag);
  const applyPendingFlags = useFeatureFlagsStore((state) => state.applyPendingFlags);
  const discardPendingFlags = useFeatureFlagsStore((state) => state.discardPendingFlags);
  const resetToDefaults = useFeatureFlagsStore((state) => state.resetToDefaults);
  const hasPendingChanges = useFeatureFlagsStore((state) => state.hasPendingChanges);
  const flags = useFeatureFlagsStore((state) => state.flags);

  // Start editing when panel opens
  useEffect(() => {
    if (isOpen) {
      startEditing();
    }
  }, [isOpen, startEditing]);

  const handleClose = () => {
    discardPendingFlags();
    onClose();
  };

  const handleSave = () => {
    applyPendingFlags();
    onClose();
  };

  const handleReset = () => {
    resetToDefaults();
    onClose();
  };

  const getEffectiveValue = (flagId: string) => {
    if (pendingFlags !== null && flagId in pendingFlags) {
      return pendingFlags[flagId];
    }
    return flags[flagId] ?? false;
  };

  const hasChanges = hasPendingChanges();

  return (
    <Sheet open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <SheetContent side="right" className="w-[400px] sm:w-[480px] flex flex-col">
        <SheetHeader>
          <SheetTitle>Settings</SheetTitle>
          <SheetDescription>
            Configure visualization features and experimental options.
          </SheetDescription>
        </SheetHeader>

        <div className="flex-1 overflow-y-auto py-4">
          <Tabs defaultValue="visualization" className="w-full">
            <TabsList className="w-full grid grid-cols-3">
              {CATEGORIES.map((cat) => (
                <TabsTrigger key={cat.value} value={cat.value}>
                  {cat.label}
                </TabsTrigger>
              ))}
            </TabsList>

            {CATEGORIES.map((cat) => (
              <TabsContent key={cat.value} value={cat.value} className="mt-4">
                {getFlagsByCategory(cat.value).length === 0 ? (
                  <p className="text-sm text-muted-foreground py-4 text-center">
                    No features in this category yet.
                  </p>
                ) : (
                  getFlagsByCategory(cat.value).map((flag) => (
                    <FeatureFlagItem
                      key={flag.id}
                      flag={flag}
                      isEnabled={getEffectiveValue(flag.id)}
                      onToggle={(enabled) => setPendingFlag(flag.id, enabled)}
                    />
                  ))
                )}
              </TabsContent>
            ))}
          </Tabs>
        </div>

        <SheetFooter className="flex-col gap-2 sm:flex-col">
          {hasChanges && (
            <p className="text-sm text-amber-500 font-medium">
              Unsaved changes
            </p>
          )}
          <div className="flex gap-2 w-full">
            <Button variant="outline" onClick={handleReset} className="flex-1">
              Reset to Defaults
            </Button>
            <Button variant="outline" onClick={handleClose} className="flex-1">
              Cancel
            </Button>
            <Button
              onClick={handleSave}
              className={hasChanges ? 'flex-1 bg-amber-500 hover:bg-amber-600' : 'flex-1'}
            >
              Save
            </Button>
          </div>
        </SheetFooter>
      </SheetContent>
    </Sheet>
  );
}
```

Key implementation details:
- `startEditing()` called on open to initialize `pendingFlags`
- `getEffectiveValue()` reads from pending during edit, falls back to committed
- Save button highlighted amber when changes exist
- "Unsaved changes" label appears when pending differs from committed
- Cancel/close discards pending, Save applies and closes
- Reset button clears all to defaults
  </action>
  <verify>
```bash
# Check files exist
ls src/components/settings/SettingsPanel.tsx
ls src/components/settings/FeatureFlagItem.tsx

# Check imports
grep -l "useFeatureFlagsStore" src/components/settings/SettingsPanel.tsx
grep -l "Switch" src/components/settings/FeatureFlagItem.tsx

# TypeScript compiles
pnpm tsc --noEmit

# Dev server runs
pnpm dev &
sleep 5
curl -s http://localhost:3000 | head -5
```
  </verify>
  <done>
- SettingsPanel renders with 3 category tabs
- FeatureFlagItem shows switch, badge, and description for each flag
- Batch editing works: changes staged, Save applies, Cancel discards
- Unsaved changes indicator visible when pending differs from saved
- Reset to Defaults button works
  </done>
</task>

</tasks>

<verification>
1. Toolbar is draggable and position persists across page refresh
2. Gear icon opens Settings sheet from right
3. Settings panel shows flags organized by category tabs
4. Toggle changes show in pending state without immediate apply
5. "Unsaved changes" appears when pending differs from saved
6. Save applies changes, Cancel discards them
7. Reset to Defaults clears all flags to default values
8. `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Toolbar can be dragged anywhere on screen
- Toolbar position persists in localStorage under `toolbar-position-v1`
- Gear icon opens SettingsPanel sheet
- Settings panel has 3 tabs (Visualization, Experimental, Accessibility)
- Each flag shows name, description, status badge, and toggle switch
- Batch edit flow works correctly (Save applies, Cancel discards)
- Unsaved changes visually indicated
</success_criteria>

<output>
After completion, create `.planning/phases/12-feature-flags/12-02-SUMMARY.md`
</output>
