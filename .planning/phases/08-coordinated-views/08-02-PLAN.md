---
phase: 08-coordinated-views
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/store/useCoordinationStore.ts
  - src/lib/selection.ts
  - src/components/viz/DataPoints.tsx
  - src/components/viz/shaders/ghosting.ts
  - src/components/map/MapVisualization.tsx
  - src/components/map/MapSelectionMarker.tsx
  - src/components/timeline/DualTimeline.tsx
autonomous: true

must_haves:
  truths:
    - "Selecting a point in the cube highlights it in the timeline and map"
    - "Selecting a time in the timeline highlights the corresponding event in the cube and map"
    - "Selection can be cleared without affecting filters"
  artifacts:
    - path: "src/store/useCoordinationStore.ts"
      provides: "Shared selection state with source tagging"
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Instance picking and selection uniforms"
    - path: "src/components/map/MapSelectionMarker.tsx"
      provides: "Map highlight marker for selected event"
    - path: "src/components/timeline/DualTimeline.tsx"
      provides: "Selection marker and timeline-to-selection interaction"
  key_links:
    - from: "src/components/viz/DataPoints.tsx"
      to: "src/store/useCoordinationStore.ts"
      via: "setSelectedIndex on instance click"
      pattern: "setSelectedIndex"
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "src/store/useCoordinationStore.ts"
      via: "setSelectedIndex on timeline click"
      pattern: "setSelectedIndex"
    - from: "src/components/map/MapVisualization.tsx"
      to: "src/store/useCoordinationStore.ts"
      via: "selectedIndex selector"
      pattern: "selectedIndex"
---

<objective>
Introduce coordinated selection/highlighting so interactions in the cube or timeline reflect across all views.

Purpose: Deliver COORD-02 by linking selection state across Map, Cube, and Timeline with a shared store.
Output: Selection store, cube picking + shader highlight, timeline selection marker, and map marker overlay.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/viz/DataPoints.tsx
@src/components/viz/shaders/ghosting.ts
@src/components/map/MapVisualization.tsx
@src/components/map/MapSelectionOverlay.tsx
@src/components/timeline/DualTimeline.tsx
@src/store/useDataStore.ts
@src/lib/projection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add a coordination selection store and helpers</name>
  <files>src/store/useCoordinationStore.ts, src/lib/selection.ts</files>
  <action>
    Create a new Zustand store for coordinated selection with fields:
    - selectedIndex: number | null
    - selectedSource: "cube" | "timeline" | "map" | null
    - setSelectedIndex(index, source)
    - clearSelection()
    Add src/lib/selection.ts with helpers to resolve a data point by index from useDataStore (columns or data), plus utilities to find the nearest index by time or by scene position (x/z). Helpers should return the index and derived lat/lon using unproject() so Map and Timeline share the same selection logic.
  </action>
  <verify>useCoordinationStore exports setSelectedIndex/clearSelection; selection helpers resolve points from both columnar and array data.</verify>
  <done>Selection state and lookup helpers exist for cube, timeline, and map.</done>
</task>

<task type="auto">
  <name>Task 2: Enable cube picking and shader highlighting</name>
  <files>src/components/viz/DataPoints.tsx, src/components/viz/shaders/ghosting.ts</files>
  <action>
    Update DataPoints to:
    - Attach onPointerDown to the instancedMesh and call setSelectedIndex(event.instanceId, "cube").
    - Clear selection onPointerMissed when clicking empty space.
    - Pass selection uniforms (uHasSelection, uSelectedIndex) into the shader.
    Update ghosting.ts to use gl_InstanceID to highlight the selected point (e.g., boost color/opacity and optionally scale) without breaking existing ghosting logic.
  </action>
  <verify>Clicking a cube point calls setSelectedIndex and the selected instance renders with distinct shader output.</verify>
  <done>Cube selection is interactive with a visible highlight for the selected instance.</done>
</task>

<task type="auto">
  <name>Task 3: Render selection markers in map and timeline</name>
  <files>src/components/map/MapVisualization.tsx, src/components/map/MapSelectionMarker.tsx, src/components/timeline/DualTimeline.tsx</files>
  <action>
    Add MapSelectionMarker to render a map marker for the selected event using MapLibre Source/Layer (simple circle + outline). In MapVisualization, derive lat/lon for the selected index via selection helpers and render the marker. Add a map click handler (when not in spatial selection mode) that finds the nearest event to the clicked map position and sets selection with source "map" if within a reasonable radius.
    In DualTimeline, draw a selection marker (vertical line or dot) at the selected event time. Add a detail-timeline click handler that finds the nearest event to the clicked time and sets selection with source "timeline".
  </action>
  <verify>Timeline click selects nearest event; map marker appears for selected index and stays in sync with cube selection.</verify>
  <done>Selection is bidirectional between cube, timeline, and map highlights without filtering changes.</done>
</task>

</tasks>

<verification>
- Click a point in the cube: the map marker and timeline selection indicator appear.
- Click a time in the detail timeline: the cube highlight and map marker update.
- Click empty space to clear selection and confirm highlights disappear.
</verification>

<success_criteria>
- Selection state propagates across all three views without filtering side effects.
- Selected events are visually distinct in the cube, timeline, and map.
</success_criteria>

<output>
After completion, create `.planning/phases/08-coordinated-views/08-02-SUMMARY.md`.
</output>
