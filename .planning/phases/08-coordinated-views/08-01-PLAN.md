---
phase: 08-coordinated-views
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/lib/time-domain.ts
  - src/store/useDataStore.ts
  - src/components/viz/DataPoints.tsx
  - src/components/timeline/DualTimeline.tsx
  - src/components/timeline/TimelinePanel.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a dual-scale timeline with an overview brush and a zoomed detail view"
    - "Adjusting the brush updates the visible time range and filters all views"
    - "Scrubbing the detail timeline updates the current time cursor and 3D cube"
  artifacts:
    - path: "src/components/timeline/DualTimeline.tsx"
      provides: "Focus+context timeline with brush and zoom"
    - path: "src/lib/time-domain.ts"
      provides: "Epoch/normalized time conversion helpers"
    - path: "src/store/useDataStore.ts"
      provides: "Epoch seconds domain for real data"
    - path: "src/components/timeline/TimelinePanel.tsx"
      provides: "Timeline panel wiring and layout"
  key_links:
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "src/store/useFilterStore.ts"
      via: "setTimeRange on brush"
      pattern: "setTimeRange"
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "src/store/useTimeStore.ts"
      via: "setRange/setTime on brush and scrub"
      pattern: "setRange|setTime"
    - from: "src/components/timeline/DualTimeline.tsx"
      to: "src/store/useDataStore.ts"
      via: "min/max epoch domain"
      pattern: "minTimestamp|maxTimestamp"
---

<objective>
Replace the single slider with a dual-scale focus+context timeline and synchronize time range/current time across the Map, Cube, and Timeline.

Purpose: Deliver COORD-01 and COORD-04 while wiring COORD-03 time filtering to the global store.
Output: D3 brush+zoom timeline, normalized time-domain utilities, and synchronized time range/current time updates.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/timeline/TimelinePanel.tsx
@src/components/timeline/DensityHistogram.tsx
@src/components/timeline/AdaptiveAxis.tsx
@src/store/useTimeStore.ts
@src/store/useFilterStore.ts
@src/store/useDataStore.ts
@src/components/viz/DataPoints.tsx
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install D3 interaction dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
    Add D3 interaction modules required for the dual-scale timeline: d3-brush, d3-zoom, and d3-selection. Add their TypeScript types if not bundled (use @types/d3-brush, @types/d3-zoom, @types/d3-selection). Use npm so both package.json and package-lock.json are updated.
  </action>
  <verify>package.json lists d3-brush, d3-zoom, d3-selection (and @types packages if used); package-lock.json changed.</verify>
  <done>Dependencies for D3 brush/zoom/selection are installed and tracked in lockfile.</done>
</task>

<task type="auto">
  <name>Task 2: Normalize epoch domain utilities</name>
  <files>src/lib/time-domain.ts, src/store/useDataStore.ts, src/components/viz/DataPoints.tsx</files>
  <action>
    Create src/lib/time-domain.ts with helpers to:
    - Detect epoch unit (ms vs seconds) based on magnitude.
    - Convert a raw epoch value to seconds.
    - Convert between epoch seconds and normalized 0-100 time using min/max bounds.
    Update useDataStore to compute and store min/max epoch seconds for real data (e.g., minTimestampSec/maxTimestampSec) alongside existing normalized timestamps. Update DataPoints to use the epoch-seconds domain when normalizing selectedTimeRange from useFilterStore, keeping the existing fallback [0, 100] when there is no data.
  </action>
  <verify>DataPoints uses minTimestampSec/maxTimestampSec for selectedTimeRange normalization when data exists.</verify>
  <done>Epoch domain helpers exist and store exposes epoch-second bounds for synchronization.</done>
</task>

<task type="auto">
  <name>Task 3: Build the dual-scale timeline and sync time state</name>
  <files>src/components/timeline/DualTimeline.tsx, src/components/timeline/TimelinePanel.tsx</files>
  <action>
    Implement a DualTimeline component with D3 focus+context:
    - Overview: render a compact histogram with scaleUtc (epoch seconds) and attach brushX.
    - Detail: render a zoomed timeline; attach d3-zoom to rescale the x-axis and keep the brush in sync.
    - Use source tagging (refs + event.sourceEvent) to prevent brush/zoom feedback loops.
    - On brush end, update filter store setTimeRange with epoch seconds, and update time store setRange with normalized values using time-domain helpers. Clamp currentTime into the new range if needed.
    - On detail click/drag, set currentTime (normalized) and draw a current-time cursor.
    Replace the slider+histogram block in TimelinePanel with DualTimeline, keeping the playback controls and time-window controls intact.
  </action>
  <verify>Brushing in the overview changes the detail view and updates time range in useFilterStore/useTimeStore.</verify>
  <done>Dual-scale timeline renders and synchronizes time range/current time across stores.</done>
</task>

</tasks>

<verification>
- Run `npm run lint`.
- In the UI, brush the overview to change the detail range and confirm cube/time controls update.
- Scrub the detail timeline and confirm the current time cursor and 3D time plane move together.
</verification>

<success_criteria>
- The timeline shows both overview and detail scales with synchronized brush/zoom.
- Time range filtering updates all views via the shared stores.
- Current time is consistent between timeline controls and the 3D cube animation.
</success_criteria>

<output>
After completion, create `.planning/phases/08-coordinated-views/08-01-SUMMARY.md`.
</output>
