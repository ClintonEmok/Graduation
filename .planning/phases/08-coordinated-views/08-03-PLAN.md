---
phase: 08-coordinated-views
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/components/map/MapEventLayer.tsx
  - src/components/map/MapVisualization.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Adjusting the brush updates the visible time range and filters the map view"
    - "Map view renders a time-filtered event layer tied to selectedTimeRange"
    - "Clearing the time range restores the full map event layer"
  artifacts:
    - path: "src/components/map/MapEventLayer.tsx"
      provides: "MapLibre event layer filtered by selected time range"
    - path: "src/components/map/MapVisualization.tsx"
      provides: "Map view wiring for event layer + selection overlay"
  key_links:
    - from: "src/components/map/MapEventLayer.tsx"
      to: "src/store/useFilterStore.ts"
      via: "selectedTimeRange selector"
      pattern: "selectedTimeRange"
    - from: "src/components/map/MapEventLayer.tsx"
      to: "src/store/useDataStore.ts"
      via: "columns/data + min/max timestamp"
      pattern: "useDataStore"
    - from: "src/components/map/MapVisualization.tsx"
      to: "src/components/map/MapEventLayer.tsx"
      via: "MapBase child layer"
      pattern: "<MapEventLayer"
---

<objective>
Add a time-range filtered event layer to the map so brush-driven time filtering is visible across all views.

Purpose: Close the coordination gap where the map view ignores selectedTimeRange updates.
Output: MapLibre event layer that filters by selectedTimeRange and is wired into the map view.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-coordinated-views/08-coordinated-views-VERIFICATION.md
@src/components/map/MapVisualization.tsx
@src/store/useFilterStore.ts
@src/store/useDataStore.ts
@src/lib/time-domain.ts
@src/lib/projection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create a time-filtered map event layer</name>
  <files>src/components/map/MapEventLayer.tsx</files>
  <action>
    Create a MapLibre layer component that renders event points and filters by selectedTimeRange.

    Implementation details:
    - Read `columns`, `data`, `minTimestampSec`, `maxTimestampSec` from `useDataStore` and `selectedTimeRange` from `useFilterStore`.
    - If `selectedTimeRange` is null, include all points; otherwise filter to the range.
    - For columnar data:
      - If `minTimestampSec` and `maxTimestampSec` exist, convert the selected epoch range to normalized [0, 100] via `epochSecondsToNormalized` and filter `columns.timestamp`.
      - If min/max are missing, assume `columns.timestamp` shares the same units as `selectedTimeRange` and compare directly.
    - For array data, compare `point.timestamp` against the selected range (assumes same units as timeline domain).
    - Convert each point’s (x, z) to (lat, lon) via `unproject` from `src/lib/projection.ts`.
    - Build a GeoJSON `FeatureCollection` and render with `Source` + `Layer` (circle layer, low opacity), using unique ids (e.g. `map-events-source`, `map-events-layer`).
    - Use `useMemo` for filtered points and GeoJSON to avoid recomputation.
    - Add a simple `MAX_POINTS` cap (sample by stride if over limit) to keep the map responsive.
  </action>
  <verify>Component compiles without TS errors and returns a `Source` + `Layer` when data exists.</verify>
  <done>MapEventLayer renders a GeoJSON point layer filtered by selectedTimeRange for both columnar and array data.</done>
</task>

<task type="auto">
  <name>Task 2: Wire the event layer into MapVisualization</name>
  <files>src/components/map/MapVisualization.tsx</files>
  <action>
    Import `MapEventLayer` and render it inside `MapBase`, positioned beneath the selection overlay and marker.
    Keep existing selection behavior intact; do not change selection overlay or marker logic.
  </action>
  <verify>MapVisualization renders MapEventLayer inside MapBase without altering selection overlay behavior.</verify>
  <done>Map view shows the event layer and still displays selection overlay/marker as before.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Map event layer filtered by selectedTimeRange and wired into the map view.</what-built>
  <how-to-verify>
    1. Run the app and open the main dashboard page.
    2. Drag the timeline brush to a narrow range.
    3. Confirm the map’s event points visibly reduce to the selected range.
    4. Clear the time range (reset brush) and confirm the full event layer returns.
  </how-to-verify>
  <resume-signal>Type "approved" or describe the issue you see.</resume-signal>
</task>

</tasks>

<verification>
Map view visibly reflects timeline brush changes by filtering the event layer to the selected time range.
</verification>

<success_criteria>
- Brush-driven time range changes update the map event layer immediately.
- Clearing the time range restores all map events.
- Selection overlay and marker still render on top of the event layer.
</success_criteria>

<output>
After completion, create `.planning/phases/08-coordinated-views/08-03-SUMMARY.md`.
</output>
