---
phase: 19-aggregated-bins
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified: [src/components/viz/LODController.tsx, src/components/viz/shaders/ghosting.ts, src/components/viz/DataPoints.tsx, src/components/viz/AggregatedBars.tsx, src/components/viz/MainScene.tsx]
autonomous: false

must_haves:
  truths:
    - "System smoothly transitions between points and bars based on zoom level"
    - "Individual points are hidden at far zoom to prevent visual clutter"
    - "Aggregated bars are hidden at near zoom to allow detailed inspection"
  artifacts:
    - path: "src/components/viz/LODController.tsx"
      provides: "Camera-distance driven lodFactor"
  key_links:
    - from: "src/components/viz/LODController.tsx"
      to: "src/store/useAggregationStore.ts"
      via: "setLodFactor"
    - from: "src/components/viz/shaders/ghosting.ts"
      to: "DataPoints.tsx"
      via: "uLodFactor uniform"
---

<objective>
Implement the Level-of-Detail (LOD) controller and smooth transitions. This plan connects camera distance to the visibility of points and bars, ensuring a seamless "Macro to Micro" experience.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-aggregated-bins/19-02-SUMMARY.md
@src/components/viz/shaders/ghosting.ts
@src/components/viz/DataPoints.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LOD Controller</name>
  <files>src/components/viz/LODController.tsx</files>
  <action>
    Create a component that monitors camera distance from origin/target.
    - Use useFrame from @react-three/fiber.
    - Calculate distance = camera.position.length().
    - Map distance to lodFactor [0, 1] using MathUtils.clamp and smoothstep logic.
      - NEAR_LIMIT (e.g. 100): lodFactor = 0 (Points only)
      - FAR_LIMIT (e.g. 300): lodFactor = 1 (Bars only)
    - Update useAggregationStore.setLodFactor.
  </action>
  <verify>Check console for lodFactor changing as you zoom in/out.</verify>
  <done>lodFactor is correctly calculated based on zoom.</done>
</task>

<task type="auto">
  <name>Task 2: Update Points Shader for LOD</name>
  <files>src/components/viz/shaders/ghosting.ts, src/components/viz/DataPoints.tsx</files>
  <action>
    Update the ghosting shader to support LOD cross-fade.
    - Add uniform float uLodFactor.
    - In fragment shader: 
      - If uLodFactor > 0, apply a screen-space dithering pattern to discard points.
      - Alternatively, use uLodFactor to scale point size to 0 or reduce opacity.
      - Recommendation: Use a combination of size scaling and dithering for the smoothest effect.
    - Pass lodFactor from store to the shader in DataPoints.tsx.
  </action>
  <verify>Points fade out as you zoom away from the cube.</verify>
  <done>Points respond to lodFactor.</done>
</task>

<task type="auto">
  <name>Task 3: Update Bars for LOD</name>
  <files>src/components/viz/AggregatedBars.tsx</files>
  <action>
    Modify AggregatedBars.tsx to respond to lodFactor.
    - Bars should fade in as lodFactor increases (zoom out).
    - Bars should be completely hidden when lodFactor is 0.
    - Use transparent: true and opacity or a similar dithering pattern as points.
  </action>
  <verify>Bars fade in as you zoom away.</verify>
  <done>Bars respond to lodFactor.</done>
</task>

<task type="auto">
  <name>Task 4: Final Scene Integration</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Add LODController to MainScene.tsx.
    Ensure AggregatedBars and DataPoints are correctly synchronized via the store.
  </action>
  <verify>Visual verification of the full LOD transition.</verify>
  <done>LOD system is fully integrated.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Aggregated Bins LOD system</what-built>
  <how-to-verify>
    1. Enable 'Aggregated Bins (LOD)' in Settings -> Experimental.
    2. Zoom in close: You should see individual points.
    3. Zoom out far: Points should smoothly transition into 3D bars.
    4. Observe: Bars should accurately represent the density and dominant category of the points they replace.
  </how-to-verify>
  <resume-signal>approved</resume-signal>
</task>

</tasks>

<verification>
- Continuous transition with no sharp "pops".
- Performance remains high during transition.
- Visual clarity improved at far zoom levels.
</verification>

<success_criteria>
- Transition is smooth and intuitive.
- Zooming in reveals detail, zooming out provides overview.
</success_criteria>

<output>
After completion, create .planning/phases/19-aggregated-bins/19-03-SUMMARY.md
</output>
