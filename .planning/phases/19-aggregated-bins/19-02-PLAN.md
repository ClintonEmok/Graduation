---
phase: 19-aggregated-bins
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified: [src/components/viz/AggregatedBars.tsx, src/components/viz/MainScene.tsx]
autonomous: true

must_haves:
  truths:
    - "Aggregated bins are rendered as 3D boxes"
    - "Bar height corresponds to event count in the bin"
  artifacts:
    - path: "src/components/viz/AggregatedBars.tsx"
      provides: "InstancedMesh rendering for binned data"
  key_links:
    - from: "src/components/viz/AggregatedBars.tsx"
      to: "src/store/useAggregationStore.ts"
      via: "useAggregationStore hook"
---

<objective>
Implement the visual representation of aggregated data using 3D bars. This plan focuses on rendering performance using InstancedMesh and ensuring bars are correctly positioned within the Space-Time Cube.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-aggregated-bins/19-01-SUMMARY.md
@src/components/viz/DataPoints.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Aggregated Bars Component</name>
  <files>src/components/viz/AggregatedBars.tsx</files>
  <action>
    Create the AggregatedBars component using Three.js InstancedMesh.
    - Use BoxGeometry for the bars.
    - Position: Each instance should be at the bin's (x, y, z) center.
    - Scale: X and Z scales should match the bin size. Y scale should be proportional to the 'count' (e.g., height = count * 0.5, but clamped to avoid vertical overlap if possible, or just follow count).
    - Color: Use the dominant type's color from the bin.
    - Optimization: Only update matrices when the bins array in useAggregationStore changes.
  </action>
  <verify>Check that bars appear in the scene at expected locations.</verify>
  <done>AggregatedBars component is functional.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into Main Scene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Add AggregatedBars to the MainScene.tsx, conditionally rendered based on the 'aggregatedBins' feature flag.
  </action>
  <verify>Toggle the feature flag in Settings and verify bars appear/disappear.</verify>
  <done>AggregatedBars are integrated into the visualization.</done>
</task>

</tasks>

<verification>
- Bars should appear as a 3D grid of boxes when enabled.
- Heights should vary based on data density.
- Colors should match the dominant category in each bin.
</verification>

<success_criteria>
- Instanced rendering of bars is working without performance issues.
- Bars are spatial-temporally aligned with the underlying data.
</success_criteria>

<output>
After completion, create .planning/phases/19-aggregated-bins/19-02-SUMMARY.md
</output>
