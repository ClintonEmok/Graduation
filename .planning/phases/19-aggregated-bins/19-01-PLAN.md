---
phase: 19-aggregated-bins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/store/useAggregationStore.ts, src/components/viz/AggregationManager.tsx, src/components/viz/MainScene.tsx]
autonomous: true

must_haves:
  truths:
    - "Aggregation logic correctly bins data points into a 3D grid"
    - "Binned results are stored in a reactive store"
  artifacts:
    - path: "src/store/useAggregationStore.ts"
      provides: "Aggregation state and results"
    - path: "src/components/viz/AggregationManager.tsx"
      provides: "3D binning logic with adaptive awareness"
  key_links:
    - from: "src/components/viz/AggregationManager.tsx"
      to: "src/store/useAggregationStore.ts"
      via: "setBins call"
---

<objective>
Set up the state management and logic for spatial-temporal binning. This plan implements the "Brain" of the aggregation system, which partitions the Space-Time Cube into a grid and counts event density.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/store/useDataStore.ts
@src/components/viz/ClusterManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Aggregation Store</name>
  <files>src/store/useAggregationStore.ts</files>
  <action>
    Create a Zustand store to manage aggregation state. 
    State should include:
    - bins: Array of { x, y, z, count, dominantType, color }
    - lodFactor: number (0 to 1)
    - gridResolution: { x: number, y: number, z: number } (default 32, 16, 32)
    - enabled: boolean (driven by feature flag)
    - setBins: (bins: Bin[]) => void
    - setLodFactor: (factor: number) => void
  </action>
  <verify>Check file existence and exported types/store.</verify>
  <done>useAggregationStore is ready for use.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Aggregation Manager</name>
  <files>src/components/viz/AggregationManager.tsx</files>
  <action>
    Implement a logic-only component following the ClusterManager pattern.
    - Use useDataStore to get filtered data.
    - Implement 3D binning logic using d3-array's rollup or manual loop.
    - Support "Adaptive Awareness": If timeScaleMode is 'adaptive', use computeAdaptiveY to calculate Y positions before binning.
    - Debounce the calculation (400ms) to avoid performance lag during filter changes.
    - Update useAggregationStore with the results.
    - Grid bounds should match the STC (-50 to 50 for X/Z, 0 to 100 for Y).
  </action>
  <verify>Add console.log to verify bin counts when data filters change.</verify>
  <done>AggregationManager correctly updates the store with binned data.</done>
</task>

<task type="auto">
  <name>Task 3: Mount Manager in Scene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Mount the AggregationManager in MainScene.tsx, conditionally based on the 'aggregatedBins' feature flag.
  </action>
  <verify>Verify no runtime errors when the feature flag is enabled.</verify>
  <done>AggregationManager is active in the scene.</done>
</task>

</tasks>

<verification>
- Run npm test if applicable.
- Enable 'Aggregated Bins' in Settings and check console for binning output.
</verification>

<success_criteria>
- Binned data is correctly calculated and stored.
- Calculation responds to filters and time scale changes.
</success_criteria>

<output>
After completion, create .planning/phases/19-aggregated-bins/19-01-SUMMARY.md
</output>
