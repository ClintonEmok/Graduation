---
phase: 25-adaptive-intervals
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - src/components/viz/SpaceTimeCube.tsx
  - src/components/timeline/DualTimeline.tsx
  - src/components/viz/GridLines.tsx
  - src/components/ui/Controls.tsx
autonomous: true
must_haves:
  truths:
    - "Timeline histogram bins adjust to screen pixel density (Option C)"
    - "3D points expand vertically in adaptive mode"
    - "Timeline X-axis matches 3D Z-axis perfectly"
  artifacts:
    - path: src/components/timeline/DualTimeline.tsx
      contains: "thresholds(width"
    - path: src/components/ui/Controls.tsx
      contains: "setAdaptiveMode"
  key_links:
    - from: src/hooks/useTimeWarp.ts
      to: src/components/timeline/DualTimeline.tsx
      via: "toAdaptive projection"
---

<objective>
Wire the adaptive time logic into the visualization components (Cube and Timeline).
Purpose: Reveal hidden temporal patterns by visually expanding bursty intervals.
Output: Integrated adaptive view with smart timeline binning.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/25-adaptive-intervals/25-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Toggle UI</name>
  <files>src/components/ui/Controls.tsx</files>
  <action>
    Add a Switch/Toggle component to `Controls.tsx`.
    - Label: "Adaptive Time" or "Burst View".
    - Connect to `useCoordinationStore`'s `adaptiveMode`.
  </action>
  <verify>
    Clicking toggle updates store state.
  </verify>
  <done>
    User can enable adaptive mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Warp the Space-Time Cube</name>
  <files>src/components/viz/SpaceTimeCube.tsx, src/components/viz/GridLines.tsx</files>
  <action>
    1. In `SpaceTimeCube.tsx`, use `useTimeWarp`.
    2. Update point positions: `z = toAdaptive(point.timestamp)`.
    3. Update `GridLines.tsx` (Z-axis):
       - Position ticks at visual intervals (0, 10, 20... 100).
       - Label ticks using `toLinear(z)` formatted as time.
       - This shows "How much real time passed" at each visual height.
  </action>
  <verify>
    Toggle adaptive mode:
    - Cube geometry should stretch/compress vertically.
    - Grid labels should become non-linear (e.g., large gap between 12:00 and 12:01 if bursty).
  </verify>
  <done>
    3D visualization supports adaptive time.
  </done>
</task>

<task type="auto">
  <name>Task 3: Upgrade Timeline to Adaptive Density</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>
    1. Integrate `useTimeWarp` into `DualTimeline.tsx`.
    2. **Binning Logic Update:**
       - Replace fixed `thresholds(50)` with **Screen Pixel Density** logic (Option C).
       - `const binCount = Math.max(20, Math.floor(width / 4));` // ~4px per bin
       - This ensures crisp density visualization regardless of screen size.
    3. **Coordinate System:**
       - Use `toAdaptive(timestamp)` to map events to the X-axis.
       - The X-axis must match the Cube's Z-axis (0-100 normalized adaptive time).
    4. **Axis Labels:**
       - Draw ticks at visual intervals.
       - Label using `toLinear(x)` to show real time.
  </action>
  <verify>
    - Timeline bars look crisp (not blocky) on wide screens.
    - Histogram distribution matches the 3D Z-distribution.
    - Axis labels show correct times even when warped.
  </verify>
  <done>
    Timeline uses pixel-density aware binning and supports adaptive warping.
  </done>
</task>

</tasks>

<verification>
Ensure visual alignment between Timeline X-axis and Cube Z-axis. A selected range on the timeline should correspond exactly to the vertical slice in the cube.
</verification>

<success_criteria>
- [ ] Timeline uses dynamic bin count based on width (Option C).
- [ ] 3D and 2D views stay synchronized in Adaptive Mode.
- [ ] Grid lines and Axis ticks correctly reflect non-linear time.
</success_criteria>

<output>
After completion, create `.planning/phases/25-adaptive-intervals/25-02-SUMMARY.md`
</output>
