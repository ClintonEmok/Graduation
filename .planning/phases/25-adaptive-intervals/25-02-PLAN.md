---
phase: 25-adaptive-intervals
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - src/components/viz/SpaceTimeCube.tsx
  - src/components/viz/Timeline.tsx
  - src/components/viz/GridLines.tsx
  - src/store/coordinationStore.ts
autonomous: true
must_haves:
  truths:
    - "3D points effectively move Z-position when adaptive mode is toggled"
    - "Timeline axis ticks expand/contract based on density"
    - "Trajectories remain connected (lines don't break)"
  artifacts:
    - path: src/components/viz/SpaceTimeCube.tsx
      contains: "useTimeWarp"
    - path: src/store/coordinationStore.ts
      contains: "adaptiveMode"
  key_links:
    - from: src/hooks/useTimeWarp.ts
      to: src/components/viz/SpaceTimeCube.tsx
      via: "toAdaptive(timestamp)"
---

<objective>
Wire the adaptive time warping into the 3D visualization and 2D timeline.
Purpose: Allow users to see the "Adaptive Space-Time Cube" where bursts are expanded.
Output: Working toggle for "Adaptive Mode" that updates 3D geometry and timeline scales.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/25-adaptive-intervals/25-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Adaptive Toggle to Coordination Store</name>
  <files>src/store/coordinationStore.ts, src/components/ui/Controls.tsx</files>
  <action>
    1. Add `adaptiveMode: boolean` and `setAdaptiveMode` to `coordinationStore`.
    2. Add a Switch/Toggle in the UI controls to flip this state.
  </action>
  <verify>
    Clicking toggle updates store state.
  </verify>
  <done>
    User can switch modes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply Warp to 3D Cube</name>
  <files>src/components/viz/SpaceTimeCube.tsx, src/components/viz/GridLines.tsx</files>
  <action>
    1. Integrate `useTimeWarp` into `SpaceTimeCube.tsx`.
    2. Pass the full dataset timestamps to the hook to generate the map.
    3. Update the point/line rendering loop:
       - Instead of `z = normalize(timestamp)`, use `z = toAdaptive(timestamp)`.
    4. Update `GridLines.tsx` (Z-axis ticks) to show non-linear labels:
       - The physical tick at Z=50 might represent T=30 if the first half was a lull.
       - Use `toLinear(z)` to determine what label to show at each height.
  </action>
  <verify>
    Toggle adaptive mode.
    - Bursty clusters (red/dense) should expand vertically.
    - Sparse areas should compress.
    - Total height (0-100) remains constant.
  </verify>
  <done>
    3D Cube visually deforms to reveal bursts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply Warp to Timeline</name>
  <files>src/components/viz/Timeline.tsx</files>
  <action>
    1. Integrate `useTimeWarp` into `Timeline.tsx`.
    2. The Visx scale is linear by default. We need to create a custom scale or mapping.
    3. Option A (Easiest): Keep the axis linear (showing real time), but warp the *histogram/density* bars?
       - NO, the goal is to match the 3D cube.
    4. Option B (Correct): The X-axis of the timeline should match the Z-axis of the cube.
       - Render events at `x = toAdaptive(timestamp)`.
       - Draw axis ticks at regular visual intervals (0, 10, 20... pixels) but label them using `toLinear(x)`.
       
    Implement Option B so the Timeline creates a 1:1 visual reference for the Cube.
  </action>
  <verify>
    Timeline distribution matches the 3D Z-distribution.
  </verify>
  <done>
    Timeline reflects the adaptive time scaling.
  </done>
</task>

</tasks>

<verification>
Ensure bidirectional sync works: Selecting a range on the warped timeline correctly highlights the corresponding range in the warped 3D cube.
</verification>

<success_criteria>
- [ ] Toggle switches between Linear and Adaptive views seamlessly.
- [ ] 3D Cube trajectories deform smoothly (no jumping/teleporting points).
- [ ] Timeline aligns perfectly with 3D Z-axis in both modes.
</success_criteria>

<output>
After completion, create `.planning/phases/25-adaptive-intervals/25-02-SUMMARY.md`
</output>
