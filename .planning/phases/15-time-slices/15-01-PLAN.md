---
phase: 15-time-slices
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/useSliceStore.ts
  - src/components/viz/TimeSlices.tsx
  - src/components/viz/SlicePlane.tsx
  - src/components/viz/MainScene.tsx
autonomous: true
must_haves:
  truths:
    - "System can store multiple time slice definitions"
    - "Horizontal planes appear in the 3D scene at correct Y positions"
    - "Slices respect Adaptive vs Linear time mapping"
  artifacts:
    - path: "src/store/useSliceStore.ts"
      provides: "Zustand store for slices"
    - path: "src/components/viz/TimeSlices.tsx"
      provides: "Manager component rendering SlicePlanes"
  key_links:
    - from: "src/components/viz/TimeSlices.tsx"
      to: "src/store/useSliceStore.ts"
      via: "useSliceStore hook"
---

<objective>
Implement the foundational data structure and 3D rendering for Time Slices.

Purpose: Allow users to create and visualize horizontal reference planes in the Space-Time Cube.
Output: Working Slice Store and 3D rendering of planes (without UI controls yet).
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-time-slices/15-CONTEXT.md
@.planning/phases/15-time-slices/15-RESEARCH.md
@src/components/viz/MainScene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Slice Store</name>
  <files>src/store/useSliceStore.ts</files>
  <action>
    Create a Zustand store `useSliceStore` to manage time slices.
    
    Interface:
    - `slices: TimeSlice[]` where `TimeSlice` has `{ id: string, time: number, isLocked: boolean, isVisible: boolean }`.
    - `addSlice(time: number)`: Adds a new slice at the given normalized time (0-100).
    - `removeSlice(id: string)`: Removes a slice.
    - `updateSlice(id: string, updates: Partial<TimeSlice>)`: Updates properties.
    - `toggleLock(id: string)`: Helper to toggle lock state.
    - `toggleVisibility(id: string)`: Helper to toggle visibility.
    - `clearSlices()`: Removes all slices.
    
    Persist to localStorage using `persist` middleware (key: 'slice-store-v1').
  </action>
  <verify>
    Create a temporary test script or check file existence.
    `cat src/store/useSliceStore.ts` should show the interface.
  </verify>
  <done>Store exists with defined actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create 3D Slice Components</name>
  <files>src/components/viz/SlicePlane.tsx, src/components/viz/TimeSlices.tsx</files>
  <action>
    1. Create `SlicePlane.tsx`:
       - Props: `slice: TimeSlice`, `y: number` (calculated Y position), `onUpdate: (time: number) => void`.
       - Render: A horizontal plane (`PlaneGeometry`) at `[0, y, 0]`.
       - Visuals: Semi-transparent (opacity ~0.2), distinct color (e.g., cyan/blue to differ from current time plane).
       - Interaction:
         - Implement dragging using `@use-gesture/react` or `react-three-fiber` events.
         - On drag, calculate new Y, invert to Time, call `onUpdate`.
         - If `slice.isLocked`, disable dragging.
         - Show a "Handle" mesh (sphere/cone) on the axis for easier grabbing.
         - Show a Label (using `@react-three/drei` Html) near the handle displaying the time/date.

    2. Create `TimeSlices.tsx` (Manager):
       - Connects to `useSliceStore`.
       - Uses `useDataStore` to get data for adaptive scaling.
       - Uses `d3-scale` (linear or polylinear via `getAdaptiveScaleConfig`) to map `slice.time` -> `y`.
       - Renders `<SlicePlane />` for each slice.
       - Handles the inverse mapping (Y -> Time) for drag updates.
  </action>
  <verify>
    Files exist and import necessary dependencies.
  </verify>
  <done>Components created and linked.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into MainScene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Import `TimeSlices` in `MainScene.tsx`.
    Add `<TimeSlices />` inside the `<Scene>` component, alongside `<TimePlane />` and `<DataPoints />`.
    Ensure it's rendered in both Abstract and Map modes (if appropriate, or just Abstract). Context says "Standard 3D Cube", so likely visible in both if the cube is visible.
  </action>
  <verify>
    `grep "TimeSlices" src/components/viz/MainScene.tsx` returns matches.
  </verify>
  <done>TimeSlices component is mounted in the scene.</done>
</task>

</tasks>

<verification>
Verify that the application compiles and the store is accessible.
Since there is no UI yet, manual verification of adding slices is not possible without dev tools, but the code structure is verifiable.
</verification>

<success_criteria>
- Store manages slice state.
- 3D components render planes based on store state.
- Slices adapt to current time scale mode (Linear/Adaptive).
</success_criteria>

<output>
After completion, create .planning/phases/15-time-slices/15-01-SUMMARY.md
</output>
