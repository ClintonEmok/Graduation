---
phase: 30-timeline-adaptive-time-scaling
plan: 03
type: execute
wave: 1
depends_on: ["30-02"]
files_modified:
  - src/app/timeline-test/page.tsx
  - src/app/timeline-test/components/CommittedSliceLayer.tsx
  - src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx
  - src/app/timeline-test/components/SliceCreationLayer.tsx
autonomous: true

must_haves:
  truths:
    - "Slice creation works in both Linear and Adaptive modes"
    - "Slice boundaries display correctly in Adaptive mode"
    - "Slice manipulation (drag handles) works in both modes"
    - "Timeline has subtle gradient tint when in adaptive mode"
  artifacts:
    - path: "src/app/timeline-test/page.tsx"
      provides: "Timeline container with adaptive mode indicator"
    - path: "src/app/timeline-test/components/CommittedSliceLayer.tsx"
      provides: "Slice overlay in adaptive mode"
    - path: "src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx"
      provides: "Handles work in adaptive mode"
    - path: "src/app/timeline-test/components/SliceCreationLayer.tsx"
      provides: "Creation preview works in adaptive mode"
  key_links:
    - from: "CommittedSliceLayer.tsx"
      to: "DualTimeline scale"
      via: "receives scale prop, must work with adaptive scale"
    - from: "SliceCreationLayer.tsx"
      to: "DualTimeline scale"
      via: "receives scale prop, must work with adaptive scale"
    - from: "SliceBoundaryHandlesLayer.tsx"
      to: "DualTimeline scale"
      via: "receives scale prop, must work with adaptive scale"
---

<objective>
Ensure all slice functionality works correctly in both Linear and Adaptive modes, and add visual polish.

Purpose: Slice creation, display, and manipulation must work identically regardless of time scale mode. Also add subtle visual indicators for adaptive mode on the timeline axis.

Output: All slice features functional in both modes with visual polish.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/app/timeline-test/page.tsx
@src/app/timeline-test/components/CommittedSliceLayer.tsx
@src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx
@src/app/timeline-test/components/SliceCreationLayer.tsx
@src/components/timeline/DualTimeline.tsx
</context>

<tasks>

<task type="auto">
  <name>Add adaptive mode visual indicator to timeline axis</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>
In DualTimeline.tsx, add a subtle gradient tint to the axis area when in adaptive mode:

1. Add a gradient definition in the SVG (use @visx/gradient or native SVG defs)
2. Apply a subtle amber/yellow gradient overlay to the axis group when timeScaleMode === 'adaptive'
3. The tint should be very subtle (low opacity) - it's a visual indicator, not the main feature

Example approach:
- Add a gradient ID: "adaptiveAxisGradient"
- In the axis rendering, add a rectangle behind ticks with the gradient fill
- Use very low opacity (0.05-0.1) so it's barely visible
  </action>
  <verify>Axis shows subtle gradient tint only in adaptive mode.</verify>
  <done>Timeline axis has subtle visual indicator when in adaptive mode.</done>
</task>

<task type="auto">
  <name>Wire slice layers to work with adaptive scale</name>
  <files>
    src/app/timeline-test/page.tsx
    src/app/timeline-test/components/CommittedSliceLayer.tsx
    src/app/timeline-test/components/SliceBoundaryHandlesLayer.tsx
    src/app/timeline-test/components/SliceCreationLayer.tsx
  </files>
  <action>
The slice layers receive a scale prop from timeline-test/page.tsx. Currently page.tsx creates a linear scaleUtc():

```typescript
const detailXScale = useMemo(
  () =>
    scaleUtc()
      .domain([new Date(detailRangeSec[0] * 1000), new Date(detailRangeSec[1] * 1000)])
      .range([0, detailInnerWidth]),
  [detailInnerWidth, detailRangeSec]
);
```

This needs to use the same adaptive scaling logic as DualTimeline. However, since the slice layers are overlaying the DualTimeline's detail view, and DualTimeline internally handles its own scale, the slice layers need to match that behavior.

Options:
1. (Preferred) The slice layers should receive the same timeScaleMode and warpFactor props and apply the same adaptive transformation to their scale
2. Or, pass the scale computation down from DualTimeline

The cleanest approach is to have the page compute the scale with adaptive support and pass it down. But since DualTimeline already does this internally, we need to ensure consistency.

For now, the simplest fix: The slice layers should work with the linear scale for positioning slices. The key insight is:
- Slices are stored as epoch seconds in useSliceStore
- The scale converts epoch seconds to x positions
- If DualTimeline's internal scale applies warping, the slice layers should use the same warped scale

Update page.tsx to:
1. Import useTimeStore and useAdaptiveStore
2. Create detailXScale with the same adaptive warping logic as DualTimeline (or import a shared helper)
3. Pass timeScaleMode and warpFactor to the slice layers so they can apply the same warping

For the slice layers (CommittedSliceLayer, SliceBoundaryHandlesLayer, SliceCreationLayer):
- Import useTimeStore and useAdaptiveStore
- Apply the same adaptive warping to the scale they receive/use
- This ensures slice positions align with the visual timeline in adaptive mode
  </action>
  <verify>Build passes. Slice creation, display, and boundary adjustment all work in both modes.</verify>
  <done>All slice functionality works identically in Linear and Adaptive modes.</done>
</task>

</tasks>

<verification>
- Run `npm run build` or `npx tsc --noEmit` to verify no TypeScript errors
- Test slice creation in Linear mode
- Test slice creation in Adaptive mode
- Test slice boundary adjustment in both modes
- Verify slices appear at correct positions in both modes
</verification>

<success_criteria>
- Slice creation works in both modes
- Slice boundaries display at correct positions in Adaptive mode
- Boundary handles can be dragged in both modes
- Subtle visual indicator shows Adaptive mode on timeline
- No visual misalignment between slices and timeline in either mode
</success_criteria>

<output>
After completion, create `.planning/phases/30-timeline-adaptive-time-scaling/30-03-SUMMARY.md`
</output>
