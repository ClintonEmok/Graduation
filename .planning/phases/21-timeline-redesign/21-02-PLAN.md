---
phase: 21-timeline-redesign
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified: [src/utils/binning.ts, src/components/timeline/layers/HistogramLayer.tsx, src/components/timeline/layers/AxisLayer.tsx, src/components/timeline/Timeline.tsx]
autonomous: true
must_haves:
  truths:
    - "Histogram displays data distribution"
    - "Axis shows time labels"
    - "Data is correctly binned"
  artifacts:
    - path: "src/utils/binning.ts"
      provides: "D3 binning logic"
    - path: "src/components/timeline/layers/HistogramLayer.tsx"
      provides: "Bar chart visualization"
    - path: "src/components/timeline/layers/AxisLayer.tsx"
      provides: "Time axis"
  key_links:
    - from: "src/components/timeline/Timeline.tsx"
      to: "src/utils/binning.ts"
      via: "import"
---

<objective>
Implement the visual core of the timeline: the Histogram layer (Focus) and the Time Axis.
Purpose: Visualize the temporal distribution of data to give users context.
Output: A rendered histogram with a time axis in the Timeline component.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/timeline/Timeline.tsx
@.planning/phases/21-timeline-redesign/21-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Binning Logic</name>
  <files>src/utils/binning.ts</files>
  <action>
    Create `src/utils/binning.ts`.
    Export a function `binTimeData` that uses `d3-array`'s `bin()`.
    
    Inputs: 
    - `data`: Array of objects (e.g., CrimeData).
    - `accessor`: Function to get date/timestamp.
    - `domain`: [start, end] Date/number.
    - `ticks`: Desired number of bins (approx).
    
    Returns: Array of bins with `x0`, `x1`, and `length`.
  </action>
  <verify>
    Create a temporary test file or check with node repl.
  </verify>
  <done>Function exports correct bin structure</done>
</task>

<task type="auto">
  <name>Task 2: Create Histogram and Axis Layers</name>
  <files>src/components/timeline/layers/HistogramLayer.tsx, src/components/timeline/layers/AxisLayer.tsx</files>
  <action>
    1. `HistogramLayer.tsx`:
       - Props: `bins` (from utils), `xScale`, `yScale`, `height`.
       - Render `<Bar>` from `@visx/shape` for each bin.
       - Use a color from the project palette (e.g., primary/accent).
    
    2. `AxisLayer.tsx`:
       - Props: `scale`, `height` (for positioning at bottom).
       - Use `AxisBottom` from `@visx/axis`.
       - Style ticks and labels to be "Detailed" (white/gray, small font).
  </action>
  <verify>
    Check imports from @visx.
  </verify>
  <done>Components created.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into Timeline</name>
  <files>src/components/timeline/Timeline.tsx</files>
  <action>
    Update `Timeline.tsx`:
    1. Import `useTimeStore` or accept props for the full data range/dataset.
    2. Create scales:
       - `xScale`: `scaleTime` domain [min, max], range [0, width].
       - `yScale`: `scaleLinear` based on max bin length.
    3. Compute bins using `binTimeData` inside `useMemo`.
    4. Render `HistogramLayer` and `AxisLayer` inside the SVG.
  </action>
  <verify>
    Run app, check if bars appear.
  </verify>
  <done>Timeline shows bars and dates.</done>
</task>

</tasks>

<verification>
- Histogram bars align with axis ticks.
- Resizing works (inherited from 01).
</verification>

<success_criteria>
- [ ] Binning utility works
- [ ] Histogram renders
- [ ] Axis renders
</success_criteria>

<output>
After completion, create .planning/phases/21-timeline-redesign/21-02-SUMMARY.md
</output>
