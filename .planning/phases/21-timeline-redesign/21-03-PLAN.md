---
phase: 21-timeline-redesign
plan: 03
type: execute
wave: 3
depends_on: [21-02]
files_modified: [src/components/timeline/TimelineBrush.tsx, src/components/timeline/layers/MarkerLayer.tsx, src/components/timeline/Timeline.tsx, src/components/ui/TimeControls.tsx]
autonomous: true
must_haves:
  truths:
    - "User can zoom/select range via brush"
    - "User can toggle between Histogram and Markers"
    - "Clicking a histogram bar selects the bin range"
    - "New Timeline replaces the old slider in controls"
  artifacts:
    - path: "src/components/timeline/TimelineBrush.tsx"
      provides: "Brush interaction"
    - path: "src/components/timeline/layers/MarkerLayer.tsx"
      provides: "Dot visualization"
  key_links:
    - from: "src/components/ui/TimeControls.tsx"
      to: "src/components/timeline/Timeline.tsx"
      via: "Composition"
---

<objective>
Complete the Timeline by adding the Brush interaction, Marker visualization, and integrating it into the main TimeControls UI.
Purpose: Finalize the "Focus+Context" redesign and replace the old slider.
Output: Fully functional and integrated Timeline component.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/timeline/Timeline.tsx
@src/components/ui/TimeControls.tsx
@.planning/phases/21-timeline-redesign/21-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Brush and Marker Components</name>
  <files>src/components/timeline/TimelineBrush.tsx, src/components/timeline/layers/MarkerLayer.tsx</files>
  <action>
    1. `TimelineBrush.tsx`:
       - Use `@visx/brush`.
       - Props: `xScale`, `yScale`, `width`, `height`, `onChange`.
       - Style: Semi-transparent selection, visible handles.
    
    2. `MarkerLayer.tsx`:
       - Props: `data`, `xScale`, `height`.
       - Render simple circles (`<circle r={2} />`) for each data point.
       - Use `React.memo` to prevent re-renders if data doesn't change.
  </action>
  <verify>
    Files compile.
  </verify>
  <done>Components exist.</done>
</task>

<task type="auto">
  <name>Task 2: Assemble Timeline with Interaction Logic</name>
  <files>src/components/timeline/Timeline.tsx</files>
  <action>
    Update `Timeline.tsx`:
    1. Add state `viewMode` ('histogram' | 'markers').
    2. Render `TimelineBrush` on top of layers.
    3. **Bug Fix Logic**:
       - In `HistogramLayer` (pass `onBarClick` prop): `onBarClick={(bin) => onChange([bin.x0, bin.x1])}`.
       - In `TimelineBrush`: `onChange={(domain) => onChange(domain)}`.
    4. Add a toggle button (icon based) to switch `viewMode` (absolute positioned or passed to container).
    
    Ensure `Timeline` accepts `data`, `timeRange`, and `onChange` props to be controlled by the parent.
  </action>
  <verify>
    Timeline accepts props and renders layers.
  </verify>
  <done>Timeline is interactive.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into TimeControls</name>
  <files>src/components/ui/TimeControls.tsx</files>
  <action>
    Update `src/components/ui/TimeControls.tsx`:
    1. Import `TimelineContainer` (from Plan 01).
    2. Replace the `div` with comment `/* Main Time Slider (temporarily removed) */` with the new Timeline.
    3. Connect `Timeline` inside the container to `useTimeStore`.
       - `data`: You might need to fetch `data` or pass it down. If `useTimeStore` doesn't have raw data, you might need to subscribe to the data store (e.g. `useCrimeStore` or similar) or `useSliceStore`.
       - *Note*: If data isn't available in TimeControls, you might need to lift this connection or import the hook.
    4. Ensure the layout works (Timeline fits in the bottom bar).
    
    *Mobile Note*: `TimelineContainer` handles its own mobile hiding, but `TimeControls` might also need a `md:flex` adjustment if the whole bar should change.
  </action>
  <verify>
    App loads with new timeline.
  </verify>
  <done>Integration complete.</done>
</task>

</tasks>

<verification>
- Brush works.
- Histogram clicks select range.
- Toggle switches views.
</verification>

<success_criteria>
- [ ] TimelineBrush implemented
- [ ] MarkerLayer implemented
- [ ] View toggle works
- [ ] Single point selection bug fixed
- [ ] New Timeline replaces old slider
</success_criteria>

<output>
After completion, create .planning/phases/21-timeline-redesign/21-03-SUMMARY.md
</output>
