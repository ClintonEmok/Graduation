---
phase: 05-adaptive-visualization-aids
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/hooks/useAdaptiveScale.ts
  - src/components/timeline/DensityHistogram.tsx
  - src/components/timeline/AdaptiveAxis.tsx
autonomous: true
must_haves:
  truths:
    - "Histogram renders bars representing event density"
    - "Axis renders ticks that respect the adaptive distortion"
    - "Components react to timeScaleMode changes"
  artifacts:
    - path: "src/hooks/useAdaptiveScale.ts"
      provides: "useAdaptiveScale hook"
    - path: "src/components/timeline/DensityHistogram.tsx"
      provides: "DensityHistogram component"
    - path: "src/components/timeline/AdaptiveAxis.tsx"
      provides: "AdaptiveAxis component"
  key_links:
    - from: "src/components/timeline/DensityHistogram.tsx"
      to: "src/hooks/useAdaptiveScale.ts"
      via: "calls hook"
---

<objective>
Build the visualization components (Histogram and Axis) that will display the adaptive time scale.

Purpose: To provide visual feedback on how time is distorted in the 3D view.
Output: React components for the Density Histogram and Adaptive Axis.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/lib/adaptive-scale.ts
@src/store/useDataStore.ts
@src/store/useTimeStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Adaptive Scale Hook</name>
  <files>src/hooks/useAdaptiveScale.ts</files>
  <action>
    Create a hook `useAdaptiveScale(width: number)` that:
    1. Gets `data` from `useDataStore`.
    2. Gets `timeRange` and `timeScaleMode` from `useTimeStore`.
    3. Uses `getAdaptiveScaleConfig` (from Task 1) to build a D3 linear scale (`scaleLinear`).
    4. Supports switching between 'linear' (Uniform) and 'adaptive' modes.
       - Linear: domain=[min, max], range=[0, width]
       - Adaptive: domain=[...bins], range=[...pixels]
    5. Returns the current `scale` object.
    
    *Note: For now, instant switching is acceptable. Smooth animation can be added if time permits or in a refinement.*
  </action>
  <verify>Cat the file to verify hook structure and D3 scale creation</verify>
  <done>Hook exists and returns a D3 scale</done>
</task>

<task type="auto">
  <name>Task 2: Create Density Histogram Component</name>
  <files>src/components/timeline/DensityHistogram.tsx</files>
  <action>
    Create `DensityHistogram` component:
    - Props: `width`, `height`.
    - Uses `useAdaptiveScale` to get the X-scale.
    - Uses `useDataStore` for data.
    - Bins the data using `d3-array.bin()`.
    - Renders SVG rects (bars).
    - Height of bars = count.
    - Width/Position of bars determined by the `scale`.
      - `x = scale(bin.x0)`
      - `width = scale(bin.x1) - scale(bin.x0)`
    - This ensures that in Adaptive mode, dense bins (which span 'more' pixel space) appear wider, visually reinforcing the expansion.
  </action>
  <verify>Check for SVG rendering code</verify>
  <done>Component renders svg with bars based on scale</done>
</task>

<task type="auto">
  <name>Task 3: Create Adaptive Axis Component</name>
  <files>src/components/timeline/AdaptiveAxis.tsx</files>
  <action>
    Create `AdaptiveAxis` component:
    - Props: `width`, `height`.
    - Uses `useAdaptiveScale`.
    - Uses `@visx/axis`'s `AxisBottom`.
    - Passes the scale to `AxisBottom`.
    - Implement a custom tick filter strategy if needed (or rely on `AxisBottom`'s `numTicks` or `tickValues`).
      - Since adaptive scales can crunch ticks together, ensure we don't have overlapping text.
      - Use `hideTicks` or dynamic `tickValues` based on the scale distribution.
  </action>
  <verify>Check for AxisBottom usage</verify>
  <done>Component renders AxisBottom with adaptive scale</done>
</task>

</tasks>

<verification>
- Verify hook returns valid scales.
- Verify components import correct dependencies.
</verification>

<success_criteria>
- Histogram and Axis components created.
- They consume the adaptive scale logic.
</success_criteria>

<output>
After completion, create `.planning/phases/05-adaptive-visualization-aids/05-02-SUMMARY.md`
</output>
