---
phase: 05-adaptive-visualization-aids
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/store/useDataStore.ts
  - src/lib/adaptive-scale.ts
  - src/components/viz/MainScene.tsx
autonomous: true
must_haves:
  truths:
    - "Data is accessible globally via useDataStore"
    - "Adaptive scale logic can produce D3-compatible domains/ranges"
    - "MainScene renders points from the store instead of local state"
  artifacts:
    - path: "src/store/useDataStore.ts"
      provides: "Global access to crime event data"
    - path: "src/lib/adaptive-scale.ts"
      exports: ["getAdaptiveScaleConfig", "computeAdaptiveY"]
  key_links:
    - from: "src/components/viz/MainScene.tsx"
      to: "src/store/useDataStore.ts"
      via: "useDataStore hook"
---

<objective>
Establish the data foundation and scale logic required for adaptive visualizations.

Purpose: To enable the Timeline components to access the same data and scale logic as the 3D scene.
Output: A global data store and a refactored scale utility that produces D3-compatible configurations.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/viz/MainScene.tsx
@src/lib/adaptive-scale.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Visualization Dependencies</name>
  <files>package.json</files>
  <action>
    Install the necessary libraries for D3-in-React visualization:
    - `npm install @visx/axis @visx/scale @visx/shape @visx/group @visx/responsive d3-array d3-scale`
    - Install types if needed: `npm install -D @types/d3-array @types/d3-scale`
  </action>
  <verify>npm list @visx/axis d3-scale</verify>
  <done>Dependencies installed and package.json updated</done>
</task>

<task type="auto">
  <name>Task 2: Create Data Store</name>
  <files>src/store/useDataStore.ts</files>
  <action>
    Create a Zustand store `useDataStore` that:
    1. Holds the `data` array (CrimeEvent[]).
    2. Includes an `initializeData(count: number)` action that calls `generateMockData` (moved from MainScene logic).
    3. Initially generates 1000 points.
    
    Move the `generateMockData` import/usage from MainScene to here.
  </action>
  <verify>Cat the file to check for store definition and initializeData action</verify>
  <done>Store exists and exports useDataStore</done>
</task>

<task type="auto">
  <name>Task 3: Refactor Adaptive Scale Logic</name>
  <files>src/lib/adaptive-scale.ts</files>
  <action>
    Update `src/lib/adaptive-scale.ts` to export a new function:
    `export function getAdaptiveScaleConfig(data: TimePoint[], timeRange: [Date, Date], range: [number, number])`
    
    This function should:
    1. Perform the same binning and weight calculation as `computeAdaptiveY`.
    2. Return `{ domain: number[], range: number[] }` suitable for a polylinear D3 scale.
       - Domain: The input timestamp values (as numbers) at bin boundaries.
       - Range: The output pixel/unit values at bin boundaries.
    
    Refactor (or keep) `computeAdaptiveY` to ensure it stays consistent with this logic (e.g., it could use the config internally, or just share the core math).
  </action>
  <verify>Check file for getAdaptiveScaleConfig export</verify>
  <done>getAdaptiveScaleConfig function is exported and implements polylinear logic</done>
</task>

<task type="auto">
  <name>Task 4: Integrate Data Store into MainScene</name>
  <files>src/components/viz/MainScene.tsx</files>
  <action>
    Modify `MainScene.tsx` to:
    1. Remove local `useState` for data.
    2. Use `useDataStore` to get `data`.
    3. Call `initializeData(1000)` on mount (useEffect).
    4. Ensure `DataPoints` receives the data from the store.
  </action>
  <verify>grep "useDataStore" src/components/viz/MainScene.tsx</verify>
  <done>MainScene uses global store for data</done>
</task>

</tasks>

<verification>
- Verify dependencies are installed.
- Verify `useDataStore` has data.
- Verify `MainScene` compiles and uses the store.
</verification>

<success_criteria>
- Dependencies installed.
- Data is lifted to global state.
- Scale logic supports D3 scale generation.
</success_criteria>

<output>
After completion, create `.planning/phases/05-adaptive-visualization-aids/05-01-SUMMARY.md`
</output>
