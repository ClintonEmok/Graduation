---
phase: 14-accessibility
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified:
  - src/components/viz/Scene.tsx
  - src/components/viz/DataPoints.tsx
  - src/components/viz/Controls.tsx
autonomous: true
must_haves:
  truths:
    - "3D scene background matches the selected theme"
    - "Data points use the colorblind palette when selected"
    - "Fog matches the background color"
  artifacts:
    - path: "src/components/viz/DataPoints.tsx"
      provides: "Themed 3D point rendering"
  key_links:
    - from: "src/components/viz/Scene.tsx"
      to: "src/store/useThemeStore.ts"
      via: "useThemeStore"
---

<objective>
Connect the 3D Visualization components to the theme store to enable dynamic coloring of the scene and data points.

Purpose: Ensure the 3D view is accessible and consistent with the UI theme.
Output: Dynamic 3D scene colors.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/14-accessibility/14-RESEARCH.md
@src/components/viz/Scene.tsx
@src/components/viz/DataPoints.tsx
@src/lib/palettes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Themed Scene Background</name>
  <files>src/components/viz/Scene.tsx</files>
  <action>
    1. Import `useThemeStore` and `PALETTES`.
    2. Retrieve `theme` from store.
    3. Determine background color: `PALETTES[theme].background`.
    4. Replace hardcoded `#000000` in `<color attach="background" ... />` with the dynamic color.
    5. (Optional) Add `<fog attach="fog" ... />` with the same color to blend distance.
  </action>
  <verify>
    grep "useThemeStore" src/components/viz/Scene.tsx
  </verify>
  <done>
    Scene background updates with theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Themed Data Points</name>
  <files>src/components/viz/DataPoints.tsx</files>
  <action>
    1. Import `useThemeStore` and `PALETTES`.
    2. Replace the hardcoded `COLOR_MAP` constant with a dynamic lookup inside the component (or memoized).
    3. `const colorMap = PALETTES[theme].categoryColors`.
    4. Ensure the `useEffect` or `useMemo` that generates `instanceColor` depends on `theme` (or the color map).
    5. Trigger a re-computation of colors when the theme changes.
  </action>
  <verify>
    grep "PALETTES" src/components/viz/DataPoints.tsx
  </verify>
  <done>
    Data points change color when theme switches to "Colorblind".
  </done>
</task>

</tasks>

<verification>
- Switch theme to Light: Background should be white/light.
- Switch theme to Colorblind: Data points should use distinct, high-contrast colors (e.g., Blue/Orange/Teal instead of Red/Green).
</verification>

<success_criteria>
- Scene background responds to theme.
- Data point colors respond to theme.
</success_criteria>
