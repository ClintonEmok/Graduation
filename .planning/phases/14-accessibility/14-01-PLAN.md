---
phase: 14-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/useThemeStore.ts
  - src/lib/palettes.ts
  - src/components/settings/SettingsPanel.tsx
  - src/app/globals.css
  - src/app/layout.tsx
autonomous: true
must_haves:
  truths:
    - "User can select between Light, Dark, and Colorblind themes"
    - "Theme choice persists in localStorage"
    - "UI components (shadcn) update colors immediately"
  artifacts:
    - path: "src/store/useThemeStore.ts"
      provides: "Global theme state management"
    - path: "src/lib/palettes.ts"
      provides: "Color definitions for 3D and Map"
  key_links:
    - from: "src/components/settings/SettingsPanel.tsx"
      to: "src/store/useThemeStore.ts"
      via: "setTheme action"
---

<objective>
Establish the core theming infrastructure and allow users to switch themes via the Settings panel.

Purpose: Provide the foundation for accessible color modes.
Output: Working theme switcher affecting UI elements.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/14-accessibility/14-RESEARCH.md
@src/components/settings/SettingsPanel.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Palettes and Store</name>
  <files>src/lib/palettes.ts, src/store/useThemeStore.ts</files>
  <action>
    1. Create `src/lib/palettes.ts`:
       - Define `Theme` type ('light' | 'dark' | 'colorblind').
       - Export `PALETTES` object mapping themes to configuration (background color, map style URL, categorical colors).
       - Use Okabe-Ito colors for the 'colorblind' palette.
    
    2. Create `src/store/useThemeStore.ts`:
       - Use `zustand` with `persist`.
       - State: `theme: Theme`.
       - Actions: `setTheme(theme: Theme)`.
       - Hook: `useThemeStore`.
  </action>
  <verify>
    test -f src/lib/palettes.ts && test -f src/store/useThemeStore.ts
  </verify>
  <done>
    Store and Palette definitions exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Store with Layout</name>
  <files>src/app/layout.tsx</files>
  <action>
    1. Create a client component `src/components/layout/ThemeProvider.tsx`:
       - Subscribes to `useThemeStore`.
       - Updates `document.documentElement` classList ('dark' vs 'light').
       - Adds `data-theme` attribute for custom overrides.
    2. Import and wrap `ThemeProvider` in `src/app/layout.tsx`.
  </action>
  <verify>
    grep "ThemeProvider" src/app/layout.tsx
  </verify>
  <done>
    Root layout applies the selected theme class/attribute.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Settings Panel</name>
  <files>src/components/settings/SettingsPanel.tsx</files>
  <action>
    1. Import `useThemeStore`.
    2. Add a new section "Appearance" or "Accessibility".
    3. Add a `Select` or `RadioGroup` to choose between "Dark (Default)", "Light", and "Colorblind Safe".
    4. Call `setTheme` on change.
  </action>
  <verify>
    grep "setTheme" src/components/settings/SettingsPanel.tsx
  </verify>
  <done>
    Settings panel allows switching themes.
  </done>
</task>

</tasks>

<verification>
- Manual: Open settings, switch to Light mode, verify background changes to white (if globals.css handles it).
- Verify localStorage key 'theme-storage' exists.
</verification>

<success_criteria>
- Theme store created.
- Palettes defined.
- Settings panel controls the theme.
</success_criteria>
