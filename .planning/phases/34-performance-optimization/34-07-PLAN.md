---
phase: 34-performance-optimization
plan: 07
type: execute
wave: 2
depends_on:
  - 34-06
files_modified:
  - src/components/viz/SimpleCrimePoints.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "3D cube displays crime points from useCrimeData"
    - "Points update when viewport changes"
    - "No direct DataStore dependency"
  artifacts:
    - path: "src/components/viz/SimpleCrimePoints.tsx"
      provides: "3D crime points using unified useCrimeData hook"
  key_links:
    - from: "src/components/viz/SimpleCrimePoints.tsx"
      to: "src/hooks/useCrimeData.ts"
      via: "imports and uses useCrimeData hook"
---

<objective>
Update SimpleCrimePoints (3D cube) to use unified useCrimeData hook.

Purpose: Connect 3D visualization to viewport-based data layer.
Output: SimpleCrimePoints consumes useCrimeData instead of DataStore.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
**Depends on:** 34-06 (canonical types and useCrimeData hook)

**Gap closure reason:** SimpleCrimePoints currently gets data from DataStore, not viewport-based. Needs to use useCrimeData hook.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SimpleCrimePoints to use useCrimeData</name>
  <files>src/components/viz/SimpleCrimePoints.tsx</files>
  <action>
Update src/components/viz/SimpleCrimePoints.tsx:

1. Remove import of data from useDataStore
2. Import useCrimeData from @/hooks/useCrimeData
3. Import CrimeRecord from @/types/crime

4. Replace data source:
```typescript
// Before:
const data = useDataStore((state) => state.data);

// After:
const { data: crimeRecords, isLoading } = useCrimeData({
  startEpoch: viewportStart,
  endEpoch: viewportEnd,
});

// Convert CrimeRecord[] to format needed for rendering
const data = crimeRecords || [];
```

5. Handle canonical CrimeRecord format in rendering:
   - Use record.timestamp for time
   - Use record.x, record.z for position
   - Use record.type for color

6. Keep existing:
   - LOD sampling logic
   - Color palette mapping
   - Filtering by crime type/district
   - Theme handling

7. Handle loading state:
   - Show skeleton or nothing while loading
   - Don't block rendering if data is empty
</action>
<verify>
- SimpleCrimePoints uses useCrimeData hook
- Points render from viewport-based data
- TypeScript compiles without errors
- No runtime errors from field mismatches
  </verify>
  <done>
SimpleCrimePoints updated to use unified useCrimeData hook
  </done>
</task>

</tasks>

<verification>
- 3D cube shows points from useCrimeData
- Points update when viewport changes (brush/zoom)
- No DataStore dependency for crime data
</verification>

<success_criteria>
- 3D visualization connected to viewport-based data
- Single source of truth for crime data
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-optimization/34-07-SUMMARY.md`
</output>
