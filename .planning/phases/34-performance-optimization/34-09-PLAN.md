---
phase: 34-performance-optimization
plan: 09
type: execute
wave: 4
depends_on:
  - 34-07
  - 34-08
files_modified:
  - src/store/dataStore.ts
  - src/app/api/crimes/range/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "DataStore holds only metadata (no crime data array)"
    - "API no longer has mock data fallback"
    - "All crime data flows through useCrimeData"
  artifacts:
    - path: "src/store/dataStore.ts"
      provides: "Metadata only - min/max times, bounds, filter options"
    - path: "src/app/api/crimes/range/route.ts"
      provides: "DuckDB queries without mock fallback"
  key_links:
    - from: "src/store/dataStore.ts"
      to: "src/hooks/useCrimeData.ts"
      via: "metadata only, no data array"
---

<objective>
Clean up DataStore and remove mock data fallback.

Purpose: Consolidate data flow through useCrimeData hook. DataStore keeps only metadata.
Output: Clean data architecture with single source of truth.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
**Depends on:** 34-07 and 34-08 (visualizations updated)

**Gap closure reason:** Clean up legacy data stores now that all components use useCrimeData.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up DataStore - keep metadata only</name>
  <files>src/store/dataStore.ts</files>
<action>
Update src/store/dataStore.ts:

1. Remove crime data array from store state
2. Keep only metadata:
   - minTimestampSec, maxTimestampSec (date range)
   - minX, maxX, minZ, maxZ (spatial bounds)
   - crimeTypes[] (filter options)
   - districts[] (filter options)
   - dataCount (total records)
   - isMock (whether using real data)
   - columns (column metadata)

3. Remove:
   - data array
   - dataLoading state
   - generateMockData function (or keep for dev only)

4. Keep:
   - fetchMetadata function (for loading min/max, counts)
   - Filter-related state if used elsewhere

The store should only provide metadata for UI (ranges, counts, filter options).
</action>
<verify>
- DataStore no longer has data array
- TypeScript compiles without errors
- Other components that need metadata still work
  </verify>
  <done>
DataStore cleaned - metadata only, no crime data array
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove mock data fallback from API</name>
<files>src/app/api/crimes/range/route.ts</files>
<action>
Update src/app/api/crimes/range/route.ts:

1. Remove mock data generation/import
2. Remove X-Data-Warning header
3. Remove try/catch that falls back to mock
4. If DuckDB fails, return proper error (500) instead of mock

The API should either:
- Return real data from DuckDB
- Return error (500) with message

No more silent fallback to mock data.
</action>
<verify>
- API no longer returns mock data
- Errors are properly returned as 500
- TypeScript compiles without errors
  </verify>
  <done>
API cleaned - no mock data fallback
  </done>
</task>

</tasks>

<verification>
- DataStore has no crime data array
- API fails properly instead of using mock
- All data flows through useCrimeData
</verification>

<success_criteria>
- Clean data architecture
- Single source of truth (useCrimeData -> DuckDB)
- No legacy mock data paths
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-optimization/34-09-SUMMARY.md`
</output>
