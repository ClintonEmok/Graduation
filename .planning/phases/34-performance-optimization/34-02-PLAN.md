---
phase: 34-performance-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db.ts
  - src/lib/queries.ts
autonomous: true

must_haves:
  truths:
    - "Time-range queries only scan relevant data chunks (zone map optimization)"
    - "Queries execute faster due to sorted data"
    - "Date-sorted table exists for crime data"
  artifacts:
    - path: "src/lib/db.ts"
      provides: "DuckDB initialization with sorted table creation"
      exports: ["getDb", "ensureSortedCrimesTable"]
    - path: "src/lib/queries.ts"
      provides: "Pre-optimized query functions for viewport loading"
      exports: ["queryCrimesInRange", "queryCrimeCount", "queryDensityBins"]
  key_links:
    - from: "src/lib/queries.ts"
      to: "src/lib/db.ts"
      via: "getDb() call"
      pattern: "getDb.*queryCrimesInRange"
---

<objective>
Optimize DuckDB queries for time-range operations on 8.4M records.

Purpose: Create sorted table for zone map optimization so time-range queries only scan relevant data chunks, not the entire dataset.
Output: Optimized DuckDB setup with pre-sorted table and efficient query functions.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-performance-optimization/34-CONTEXT.md
@.planning/phases/34-performance-optimization/34-RESEARCH.md
@src/lib/db.ts
@src/lib/duckdb-aggregator.ts
</context>

<tasks>

<task type="auto">
<parameter name>Task 1: Add sorted table creation to DuckDB setup</name>
  <files>src/lib/db.ts</files>
  <action>
Update src/lib/db.ts to add:

1. addDataPath function (exists, verify it's correct)
2. Create ensureSortedCrimesTable() function:
   - Checks if 'crimes_sorted' table exists
   - If not, creates it with: CREATE TABLE crimes_sorted AS SELECT * FROM read_csv_auto(dataPath) ORDER BY "Date"
   - This creates a sorted copy for zone map optimization
   - Use IF NOT EXISTS to avoid errors on subsequent calls
   - Returns the table name 'crimes_sorted' for queries

IMPORTANT: The sorting is critical for zone map optimization - DuckDB can skip irrelevant row groups when querying date ranges.

Add error handling - if table creation fails, log error and return original table name.
  </action>
  <verify>
- ensureSortedCrimesTable function is exported
- Function checks for existing table before creating
- Sorting by "Date" column enables zone map optimization
- No runtime errors when called
  </verify>
  <done>
Sorted crimes table created for zone map optimization
  </done>
</task>

<task type="auto">
<name>Task 2: Create optimized query functions</name>
  <files>src/lib/queries.ts</files>
  <action>
Create src/lib/queries.ts with optimized query functions:

1. queryCrimesInRange(startEpoch, endEpoch, options?):
   - Takes start/end epoch seconds
   - Uses crimes_sorted table (zone-map optimized)
   - Accepts LIMIT for pagination (default: 50000)
   - Accepts crimeTypes and districts filters
   - Returns: { timestamp, type, lat, lon, x, z, iucr, district, year }[]
   - Uses parameterized queries to prevent injection

2. queryCrimeCount(startEpoch, endEpoch, filters?):
   - Returns COUNT(*) for given range
   - Used for density calculation
   - Much faster than fetching all records

3. queryDensityBins(startEpoch, endEpoch, resX, resY, resZ):
   - Pre-computes aggregation at query time
   - Returns binned counts for visualization
   - Uses crimes_sorted table

Each function should:
- Call ensureSortedCrimesTable() first
- Use the sorted table for queries
- Handle errors gracefully with try/catch
  </action>
  <verify>
- All three query functions are exported
- Functions use parameterized queries
- Functions use crimes_sorted table
- No TypeScript compilation errors
  </verify>
  <done>
Optimized query functions created for viewport-based data access
  </done>
</task>

</tasks>

<verification>
- ensureSortedCrimesTable creates/populates sorted table
- Query functions use the sorted table
- Time-range queries should be faster due to zone map pruning
</verification>

<success_criteria>
- Sorted table enables zone map optimization
- Queries accept epoch ranges and filters
- Pre-computed aggregations available for density
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-optimization/34-02-SUMMARY.md`
</output>
