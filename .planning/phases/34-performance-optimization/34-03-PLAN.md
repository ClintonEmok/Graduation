---
phase: 34-performance-optimization
plan: 03
type: execute
wave: 2
depends_on:
  - 34-02
files_modified:
  - src/app/api/crimes/range/route.ts
autonomous: true

must_haves:
  truths:
    - "API accepts viewport bounds and returns only relevant data"
    - "Buffer zones load data before/after visible range"
    - "Query uses sorted table for zone map optimization"
  artifacts:
    - path: "src/app/api/crimes/range/route.ts"
      provides: "API endpoint for viewport-based crime data fetching"
      exports: ["GET", "query parameters: startEpoch, endEpoch, bufferDays, limit"]
  key_links:
    - from: "src/app/api/crimes/range/route.ts"
      to: "src/lib/queries.ts"
      via: "imports queryCrimesInRange"
      pattern: "queryCrimesInRange.*startEpoch"
---

<objective>
Create API endpoint for viewport-based crime data fetching.

Purpose: Provide an endpoint that accepts viewport bounds and returns only the data needed for the current view + buffer zones.
Output: Working /api/crimes/range endpoint that uses optimized queries.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-performance-optimization/34-CONTEXT.md
@.planning/phases/34-performance-optimization/34-RESEARCH.md
@src/lib/queries.ts
@src/app/api/crime/stream/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /api/crimes/range endpoint</name>
  <files>src/app/api/crimes/range/route.ts</files>
  <action>
Create src/app/api/crimes/range/route.ts:

1. Export const runtime = 'nodejs' (for DuckDB)
2. Export const dynamic = 'force-dynamic'

3. GET handler accepts query parameters:
   - startEpoch: number (required) - start of visible range
   - endEpoch: number (required) - end of visible range
   - bufferDays: number (optional, default: 30) - buffer before/after
   - limit: number (optional, default: 50000) - max records
   - crimeTypes: string (optional) - comma-separated
   - districts: string (optional) - comma-separated

4. Apply buffer:
   - Convert bufferDays to seconds (bufferDays * 86400)
   - Subtract buffer from startEpoch
   - Add buffer to endEpoch

5. Call queryCrimesInRange from queries.ts:
   - Pass adjusted start/end epochs
   - Pass limit and filters

6. Return response:
   - status: 200
   - Content-Type: application/json
   - Cache-Control: no-store (viewport data should never be cached long-term)

7. Error handling:
   - Try/catch with error logging
   - Return 500 on failure with error message

Verify src/app/api/crimes directory exists, create if needed.
  </action>
  <verify>
- Endpoint accepts GET with query parameters
- Buffer logic correctly expands viewport range
- Returns JSON with crime records
- Error handling returns proper status codes
  </verify>
  <done>
API endpoint created for viewport-based crime data fetching
  </done>
</task>

</tasks>

<verification>
- Endpoint compiles and runs
- Buffer zones expand the query range
- Uses optimized queries from Plan 34-02
</verification>

<success_criteria>
- API returns data only for viewport + buffer
- Endpoint handles errors gracefully
- Query uses sorted table for performance
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-optimization/34-03-SUMMARY.md`
</output>
