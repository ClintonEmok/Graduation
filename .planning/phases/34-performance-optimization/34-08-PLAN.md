---
phase: 34-performance-optimization
plan: 08
type: execute
wave: 3
depends_on:
  - 34-06
files_modified:
  - src/components/map/MapVisualization.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "2D map displays crime points from useCrimeData"
    - "Points update when viewport changes"
    - "No direct DataStore dependency for crime data"
  artifacts:
    - path: "src/components/map/MapVisualization.tsx"
      provides: "2D map using unified useCrimeData hook"
  key_links:
    - from: "src/components/map/MapVisualization.tsx"
      to: "src/hooks/useCrimeData.ts"
      via: "imports and uses useCrimeData hook"
---

<objective>
Update MapVisualization (2D map) to use unified useCrimeData hook.

Purpose: Connect 2D map visualization to viewport-based data layer.
Output: MapVisualization consumes useCrimeData instead of DataStore.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
**Depends on:** 34-06 (canonical types and useCrimeData hook)

**Gap closure reason:** MapVisualization currently gets data from DataStore, not viewport-based. Needs to use useCrimeData hook.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MapVisualization to use useCrimeData</name>
  <files>src/components/map/MapVisualization.tsx</files>
  <action>
Update src/components/map/MapVisualization.tsx:

1. Remove import of data from useDataStore (for crime data)
2. Import useCrimeData from @/hooks/useCrimeData
3. Import CrimeRecord from @/types/crime

4. Replace data source:
```typescript
// Before: const data = useDataStore((state) => state.data);

// After: 
const { data: crimeRecords, isLoading } = useCrimeData({
  startEpoch: viewportStart,
  endEpoch: viewportEnd,
});

const data = crimeRecords || [];
```

5. Handle canonical CrimeRecord format:
   - Use record.lat, record.lon for map coordinates
   - Use record.type for color markers
   - Use record.timestamp for time filtering if needed

6. Keep existing:
   - Map rendering (Leaflet/basemap)
   - Marker clustering if implemented
   - Popup details
   - Filter controls

7. Handle loading state appropriately
</action>
<verify>
- MapVisualization uses useCrimeData hook
- Map shows points from viewport-based data
- TypeScript compiles without errors
- No runtime errors from field mismatches
  </verify>
  <done>
MapVisualization updated to use unified useCrimeData hook
  </done>
</task>

</tasks>

<verification>
- 2D map shows points from useCrimeData
- Points update when viewport changes
- No DataStore dependency for crime data
</verification>

<success_criteria>
- 2D visualization connected to viewport-based data
- Single source of truth for crime data
</success_criteria>

<output>
After completion, create `.planning/phases/34-performance-optimization/34-08-SUMMARY.md`
</output>
