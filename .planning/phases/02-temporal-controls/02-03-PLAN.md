---
phase: 02-temporal-controls
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - src/components/ui/TimeControls.tsx
  - src/components/viz/TimeLoop.tsx
  - src/components/viz/Scene.tsx
  - src/app/page.tsx
autonomous: true
must_haves:
  truths:
    - "Clicking Play moves the 3D plane"
    - "Slider scrub updates the 3D plane position"
    - "Step forward/backward buttons increment/decrement time"
    - "Points dim when outside the time plane range"
    - "UI displays current time"
  artifacts:
    - path: "src/components/ui/TimeControls.tsx"
      provides: "User interface"
    - path: "src/components/viz/TimeLoop.tsx"
      provides: "Animation logic"
  key_links:
    - from: "TimeControls"
      to: "useTimeStore"
      via: "actions"
    - from: "TimeLoop"
      to: "DataPoints"
      via: "material.uniforms.uTimePlane"
---

<objective>
Wire up the user interface and the animation loop to control the 3D visualization.

Purpose: Connect the store, the UI, and the 3D visuals into a working temporal system.
Output: Working TimeControls UI and TimeLoop logic integrated into the main scene.
</objective>

<context>
@.planning/phases/02-temporal-controls/02-01-SUMMARY.md
@.planning/phases/02-temporal-controls/02-02-SUMMARY.md
@src/components/viz/Scene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeControls UI</name>
  <files>src/components/ui/TimeControls.tsx</files>
  <action>
    Create a component that renders the bottom control bar.
    - Use `useTimeStore` to get state (`currentTime`, `isPlaying`, `speed`, `timeWindow`) and actions.
    - Render a Play/Pause button (using lucide-react icons).
    - Render Step Forward and Step Backward buttons (using `stepTime` action or `setTime` with `step` constant).
    - Render a Slider (shadcn) bound to `currentTime`.
    - Render a secondary Slider or Input bound to `timeWindow` to control the visual thickness/range.
    - Render a text display of `currentTime` (formatted).
    - Render a speed/step selector.
    - Style as a fixed bottom bar (z-index high).
  </action>
  <verify>grep "useTimeStore" src/components/ui/TimeControls.tsx</verify>
  <done>UI component complete</done>
</task>

<task type="auto">
  <name>Task 2: Create TimeLoop Logic</name>
  <files>src/components/viz/TimeLoop.tsx</files>
  <action>
    Create a component `TimeLoop` that accepts refs to `pointsRef` and `planeRef`.
    - Use `useFrame` to run every frame.
    - Access store state via `useTimeStore.getState()` (transient updates).
    - If `isPlaying`, increment time and call `actions.setTime`.
    - Update `planeRef.current.position.y` to match time.
    - Update `pointsRef.current.material.userData.shader.uniforms.uTimePlane.value` to match time.
    - Update `pointsRef.current.material.userData.shader.uniforms.uRange.value` to match `timeWindow` (passed from store).
    - Handle edge cases (looping at max time).
  </action>
  <verify>grep "useFrame" src/components/viz/TimeLoop.tsx</verify>
  <done>Animation loop logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Scene</name>
  <files>src/components/viz/Scene.tsx, src/app/page.tsx</files>
  <action>
    1. Update `Scene.tsx`:
       - Import `TimePlane`, `TimeLoop`.
       - Create refs: `const pointsRef = useRef()`, `const planeRef = useRef()`.
       - Pass `pointsRef` to `<DataPoints>`.
       - Render `<TimePlane ref={planeRef} />`.
       - Render `<TimeLoop pointsRef={pointsRef} planeRef={planeRef} />`.
    2. Update `src/app/page.tsx` (or layout):
       - Add `<TimeControls />` outside the Canvas.
  </action>
  <verify>grep "TimeLoop" src/components/viz/Scene.tsx</verify>
  <done>All components wired together</done>
</task>

</tasks>

<verification>
Load the app.
Click play -> Plane moves, points highlight.
Drag slider -> Plane moves, points highlight.
Click step buttons -> Time increments/decrements.
Adjust Range/Window slider -> Highlighted band gets thicker/thinner.
</verification>

<success_criteria>
- Animation plays smoothly
- Slider controls time
- Step buttons allow fine control
- Range/Window slider controls highlight thickness
- Visual feedback is synchronized
</success_criteria>

<output>
After completion, create `.planning/phases/02-temporal-controls/02-03-SUMMARY.md`
</output>
