---
phase: 25-adaptive-intervals-burstiness
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - src/components/viz/SpaceTimeCube.tsx
  - src/components/timeline/DualTimeline.tsx
  - src/components/viz/Grid.tsx
  - src/components/ui/TimeControls.tsx
autonomous: true
must_haves:
  truths:
    - "Timeline histogram bins adjust to screen pixel density"
    - "3D points expand/contract smoothly as warp factor changes"
    - "Timeline X-axis matches 3D Z-axis perfectly during blend"
    - "Warp slider located in Timeline Header replaces binary toggle"
  artifacts:
    - path: src/components/timeline/DualTimeline.tsx
      contains: "thresholds(width"
    - path: src/components/ui/TimeControls.tsx
      contains: "setWarpFactor"
  key_links:
    - from: src/hooks/useTimeWarp.ts
      to: src/components/timeline/DualTimeline.tsx
      via: "toAdaptive projection"
---

<objective>
Wire the adaptive blending logic into the visualization components.
Purpose: Allow users to interactively blend between Uniform (Linear) and Adaptive (CDF) time to "feel" the data density.
Output: Integrated adaptive view with slider control.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/25-adaptive-intervals-burstiness/25-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Warp Slider to Timeline Header</name>
  <files>src/components/ui/TimeControls.tsx</files>
  <action>
    Modify `TimeControls.tsx`.
    1. Import `useCoordinationStore` to access `warpFactor` and `setWarpFactor`.
    2. Replace the existing "Time Scale" toggle button with a slider:
       - Label: "Adaptive Warp" (or icon).
       - Range: 0 to 1.
       - Step: 0.01.
    3. **Implement Animation:**
       - Clicking the "Adaptive" label or icon should trigger a smooth transition to 1 (over ~300ms).
       - Clicking "Linear" should transition to 0.
       - Use a `requestAnimationFrame` loop or similar lightweight tween to update `setWarpFactor` incrementally.
       - Manual dragging of the slider overrides/stops any active animation.
    4. Ensure the slider fits within the layout (Option A from decision).
  </action>
  <verify>
    - Sliding updates store state smoothly.
    - Clicking labels triggers smooth animation.
  </verify>
  <done>
    User can blend between linear and adaptive time via Timeline Header (manual or animated).
  </done>
</task>

<task type="auto">
  <name>Task 2: Warp the Space-Time Cube (GPU Accelerated)</name>
  <files>src/components/viz/DataPoints.tsx, src/components/viz/Grid.tsx</files>
  <action>
    1. In `DataPoints.tsx`, import `useTimeWarp` (or use the KDE utility directly) to compute `adaptiveYValues`.
       - This replaces the old `computeAdaptiveYColumnar` logic.
       - The `adaptiveYValues` array should represent the "Fully Adaptive" (warpFactor=1) state.
    2. Pass `adaptiveYValues` to the `attributes-adaptiveY` buffer.
    3. Bind `coordinationStore.warpFactor` to the shader's uniform (currently `uTransition`, rename to `uWarpFactor` if preferred).
       - This enables 60FPS interpolation on the GPU without CPU re-renders.
    4. Update `Grid.tsx` (Z-axis):
       - Position ticks at visual intervals (0, 10, 20... 100).
       - Label ticks using `toLinear(z)` formatted as time.
       - This stays on CPU (React render) but is lightweight.
  </action>
  <verify>
    Drag the slider:
    - Cube geometry should smoothly stretch/compress (via Shader).
    - Grid labels should update in real-time.
  </verify>
  <done>
    3D visualization supports smooth adaptive warping via GPU.
  </done>
</task>

<task type="auto">
  <name>Task 3: Upgrade Timeline to Adaptive Density</name>
  <files>src/components/timeline/DualTimeline.tsx</files>
  <action>
    1. Integrate `useTimeWarp` into `DualTimeline.tsx`.
    2. **Binning Logic:**
       - Use "Screen Pixel Density" logic: `binCount = Math.floor(width / 4)`.
    3. **Coordinate System:**
       - Use `toAdaptive(timestamp)` to map events to the X-axis.
       - The X-axis must match the Cube's Z-axis (0-100 normalized adaptive time).
     4. **Axis Labels:**
        - Draw ticks at visual intervals (Option A: Fixed screen positions, varying time values).
        - Label using `toLinear(x)` to show real time.
    5. **Responsiveness:**
       - Ensure the timeline redraws efficiently during slider drag.
  </action>
  <verify>
    - Timeline bars shift and resize smoothly when slider is dragged.
    - Alignment with 3D view is maintained at all blend factors (0, 0.5, 1).
  </verify>
  <done>
    Timeline fully supports linear blending strategy.
  </done>
</task>

</tasks>

<verification>
Ensure visual alignment between Timeline X-axis and Cube Z-axis. A selected range on the timeline should correspond exactly to the vertical slice in the cube, regardless of warp factor.
</verification>

<success_criteria>
- [ ] Timeline uses dynamic bin count.
- [ ] Slider smoothly interpolates between Linear (0) and Adaptive (1).
- [ ] 3D and 2D views stay synchronized during transition.
</success_criteria>

<output>
After completion, create `.planning/phases/25-adaptive-intervals-burstiness/25-02-SUMMARY.md`
</output>
